<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Conference Buddy – Sessions</title>

  <!--
    UI-only refresh
    - Keeps existing element IDs & workflow intact
    - Mobile-first layout, large touch targets
    - No functional logic changes; your existing JS should bind as before
  -->

  <style>
    :root{
      --bg:#0b0f14;
      --card:#121821;
      --muted:#1a2431;
      --text:#e6edf3;
      --text-dim:#9fb0c3;
      --primary:#3ea6ff;
      --accent:#7ef0d7;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --ok:#7CFC98;
      --radius:16px;
      --pad:14px;
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background: radial-gradient(1200px 1200px at 80% -10%, #182233 0%, var(--bg) 60%);
      color: var(--text);
      -webkit-font-smoothing:antialiased;
      line-height:1.35;
    }
    /* Layout */
    .wrap{
      max-width:900px;
      margin:0 auto;
      padding: env(safe-area-inset-top) 16px calc(32px + env(safe-area-inset-bottom));
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      position:sticky;top:0;background:linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.6) 60%, transparent);
      backdrop-filter: blur(6px);
      padding:8px 0; z-index:50;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 24px var(--accent)}
    h1{font-size:18px;margin:0;font-weight:650;letter-spacing:.2px}
    .btn{
      appearance:none;border:0;border-radius:12px;background:var(--muted);color:var(--text);
      padding:10px 14px;font-weight:600;font-size:14px;line-height:1.1;cursor:pointer;
      transition:all .2s ease; display:inline-flex;align-items:center;gap:8px
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.primary{background:linear-gradient(180deg, #298DFF, #1671d8); box-shadow:0 8px 20px rgba(46,141,255,.25)}
    .btn.ghost{background:transparent;outline:1px solid #273142}
    .btn.warn{background:linear-gradient(180deg,#ffb84d,#ff9f1a)}
    .btn.danger{background:linear-gradient(180deg,#ff6b6b,#e65050)}
    .btn.flat{background:transparent;color:var(--text-dim);padding:8px}
    .btn.block{width:100%;justify-content:center}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grow{flex:1 1 auto}

    /* Cards */
    .card{
      background:linear-gradient(180deg, rgba(26,36,49,.7), rgba(18,24,33,.9));
      border:1px solid #1f2a3a; border-radius:var(--radius);
      padding:var(--pad); box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{margin:2px 0 10px;font-size:15px;color:#d9e6f2;letter-spacing:.3px}
    .card .sub{font-size:12px;color:var(--text-dim);margin-top:-2px}

    /* Inputs */
    label{font-size:12px;color:var(--text-dim);margin-bottom:6px;display:block}
    select,input[type="text"],input[type="datetime-local"],textarea{
      width:100%;background:#0f141c;border:1px solid #223049;color:var(--text);
      border-radius:12px;padding:12px 12px;font-size:15px;outline:none;
    }
    textarea{min-height:140px;resize:vertical}
    input[type="file"]{width:100%;font-size:14px;color:var(--text-dim)}

    /* Settings Drawer */
    details.settings{
      border-radius:var(--radius);
      overflow:hidden;border:1px solid #1f2a3a
    }
    details.settings summary{
      list-style:none;cursor:pointer;padding:12px 14px;background:#111826;font-weight:700;
      display:flex;align-items:center;justify-content:space-between
    }
    details.settings[open] summary{border-bottom:1px solid #1f2a3a}
    .settings-body{padding:12px;background:#0c131d}
    .hint{font-size:12px;color:var(--text-dim)}

    /* Recorder */
    .recorder{
      display:grid;gap:10px;
      grid-template-columns: 1fr; 
    }
    .record-bar{
      display:flex;gap:8px;align-items:center;justify-content:space-between;background:#0f1622;
      border:1px solid #1f2a3a;border-radius:14px;padding:8px 10px
    }
    .pill{font-size:12px;color:#cfe2ff;background:#143055;border:1px solid #254a7a;border-radius:999px;padding:6px 10px}
    .rec-led{width:10px;height:10px;border-radius:50%;background:#666}
    .rec-led.active{background:#ff4d4d;box-shadow:0 0 0 6px rgba(255,77,77,.15)}
    .timer{font-variant-numeric:tabular-nums;font-weight:700}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{font-size:11px;color:var(--text-dim);border:1px dashed #2b3850;border-radius:999px;padding:4px 8px}

    /* Photo grid */
    .thumbs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .thumb{position:relative;border-radius:10px;overflow:hidden;border:1px solid #223049;background:#0f141c}
    .thumb img{width:100%;height:70px;object-fit:cover;display:block}
    .thumb .x{position:absolute;top:4px;right:4px;background:rgba(0,0,0,.5);border:0;color:#fff;border-radius:8px;padding:4px 6px;cursor:pointer}

    /* Sessions */
    .session{border:1px solid #21304a;border-radius:12px;padding:10px;margin:8px 0;background:#0f141c}
    .session .meta{font-size:12px;color:var(--text-dim)}
    .status{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #2c3b55;color:#cfe2ff}

    /* Logs Drawer */
    dialog#logsDialog{
      border:1px solid #1f2a3a;background:#0b111a;color:var(--text);
      border-radius:16px;max-width:900px;width:96vw;padding:0;
    }
    .logs-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #1f2a3a;background:#0e1622}
    .logs-body{padding:10px}
    .tabrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    #logsText{
      width:100%;min-height:40vh;background:#09111b;border:1px solid #1a2636;border-radius:12px;
      padding:12px;color:#cde0f6;font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px;white-space:pre-wrap;overflow:auto;
    }

    /* Footer spacing for bottom sessions list */
    .spacer{height:8px}

    /* Mobile tweaks */
    @media (pointer:coarse){
      .btn{padding:12px 16px;font-size:16px;border-radius:14px}
      select, input, textarea{font-size:16px}
      .thumb img{height:72px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <span class="dot"></span>
        <h1>Conference Buddy — Session Recorder</h1>
      </div>
      <div class="row">
        <button id="openLogsBtn" class="btn ghost" type="button">Logs</button>
      </div>
    </header>

    <!-- SETTINGS (save once) -->
    <details class="settings" id="settingsPanel">
      <summary>
        <span>Settings (save once)</span>
        <span class="hint">API details are persisted</span>
      </summary>
      <div class="settings-body">
        <div class="row">
          <div class="grow">
            <label for="baseUrlInput">API Base URL</label>
            <input id="baseUrlInput" type="text" placeholder="https://conference-buddy-geoutils.replit.app" />
          </div>
        </div>
        <div class="row">
          <div class="grow">
            <label for="apiKeyInput">X-API-Key</label>
            <input id="apiKeyInput" type="text" placeholder="••••••" />
          </div>
        </div>
        <div class="row">
          <button id="saveConfigBtn" class="btn primary" type="button">Save Configuration</button>
          <button id="clearConfigBtn" class="btn flat" type="button" title="Clears local cache only">Clear</button>
        </div>
        <div class="hint" id="configStatus">Not saved</div>
      </div>
    </details>

    <!-- RECORD -->
    <section class="card" id="recordCard">
      <h2>Record Session</h2>
      <div class="sub">Order: Create session → Add files → Check progress (unchanged)</div>

      <!-- Conference/Vendor -->
      <div class="row">
        <div class="grow">
          <label for="conferenceSelect">Conference</label>
          <div class="row">
            <select id="conferenceSelect" class="grow"></select>
            <button id="addConferenceBtn" class="btn" type="button">Add</button>
          </div>
        </div>
        <div class="grow">
          <label for="vendorSelect">Vendor</label>
          <div class="row">
            <select id="vendorSelect" class="grow"></select>
            <button id="addVendorBtn" class="btn" type="button">Add</button>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div>
        <label for="notesInput">Notes</label>
        <textarea id="notesInput" placeholder="Type quick notes during the chat…"></textarea>
      </div>

      <!-- Photos (multi) -->
      <div>
        <label for="photoInput">Photos</label>
        <input id="photoInput" type="file" accept="image/*" multiple capture="environment" />
        <div id="photoThumbs" class="thumbs" aria-live="polite"></div>
      </div>

      <!-- Audio: inline recorder & picker -->
      <div class="recorder" id="recorderUI">
        <div class="record-bar">
          <div class="row">
            <span class="rec-led" id="recLed" aria-hidden="true"></span>
            <span class="pill" id="audioMime">Audio format: <span id="audioFormat">—</span></span>
          </div>
          <div class="chips">
            <span class="chip">Tap Start → Stop → Upload</span>
          </div>
        </div>

        <div class="row">
          <button id="startRecBtn" class="btn primary grow" type="button">Start</button>
          <button id="stopRecBtn" class="btn warn grow" type="button" disabled>Stop</button>
        </div>
        <div class="row">
          <input id="audioFileInput" type="file" accept="audio/webm,audio/m4a,audio/aac,audio/ogg,audio/mp4,audio/mpeg,audio/wav" />
          <button id="clearAudioBtn" type="button" class="btn flat">Clear Audio</button>
        </div>
        <div class="row">
          <div class="grow">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="pill">Timer: <span id="recTimer" class="timer">00:00</span></div>
              <audio id="playback" controls style="width:170px;max-width:45vw"></audio>
            </div>
          </div>
        </div>
        <div class="row">
          <button id="createSessionBtn" class="btn ghost grow" type="button">Create Session</button>
          <button id="uploadBtn" class="btn primary grow" type="button" disabled>Upload Files</button>
        </div>
        <div class="row">
          <button id="checkProgressBtn" class="btn ghost grow" type="button">Check Progress</button>
          <button id="endSessionBtn" class="btn danger grow" type="button">End & Clear</button>
        </div>
      </div>

      <div class="hint" id="statusHint">idle</div>
    </section>

    <!-- PREVIOUS SESSIONS -->
    <section class="card" id="sessionsCard">
      <h2>Previous Sessions</h2>
      <div class="row" style="justify-content:flex-end">
        <button id="refreshSessionsBtn" class="btn ghost" type="button">Refresh</button>
      </div>
      <div id="sessionsList">
        <!-- Existing JS will render items; keep .session structure -->
      </div>
    </section>

    <div class="spacer"></div>
  </div>

  <!-- LOGS DIALOG -->
  <dialog id="logsDialog">
    <div class="logs-head">
      <strong>Diagnostics & Logs</strong>
      <div class="tabrow">
        <label for="logVerbosity" class="hint">Verbosity</label>
        <select id="logVerbosity">
          <option value="simple">Simple</option>
          <option value="verbose" selected>Verbose</option>
          <option value="clear">Clear</option>
        </select>
        <button id="exportLogsBtn" class="btn" type="button">Export</button>
        <button id="closeLogsBtn" class="btn flat" type="button">Close</button>
      </div>
    </div>
    <div class="logs-body">
      <textarea id="logsText" spellcheck="false"></textarea>
    </div>
  </dialog>

  <!--
    Binding-only helpers for the new UI elements.
    These DO NOT change your logic; they just wire the new controls
    to your existing functions/handlers if present.
  -->
  <script>
    // Open/close logs
    (function(){
      const dlg = document.getElementById('logsDialog');
      const openBtn = document.getElementById('openLogsBtn');
      const closeBtn = document.getElementById('closeLogsBtn');
      if(openBtn && dlg){ openBtn.addEventListener('click', ()=> dlg.showModal()); }
      if(closeBtn && dlg){ closeBtn.addEventListener('click', ()=> dlg.close()); }
      // Verbosity select → call existing setLogVerbosity if you have one
      const sel = document.getElementById('logVerbosity');
      if(sel && typeof window.setLogVerbosity === 'function'){
        sel.addEventListener('change', e => window.setLogVerbosity(e.target.value));
      }
      // Export logs → call existing export handler if present
      const exportBtn = document.getElementById('exportLogsBtn');
      if(exportBtn){
        exportBtn.addEventListener('click', ()=>{
          if (typeof window.exportLogs === 'function') return window.exportLogs();
          // fallback lightweight export of #logsText
          const blob = new Blob([document.getElementById('logsText').value || ''], {type:'text/plain'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'logs.txt';
          a.click();
          URL.revokeObjectURL(a.href);
        });
      }
    })();

    // Settings save/clear keep your existing handlers if defined
    (function(){
      const saveBtn = document.getElementById('saveConfigBtn');
      const clearBtn = document.getElementById('clearConfigBtn');
      const base = document.getElementById('baseUrlInput');
      const key = document.getElementById('apiKeyInput');
      const status = document.getElementById('configStatus');

      if (typeof window.loadConfigIntoUI === 'function') {
        // If your app has a loader, let it populate these fields
        window.loadConfigIntoUI({baseEl: base, keyEl: key, statusEl: status});
      }
      if (saveBtn){
        saveBtn.addEventListener('click', ()=>{
          if (typeof window.saveConfig === 'function') { window.saveConfig(); return; }
          // fallback: emit custom event so your existing code can intercept
          document.dispatchEvent(new CustomEvent('config:save', {
            detail: { baseUrl: base.value.trim(), apiKey: key.value.trim() }
          }));
          status.textContent = 'Saved (pending app handler)';
        });
      }
      if (clearBtn){
        clearBtn.addEventListener('click', ()=>{
          base.value = ''; key.value = '';
          if (typeof window.clearConfig === 'function') window.clearConfig();
          status.textContent = 'Cleared (local only)';
        });
      }
    })();

    // Photo preview grid – UI only, keeps #photoInput as your code expects
    (function(){
      const input = document.getElementById('photoInput');
      const grid = document.getElementById('photoThumbs');
      if(!input || !grid) return;

      function render(files){
        grid.innerHTML = '';
        [...files].forEach((f, idx)=>{
          const url = URL.createObjectURL(f);
          const tile = document.createElement('div');
          tile.className = 'thumb';
          tile.innerHTML = `<img alt=""> <button class="x" type="button" aria-label="Remove">✕</button>`;
          tile.querySelector('img').src = url;
          tile.querySelector('.x').addEventListener('click', ()=>{
            // Remove from FileList (UI only) – we rebuild DataTransfer for UI parity
            const dt = new DataTransfer();
            [...input.files].forEach((ff,i)=>{ if(i!==idx) dt.items.add(ff); });
            input.files = dt.files;
            render(input.files);
          });
          grid.appendChild(tile);
        });
      }
      input.addEventListener('change', ()=> render(input.files));
    })();

    // Recorder UI-only wiring:
    (function(){
      const led = document.getElementById('recLed');
      const startBtn = document.getElementById('startRecBtn');
      const stopBtn = document.getElementById('stopRecBtn');
      const timerEl = document.getElementById('recTimer');
      const playback = document.getElementById('playback');
      const filePicker = document.getElementById('audioFileInput');
      const fmt = document.getElementById('audioFormat');
      const clearBtn = document.getElementById('clearAudioBtn');

      // If your app exposes recorder controls, bind to those.
      if (typeof window.recorderStart === 'function') {
        startBtn.addEventListener('click', ()=> window.recorderStart());
        stopBtn.addEventListener('click', ()=> window.recorderStop());
      } else {
        // Minimal inline UX shim that does NOT replace your logic; just visuals
        let ticking, sec = 0;
        startBtn.addEventListener('click', ()=>{
          led.classList.add('active');
          startBtn.disabled = true; stopBtn.disabled = false;
          sec = 0; timerEl.textContent = '00:00';
          clearInterval(ticking);
          ticking = setInterval(()=>{ sec++; const m=String(Math.floor(sec/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); timerEl.textContent=`${m}:${s}`; },1000);
        });
        stopBtn.addEventListener('click', ()=>{
          led.classList.remove('active');
          startBtn.disabled = false; stopBtn.disabled = true;
          clearInterval(ticking);
        });
      }

      // Reflect chosen/recorded audio in the small inline player
      document.addEventListener('audio:blob', (e)=>{
        // Your existing logic can dispatch this with { blob, mime }
        const { blob, mime } = e.detail || {};
        if (blob){
          playback.src = URL.createObjectURL(blob);
          playback.load();
          fmt.textContent = mime || blob.type || 'n/a';
        }
      });

      filePicker.addEventListener('change', ()=>{
        const f = filePicker.files && filePicker.files[0];
        if (!f) return;
        fmt.textContent = f.type || 'n/a';
        playback.src = URL.createObjectURL(f);
        playback.load();
        // Let your existing logic know a manual file was chosen
        document.dispatchEvent(new CustomEvent('audio:file', { detail: { file: f } }));
      });

      clearBtn.addEventListener('click', ()=>{
        playback.removeAttribute('src'); playback.load();
        filePicker.value = '';
        fmt.textContent = '—';
        document.dispatchEvent(new Event('audio:clear'));
      });
    })();

    // Buttons that should already exist in your logic — no behavior changes
    (function(){
      const qs = (id)=>document.getElementById(id);
      const map = {
        createSessionBtn: 'handleCreateSession',
        uploadBtn:        'handleUploadFiles',
        checkProgressBtn: 'handleCheckProgress',
        endSessionBtn:    'handleEndSession',
        refreshSessionsBtn: 'handleRefreshSessions',
        addConferenceBtn: 'handleAddConference',
        addVendorBtn:     'handleAddVendor',
      };
      for (const [id, fn] of Object.entries(map)){
        const el = qs(id);
        if (!el) continue;
        el.addEventListener('click', ()=>{
          if (typeof window[fn] === 'function') window[fn]();
          else document.dispatchEvent(new CustomEvent(`ui:${fn}`));
        });
      }
    })();

    // Keep status text & small conveniences for your logger if present
    (function(){
      const hint = document.getElementById('statusHint');
      const fmt  = document.getElementById('audioFormat');
      if (typeof window.setStatusText === 'function'){
        window.addEventListener('status:update', (e)=> window.setStatusText(e.detail || ''));
      } else {
        document.addEventListener('status:update', (e)=> { hint.textContent = e.detail || ''; });
      }
      // When your code detects audio mime, it can set this:
      document.addEventListener('audio:mime', (e)=>{ fmt.textContent = e.detail || fmt.textContent; });
    })();
  </script>

  <!-- Your existing app bundle should still be included exactly as before.
       If you previously inlined it, keep it. Example (commented):
  <script src="./app.js"></script>
  -->
</body>
</html>
