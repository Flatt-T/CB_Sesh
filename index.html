<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Conference Buddy â€” Session Recorder</title>
  <style>
    :root{
      --bg:#0b1220;        /* deep blue */
      --bg2:#0f1a33;       /* slightly lighter */
      --fg:#e6eefc;        /* off-white */
      --muted:#9bb3e0;     /* muted text */
      --accent:#3b82f6;    /* blue accent */
      --accent-2:#60a5fa;
      --danger:#ef4444;
      --ok:#10b981;
      --card:#0d1426;
      --border:#1f2a44;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,var(--bg),#0a1020 40%, #081025);
      color:var(--fg);
    }
    a{color:var(--accent)}
    .app{
      max-width:1100px;
      margin:0 auto;
      padding:16px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
    }
    header{
      grid-column:1 / -1;
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 16px;margin-bottom:4px;
      background:var(--card);border:1px solid var(--border);border-radius:14px;
    }
    .badge{padding:4px 10px;border-radius:999px;background:#0b1a3a;border:1px solid var(--border);color:var(--muted);font-size:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pane{
      background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;
    }
    .pane h2,.pane h3{margin:.2rem 0 10px;font-size:16px;color:#d7e5ff}
    label{font-size:12px;color:var(--muted);display:block;margin:6px 0 6px}
    input,select,textarea,button{
      width:100%;padding:10px 12px;border-radius:10px;
      border:1px solid var(--border);background:var(--bg2);color:var(--fg);
      outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));border:none;color:white;font-weight:600}
    button.ghost{background:transparent;border:1px solid var(--border)}
    button.danger{background:var(--danger);border:none}
    button:disabled{opacity:.6;cursor:not-allowed}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .preview{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .chip{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;color:var(--muted)}
    .status{
      white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      background:#0b152c;border:1px solid var(--border);border-radius:10px;padding:10px;max-height:200px;overflow:auto
    }
    .list{display:grid;gap:8px;margin-top:8px}
    .item{
      padding:10px;border:1px solid var(--border);border-radius:12px;background:#0c152b;
      display:grid;gap:6px
    }
    .kv{display:flex;gap:6px;flex-wrap:wrap}
    .kv span{font-size:12px;color:var(--muted)}
    dialog{
      border:none;border-radius:16px;padding:0;background:transparent;color:inherit;
    }
    .modal{
      background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;min-width:60vw;max-height:80vh;overflow:auto;
      box-shadow:0 20px 50px rgba(0,0,0,.6)
    }
    .right-actions{display:flex; gap:8px; justify-content:flex-end}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;background:#0d2048;border:1px solid var(--border);border-radius:999px;color:#bcd1ff;font-size:12px}
    .muted{color:var(--muted)}
    .thumb{width:84px;height:84px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="row">
        <strong>Conference Buddy Â· Session Recorder</strong>
        <span class="badge">Dark/Blue Â· Minimal</span>
      </div>
      <div class="row">
        <span id="apiStatus" class="chip">Disconnected</span>
        <button id="btnOpenAuth" class="ghost">Login / API Settings</button>
      </div>
    </header>

    <!-- LEFT: session controls -->
    <section class="pane">
      <h2>New Session</h2>

      <div class="grid-2">
        <div>
          <label for="confSelect">Conference</label>
          <div class="toolbar">
            <select id="confSelect" aria-label="Select conference"></select>
            <button id="btnAddConf" class="ghost" title="Quick add conference">+ New</button>
          </div>
        </div>
        <div>
          <label for="vendorSelect">Vendor</label>
          <div class="toolbar">
            <select id="vendorSelect" aria-label="Select vendor"></select>
            <button id="btnAddVendor" class="ghost" title="Quick add vendor">+ New</button>
          </div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:8px">
        <div>
          <label>Images (you can take photos)</label>
          <input id="imageInput" type="file" accept="image/*" capture="environment" multiple />
          <div id="imagePreview" class="preview" aria-live="polite"></div>
        </div>
        <div>
          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Type quick notes hereâ€¦"></textarea>
        </div>
      </div>

      <div style="margin-top:10px" class="toolbar">
        <button id="btnStart" class="primary">â–¶ Start Session (records audio immediately)</button>
        <button id="btnStop" class="danger" disabled>â–  Stop & Upload</button>
        <button id="btnPrevious" class="ghost">ðŸ“œ View Previous Sessions</button>
      </div>

      <p class="muted" style="margin-top:6px">Tip: leave this tab focused while recording for best results.</p>
    </section>

    <!-- RIGHT: status / logs -->
    <section class="pane">
      <h2>Status & Logs</h2>
      <div id="status" class="status" role="status" aria-live="polite">Ready.</div>
      <div class="grid-3" style="margin-top:10px">
        <div class="pill"><span>Audio:</span><strong id="pillAudio">idle</strong></div>
        <div class="pill"><span>Images:</span><strong id="pillImages">0</strong></div>
        <div class="pill"><span>Session ID:</span><strong id="pillSession">â€”</strong></div>
      </div>
    </section>
  </div>

  <!-- Auth / Settings Modal -->
  <dialog id="authDialog">
    <div class="modal">
      <h3>API Settings</h3>
      <label>Backend API Base URL</label>
      <input id="apiUrl" placeholder="https://your-api.example.com" />
      <div class="grid-2">
        <div>
          <label>API Key</label>
          <input id="apiKey" type="password" placeholder="paste API keyâ€¦" />
        </div>
        <div>
          <label>Auth Header</label>
          <select id="authMode">
            <option value="xapikey">X-API-Key: &lt;key&gt; (default)</option>
            <option value="bearer">Authorization: Bearer &lt;key&gt;</option>
          </select>
        </div>
      </div>
      <div class="right-actions" style="margin-top:10px">
        <button id="btnTest" class="ghost">Test Connection</button>
        <button id="btnSave" class="primary">Save</button>
        <button id="btnCloseAuth" class="ghost">Close</button>
      </div>
      <p class="muted" style="margin-top:8px">Endpoints used: <code>/conferences</code>, <code>/vendors</code>, <code>/conferences/{id}/vendors</code>, <code>/sessions/upload</code>, <code>/sessions/{id}</code>, <code>/sessions/{id}/enrich</code>, <code>/vendors/{id}/sessions</code>, <code>/reports/session/{id}</code>. See Knowledge Base â†’ API Reference. </p>
    </div>
  </dialog>

  <!-- Add Conference -->
  <dialog id="confDialog">
    <div class="modal">
      <h3>New Conference</h3>
      <label>Name</label>
      <input id="newConfName" placeholder="e.g., DEF CON 33" />
      <label>Start Date (optional)</label>
      <input id="newConfDate" type="date" />
      <div class="right-actions" style="margin-top:10px">
        <button id="btnCreateConf" class="primary">Create</button>
        <button class="ghost" onclick="document.getElementById('confDialog').close()">Cancel</button>
      </div>
    </div>
  </dialog>

  <!-- Add Vendor -->
  <dialog id="vendorDialog">
    <div class="modal">
      <h3>New Vendor</h3>
      <label>Vendor Name</label>
      <input id="newVendorName" placeholder="e.g., Acme Robotics" />
      <label>Link to Conference</label>
      <select id="newVendorConf"></select>
      <div class="right-actions" style="margin-top:10px">
        <button id="btnCreateVendor" class="primary">Create</button>
        <button class="ghost" onclick="document.getElementById('vendorDialog').close()">Cancel</button>
      </div>
    </div>
  </dialog>

  <!-- Previous Sessions -->
  <dialog id="prevDialog">
    <div class="modal">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <h3>Previous Sessions</h3>
        <div class="grid-3" style="min-width:420px">
          <div>
            <label>Conference</label>
            <select id="prevConf"></select>
          </div>
          <div>
            <label>Vendor</label>
            <select id="prevVendor"></select>
          </div>
          <div style="align-self:end">
            <button id="btnLoadSessions" class="ghost">Load</button>
          </div>
        </div>
      </div>
      <div id="prevList" class="list"></div>
      <div class="right-actions" style="margin-top:10px">
        <button class="ghost" onclick="document.getElementById('prevDialog').close()">Close</button>
      </div>
    </div>
  </dialog>

  <!-- Session Detail -->
  <dialog id="detailDialog">
    <div class="modal" id="detailContainer">
      <!-- Populated dynamically -->
    </div>
  </dialog>

<script>
/**
 * Conference Buddy â€” Single-file SPA for GitHub Pages
 * ---------------------------------------------------
 * This script implements:
 *  - API settings (URL + API key), with header mode toggle (X-API-Key or Bearer)
 *  - Live dropdown population from API
 *  - Immediate audio recording on session start (MediaRecorder)
 *  - Multiple image capture/upload + previews
 *  - Notes capture
 *  - Upload to /sessions/upload then trigger /sessions/{id}/enrich
 *  - Previous sessions browser using /vendors/{id}/sessions and /reports/session/{id}
 *
 * IMPORTANT: Ensure your backend enables CORS for your Pages origin.
 */

/* ===== Utilities ===== */

const els = {
  apiStatus: document.getElementById('apiStatus'),
  btnOpenAuth: document.getElementById('btnOpenAuth'),
  authDialog: document.getElementById('authDialog'),
  apiUrl: document.getElementById('apiUrl'),
  apiKey: document.getElementById('apiKey'),
  authMode: document.getElementById('authMode'),
  btnSave: document.getElementById('btnSave'),
  btnCloseAuth: document.getElementById('btnCloseAuth'),
  btnTest: document.getElementById('btnTest'),

  confSelect: document.getElementById('confSelect'),
  vendorSelect: document.getElementById('vendorSelect'),
  btnAddConf: document.getElementById('btnAddConf'),
  btnAddVendor: document.getElementById('btnAddVendor'),

  imageInput: document.getElementById('imageInput'),
  imagePreview: document.getElementById('imagePreview'),
  notes: document.getElementById('notes'),

  btnStart: document.getElementById('btnStart'),
  btnStop: document.getElementById('btnStop'),
  btnPrevious: document.getElementById('btnPrevious'),

  status: document.getElementById('status'),
  pillAudio: document.getElementById('pillAudio'),
  pillImages: document.getElementById('pillImages'),
  pillSession: document.getElementById('pillSession'),

  confDialog: document.getElementById('confDialog'),
  newConfName: document.getElementById('newConfName'),
  newConfDate: document.getElementById('newConfDate'),
  btnCreateConf: document.getElementById('btnCreateConf'),

  vendorDialog: document.getElementById('vendorDialog'),
  newVendorName: document.getElementById('newVendorName'),
  newVendorConf: document.getElementById('newVendorConf'),
  btnCreateVendor: document.getElementById('btnCreateVendor'),

  prevDialog: document.getElementById('prevDialog'),
  prevConf: document.getElementById('prevConf'),
  prevVendor: document.getElementById('prevVendor'),
  btnLoadSessions: document.getElementById('btnLoadSessions'),
  prevList: document.getElementById('prevList'),

  detailDialog: document.getElementById('detailDialog'),
  detailContainer: document.getElementById('detailContainer')
};

const store = {
  get api(){ return JSON.parse(localStorage.getItem('cb_api') || 'null'); },
  set api(v){ localStorage.setItem('cb_api', JSON.stringify(v)); }
};

function log(msg, type='info'){
  const stamp = new Date().toLocaleTimeString();
  const line = `[${stamp}] ${msg}`;
  els.status.textContent += (els.status.textContent ? '\n' : '') + line;
  els.status.scrollTop = els.status.scrollHeight;
  console[type === 'error' ? 'error' : 'log'](line);
}
function setConnected(on){
  els.apiStatus.textContent = on ? 'Connected' : 'Disconnected';
  els.apiStatus.style.background = on ? '#062f14' : '';
  els.apiStatus.style.color = on ? '#a7f3d0' : '';
  els.apiStatus.style.borderColor = on ? '#134e4a' : 'var(--border)';
}

/* Build headers per selected auth mode */
function authHeaders(json=true){
  const cfg = store.api;
  if(!cfg) throw new Error('API is not configured');
  const h = {};
  if (cfg.mode === 'bearer') {
    h['Authorization'] = `Bearer ${cfg.key}`;
  } else {
    h['X-API-Key'] = cfg.key;
  }
  if(json) h['Content-Type'] = 'application/json';
  return h;
}

/* Basic fetch wrapper with robust error handling and detailed messages */
async function apiFetch(path, opts={}){
  const cfg = store.api;
  if(!cfg?.url) throw new Error('Missing API base URL. Open API Settings.');
  const url = cfg.url.replace(/\/+$/,'') + path;
  const headers = opts.formData ? authHeaders(false) : {...authHeaders(true), ...(opts.headers||{})};
  const res = await fetch(url, {
    method: opts.method || 'GET',
    headers,
    body: opts.body || undefined,
  });
  const ct = res.headers.get('content-type') || '';
  if(!res.ok){
    let detail = '';
    try{
      if(ct.includes('application/json')){
        const j = await res.json();
        detail = j.message || j.error || JSON.stringify(j);
      }else{
        detail = await res.text();
      }
    }catch(_){}
    const err = new Error(`HTTP ${res.status} ${res.statusText} â€” ${detail || 'Request failed'}`);
    err.status = res.status;
    throw err;
  }
  if(ct.includes('application/json')) return res.json();
  return res.blob();
}

/* Populate dropdown helpers */
async function loadConferences(selectEl){
  const list = await apiFetch('/conferences');
  selectEl.innerHTML = '';
  for(const c of list || []){
    const opt = document.createElement('option');
    opt.value = c.id ?? c._id ?? c.uuid ?? c.conferenceId;
    opt.textContent = c.name ?? c.title ?? (`Conference ${opt.value}`);
    selectEl.appendChild(opt);
  }
}
async function loadVendorsForConference(confId, selectEl){
  selectEl.innerHTML = '';
  if(!confId){ return; }
  try{
    const list = await apiFetch(`/conferences/${encodeURIComponent(confId)}/vendors`);
    for(const v of list || []){
      const opt = document.createElement('option');
      opt.value = v.id ?? v._id ?? v.uuid ?? v.vendorId;
      opt.textContent = v.name ?? (`Vendor ${opt.value}`);
      selectEl.appendChild(opt);
    }
  }catch(e){
    // Fallback: load all vendors if conference-scoped endpoint unavailable
    log(`Warn: couldn't load vendors for conference â€” ${e.message}. Falling back to /vendors`);
    const list = await apiFetch('/vendors');
    for(const v of list || []){
      const opt = document.createElement('option');
      opt.value = v.id ?? v._id ?? v.uuid ?? v.vendorId;
      opt.textContent = v.name ?? (`Vendor ${opt.value}`);
      selectEl.appendChild(opt);
    }
  }
}

/* ===== Recording state ===== */
let mediaStream = null;
let mediaRecorder = null;
let audioChunks = [];
let recording = false;

function resetRecording(){
  audioChunks = [];
  recording = false;
  els.pillAudio.textContent = 'idle';
  els.pillSession.textContent = 'â€”';
}

async function startRecording(){
  // Request mic and start immediately (as required)
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  }catch(err){
    throw new Error('Microphone permission denied or unavailable.');
  }

  const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' :
               MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' :
               'audio/webm';
  mediaRecorder = new MediaRecorder(mediaStream, { mimeType: mime });
  audioChunks = [];
  mediaRecorder.addEventListener('dataavailable', e => { if(e.data.size>0) audioChunks.push(e.data); });
  mediaRecorder.addEventListener('stop', () => {
    mediaStream.getTracks().forEach(t=>t.stop());
  });
  mediaRecorder.start(1000); // gather chunks every second
  recording = true;
  els.pillAudio.textContent = 'recording';
  log('Audio recording started.');
}

async function stopRecordingGetBlob(){
  if(!mediaRecorder || !recording) return null;
  const stopped = new Promise((resolve) => {
    mediaRecorder.addEventListener('stop', resolve, { once:true });
  });
  mediaRecorder.stop();
  log('Stopping recorderâ€¦');
  await stopped;
  const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
  log(`Audio captured: ${(blob.size/1024/1024).toFixed(2)} MB`);
  resetRecording();
  return blob;
}

/* ===== Image handling ===== */
let imageFiles = [];
function renderImagePreview(){
  els.imagePreview.innerHTML = '';
  for(const f of imageFiles){
    const url = URL.createObjectURL(f);
    const img = document.createElement('img');
    img.src = url; img.className = 'thumb'; img.alt = f.name;
    els.imagePreview.appendChild(img);
  }
  els.pillImages.textContent = String(imageFiles.length);
}

/* ===== Session upload & enrichment ===== */
async function uploadSession({audioBlob, images, notes, conferenceId, vendorId}){
  const fd = new FormData();
  if(audioBlob) fd.append('audio', audioBlob, `session.${(audioBlob.type.split('/')[1]||'webm').split(';')[0]}`);
  for(const f of images){ fd.append('images', f, f.name); }
  if(notes) fd.append('notes', notes);
  if(conferenceId) fd.append('conferenceId', conferenceId);
  if(vendorId) fd.append('vendorId', vendorId);

  // POST /sessions/upload
  const res = await apiFetch('/sessions/upload', {
    method:'POST',
    body: fd,
    formData: true
  });
  // Expect a session object with id or similar
  const sessionId = res.id ?? res.sessionId ?? res._id ?? res.uuid;
  if(!sessionId){
    throw new Error('Upload succeeded but response did not include a session ID.');
  }
  log(`Uploaded. Session ID: ${sessionId}`);
  els.pillSession.textContent = sessionId;

  // Trigger enrichment per KB: POST /sessions/{id}/enrich
  try{
    await apiFetch(`/sessions/${encodeURIComponent(sessionId)}/enrich`, { method:'POST' });
    log('Enrichment triggered.');
  }catch(e){
    log(`Warning: could not trigger enrichment automatically â€” ${e.message}`);
  }
  return sessionId;
}

/* ===== Previous sessions browser ===== */
async function loadPrevious(conferenceId, vendorId){
  // If vendor is chosen, use /vendors/{id}/sessions. If not, load conference vendors then aggregate.
  const sessions = [];
  async function forVendor(vid){
    try{
      const list = await apiFetch(`/vendors/${encodeURIComponent(vid)}/sessions`);
      for(const s of list || []) sessions.push(s);
    }catch(e){
      log(`Error loading sessions for vendor ${vid}: ${e.message}`,'error');
    }
  }
  if(vendorId){
    await forVendor(vendorId);
  }else{
    const vendors = await apiFetch(`/conferences/${encodeURIComponent(conferenceId)}/vendors`);
    for(const v of vendors || []){ /* serial to be polite; could parallelize */
      const vid = v.id ?? v._id ?? v.vendorId ?? v.uuid;
      if(vid) await forVendor(vid);
    }
  }
  // Render list
  els.prevList.innerHTML = '';
  if(sessions.length===0){
    els.prevList.innerHTML = `<div class="item"><em>No sessions found.</em></div>`;
    return;
  }
  for(const s of sessions){
    const sid = s.id ?? s.sessionId ?? s._id ?? s.uuid ?? '(unknown)';
    const status = s.status ?? s.state ?? 'uploaded';
    const when = s.createdAt ? new Date(s.createdAt).toLocaleString() : '';
    const div = document.createElement('div');
    div.className = 'item';
    div.innerHTML = `
      <div class="kv">
        <strong>Session ${sid}</strong>
        <span>â€¢</span><span class="muted">${status}</span>
        ${when ? `<span>â€¢</span><span class="muted">${when}</span>`:''}
      </div>
      <div class="right-actions">
        <button class="ghost" data-sid="${sid}">Open</button>
      </div>
    `;
    div.querySelector('button').addEventListener('click', ()=> openSessionDetail(sid));
    els.prevList.appendChild(div);
  }
}

async function openSessionDetail(sessionId){
  // Grab metadata
  let meta = null, report = null;
  try{
    meta = await apiFetch(`/sessions/${encodeURIComponent(sessionId)}`);
  }catch(e){
    log(`Error fetching session meta: ${e.message}`,'error');
  }
  try{
    report = await apiFetch(`/reports/session/${encodeURIComponent(sessionId)}`);
  }catch(e){
    log(`Error fetching session report: ${e.message}`,'error');
  }

  // Build UI
  const files = (meta?.files||meta?.uploads||[]);
  const images = (report?.images || meta?.images || []);
  const ocr = report?.imageOcr || report?.ocr || null;
  const transcript = report?.transcript || report?.transcription || null;
  const summary = report?.summary || null;
  const notes = meta?.notes || report?.notes || null;

  const imgHtml = (images && images.length)
   ? `<div class="preview">${images.map(u=>`<img src="${u}" class="thumb" alt="image">`).join('')}</div>` 
   : `<em class="muted">No images</em>`;

  const filesHtml = (files && files.length)
   ? `<ul>${files.map(f=>`<li><a href="${f.url||f.href||'#'}" target="_blank" rel="noopener">${f.name||f.filename||f.url||'file'}</a></li>`).join('')}</ul>`
   : `<em class="muted">No files</em>`;

  els.detailContainer.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
      <h3>Session ${sessionId}</h3>
      <button class="ghost" onclick="document.getElementById('detailDialog').close()">Close</button>
    </div>
    <div class="grid-3">
      <div class="item">
        <strong>Files</strong>
        ${filesHtml}
      </div>
      <div class="item">
        <strong>Transcript</strong>
        <pre class="status" style="max-height:180px">${transcript ? escapeHtml(String(transcript)) : 'â€”'}</pre>
      </div>
      <div class="item">
        <strong>Image OCR</strong>
        <pre class="status" style="max-height:180px">${ocr ? escapeHtml(typeof ocr==='string'? ocr : JSON.stringify(ocr,null,2)) : 'â€”'}</pre>
      </div>
    </div>
    <div class="item" style="margin-top:8px">
      <strong>Images</strong>
      ${imgHtml}
    </div>
    <div class="grid-2" style="margin-top:8px">
      <div class="item">
        <strong>Notes</strong>
        <pre class="status" style="max-height:140px">${notes ? escapeHtml(String(notes)) : 'â€”'}</pre>
      </div>
      <div class="item">
        <strong>Summary</strong>
        <pre class="status" style="max-height:140px">${summary ? escapeHtml(String(summary)) : 'â€”'}</pre>
      </div>
    </div>
  `;
  els.detailDialog.showModal();
}

/* ===== Event wiring ===== */

els.btnOpenAuth.addEventListener('click', ()=> {
  const cfg = store.api || {url:'',key:'',mode:'xapikey'};
  els.apiUrl.value = cfg.url || '';
  els.apiKey.value = cfg.key || '';
  els.authMode.value = cfg.mode || 'xapikey';
  els.authDialog.showModal();
});
els.btnCloseAuth.addEventListener('click', ()=> els.authDialog.close());

els.btnSave.addEventListener('click', ()=>{
  const url = els.apiUrl.value.trim();
  const key = els.apiKey.value.trim();
  const mode = els.authMode.value;
  if(!url || !key){
    alert('Please enter API base URL and API key.');
    return;
  }
  store.api = {url,key,mode};
  setConnected(true);
  els.authDialog.close();
  boot(); // reload lists
});

els.btnTest.addEventListener('click', async ()=>{
  try{
    await apiFetch('/health');
    alert('Connection OK âœ”');
  }catch(e){
    alert('Connection failed: ' + e.message);
  }
});

els.btnAddConf.addEventListener('click', async ()=>{
  // preload conference list in modal for vendor creation convenience later
  els.confDialog.showModal();
});
els.btnAddVendor.addEventListener('click', async ()=>{
  // ensure conferences exist in dropdown
  await loadConferences(els.newVendorConf);
  els.vendorDialog.showModal();
});
els.btnCreateConf.addEventListener('click', async ()=>{
  try{
    const body = { name: els.newConfName.value.trim() };
    const date = els.newConfDate.value;
    if(date) body.date = date;
    if(!body.name) return alert('Please enter a conference name.');
    const created = await apiFetch('/conferences', { method:'POST', body: JSON.stringify(body) });
    log('Conference created: ' + (created?.id || created?.name || 'ok'));
    els.confDialog.close();
    await loadConferences(els.confSelect);
    // select new conf if ID available
    const cid = created?.id ?? created?._id ?? created?.uuid ?? created?.conferenceId;
    if(cid) els.confSelect.value = cid;
    await loadVendorsForConference(els.confSelect.value, els.vendorSelect);
  }catch(e){
    alert('Create conference failed: ' + e.message);
  }
});
els.btnCreateVendor.addEventListener('click', async ()=>{
  try{
    const name = els.newVendorName.value.trim();
    const confId = els.newVendorConf.value;
    if(!name || !confId) return alert('Enter vendor name and select a conference.');
    const created = await apiFetch('/vendors', { method:'POST', body: JSON.stringify({ name, conferenceId: confId }) });
    log('Vendor created: ' + (created?.id || created?.name || 'ok'));
    els.vendorDialog.close();
    await loadVendorsForConference(els.confSelect.value, els.vendorSelect);
    // set vendor if id matches
    const vid = created?.id ?? created?._id ?? created?.uuid ?? created?.vendorId;
    if(vid) els.vendorSelect.value = vid;
  }catch(e){
    alert('Create vendor failed: ' + e.message);
  }
});

els.confSelect.addEventListener('change', async ()=>{
  await loadVendorsForConference(els.confSelect.value, els.vendorSelect);
});

els.imageInput.addEventListener('change', (e)=>{
  imageFiles = Array.from(e.target.files || []);
  renderImagePreview();
});

els.btnStart.addEventListener('click', async ()=>{
  if(!store.api){ return alert('Configure API first.'); }
  if(!els.confSelect.value){ return alert('Select a conference.'); }
  if(!els.vendorSelect.value){ return alert('Select a vendor.'); }
  els.btnStart.disabled = true;
  els.btnStop.disabled = false;
  try{
    await startRecording(); // MUST start immediately on session start
    log('Session started. Recording in progress.');
  }catch(e){
    els.btnStart.disabled = false;
    els.btnStop.disabled = true;
    alert('Cannot start recording: ' + e.message);
  }
});

els.btnStop.addEventListener('click', async ()=>{
  els.btnStop.disabled = true;
  try{
    const audioBlob = await stopRecordingGetBlob();
    if(!audioBlob){ throw new Error('No audio captured.'); }
    const sessionId = await uploadSession({
      audioBlob,
      images: imageFiles,
      notes: els.notes.value,
      conferenceId: els.confSelect.value,
      vendorId: els.vendorSelect.value
    });
    alert('Uploaded! Session ID: ' + sessionId + '\nEnrichment started.');
  }catch(e){
    alert('Upload failed: ' + e.message);
  }finally{
    els.btnStart.disabled = false;
    imageFiles = []; renderImagePreview(); els.notes.value='';
  }
});

els.btnPrevious.addEventListener('click', async ()=>{
  await loadConferences(els.prevConf);
  await loadVendorsForConference(els.prevConf.value, els.prevVendor);
  els.prevDialog.showModal();
});
els.prevConf.addEventListener('change', async ()=>{
  await loadVendorsForConference(els.prevConf.value, els.prevVendor);
});
els.btnLoadSessions.addEventListener('click', async ()=>{
  els.prevList.innerHTML = '<div class="item"><em>Loadingâ€¦</em></div>';
  try{
    await loadPrevious(els.prevConf.value, els.prevVendor.value || null);
  }catch(e){
    els.prevList.innerHTML = `<div class="item"><strong>Error:</strong> ${escapeHtml(e.message)}</div>`;
  }
});

/* ===== Bootstrap ===== */
async function boot(){
  const cfg = store.api;
  if(cfg){
    setConnected(true);
    try{
      await Promise.all([
        loadConferences(els.confSelect).then(()=> loadVendorsForConference(els.confSelect.value, els.vendorSelect)),
      ]);
      log('Dropdowns populated from API.');
    }catch(e){
      log('Could not load initial data: ' + e.message, 'error');
    }
  }else{
    setConnected(false);
    els.authDialog.showModal();
  }
}

/* ===== Helpers ===== */
function escapeHtml(str){ return str.replace(/[&<>"']/g,s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

/* Keyboard a11y for dialogs (Esc) */
for(const d of [els.authDialog, els.confDialog, els.vendorDialog, els.prevDialog, els.detailDialog]){
  d?.addEventListener('cancel', e=>{ e.preventDefault(); d.close(); });
}

/* Start app */
boot();

</script>
</body>
  </html>
