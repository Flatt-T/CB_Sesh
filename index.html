<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1" />
  <title>Conference Buddy – Sessions</title>
  <!--
    ✅ Keeps your working functionality and IDs
    - IDs preserved: apiBase, apiKey, conferenceSelect, vendorSelect, notes, photos, audio
      btnStart, btnStop, btnUpload, btnCheck, btnRefreshConfs, btnConfsForVendor,
      btnRefreshVendors, btnVendorDetails, btnRefreshSessions, status, logs, btnCopy, btnClearLog,
      sessionsList
    - API key stored ONLY in localStorage and sent in X-API-Key header
    - Inline recorder auto‑starts when session starts; stops when session stops
    - If user selects an audio file, that takes priority over the recorded blob
  -->
  <style>
    :root{--bg:#0b0f14;--card:#121821;--muted:#8b98a5;--text:#e6edf3;--text-dim:#9fb0c3;--primary:#3ea6ff;--accent:#7ef0d7;--danger:#ff6b6b;--warn:#ffcc66;--ok:#6ee7a5;--border:#1f2a3a}
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 1200px at 80% -10%, #182233 0%, var(--bg) 60%);color:var(--text);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;-webkit-font-smoothing:antialiased}
    header,section{max-width:900px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;background:linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.6) 60%, transparent);backdrop-filter:blur(6px);z-index:5}
    h1{font-size:1.1rem;margin:0 0 6px;display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px var(--accent)}

    .grid{display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width:720px){.row,.row-3{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg, rgba(26,36,49,.7), rgba(18,24,33,.9));border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    label{display:block;font-size:.85rem;color:var(--text-dim);margin:6px 0}
    select,textarea,input[type="text"],input[type="url"],input[type="password"],input[type="datetime-local"]{width:100%;border:1px solid #223049;background:#0c111a;color:var(--text);border-radius:12px;padding:11px 12px;outline:none}
    textarea{min-height:96px;resize:vertical}
    input[type="file"]{width:100%}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:#1b2430;color:var(--text);border:1px solid #2a3341;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn.primary{background:linear-gradient(180deg,#298DFF,#1671d8);border-color:#1a66b6}
    .btn.alt{background:#2b90d9;border-color:#1d6fa8}
    .btn.danger{background:linear-gradient(180deg,#ff6b6b,#e65050);border-color:#c63f39}
    .stack{display:flex;flex-wrap:wrap;gap:8px}
    .pill{border:1px dashed #2b3646;border-radius:999px;padding:8px 12px;font-size:.85rem;color:var(--text-dim)}
    .small{font-size:.8rem;color:var(--text-dim)}
    pre{white-space:pre-wrap;word-break:break-word;background:#0c111a;border:1px solid #273143;border-radius:12px;padding:10px;max-height:280px;overflow:auto}
    .ok{color:#6ee7a5}.warn{color:#facc15}.err{color:#fca5a5}
    .divider{height:1px;background:#223045;margin:10px 0}

    /* Inline recorder visuals */
    .rec-wrap{display:grid;gap:8px}
    .rec-bar{display:flex;align-items:center;justify-content:space-between;gap:8px;background:#0f1622;border:1px solid var(--border);border-radius:14px;padding:8px 10px}
    .rec-led{width:10px;height:10px;border-radius:50%;background:#666}
    .rec-led.active{background:#ff4d4d;box-shadow:0 0 0 6px rgba(255,77,77,.15)}
    .timer{font-variant-numeric:tabular-nums;font-weight:700}
  </style>
</head>
<body>
  <header>
    <h1><span class="dot"></span>Conference Buddy — Session Uploader</h1>
  </header>

  <section class="card grid">
    <!-- Config -->
    <div class="row">
      <div>
        <label>API Base URL</label>
        <input id="apiBase" type="url" placeholder="https://conference-buddy-geoutils.replit.app/api" />
      </div>
      <div>
        <label>API Key</label>
        <input id="apiKey" type="password" placeholder="•••" autocomplete="off" />
        <div class="stack" style="margin-top:6px">
          <button class="btn alt" id="btnSaveConfig">Save Config</button>
        </div>
      </div>
    </div>

    <!-- Conference / Vendor -->
    <div class="row">
      <div>
        <label>Conference</label>
        <select id="conferenceSelect"></select>
        <div class="stack" style="margin-top:6px">
          <button class="btn alt" id="btnRefreshConfs">Refresh</button>
          <button class="btn" id="btnConfsForVendor">Load Conf’s Vendors</button>
        </div>
      </div>
      <div>
        <label>Vendor</label>
        <select id="vendorSelect"></select>
        <div class="stack" style="margin-top:6px">
          <button class="btn alt" id="btnRefreshVendors">Refresh</button>
          <button class="btn" id="btnVendorDetails">View</button>
        </div>
      </div>
    </div>

    <!-- Notes -->
    <div>
      <label>Notes</label>
      <textarea id="notes" placeholder="Quick notes…"></textarea>
    </div>

    <!-- Media pickers + inline recorder (auto) -->
    <div class="row">
      <div class="card">
        <label>Photos (multiple)</label>
        <input id="photos" type="file" accept="image/*" multiple capture="environment" />
        <div class="small">You can add more photos before uploading.</div>
      </div>
      <div class="card">
        <label>Audio</label>
        <input id="audio" type="file" accept="audio/*,.m4a,.aac,.wav,.mp3,.ogg" />
        <div class="small">Recording starts automatically with the session. You can attach a file instead.</div>
        <div class="rec-wrap" style="margin-top:8px">
          <div class="rec-bar">
            <div class="stack" style="align-items:center">
              <span id="recLed" class="rec-led" aria-hidden="true"></span>
              <span class="pill">Format: <span id="audioFormat">—</span></span>
            </div>
            <span class="pill">Timer: <span id="recTimer" class="timer">00:00</span></span>
          </div>
          <div class="stack">
            <button id="btnRecClear" class="btn">Clear Recording</button>
          </div>
          <audio id="playback" controls style="width:100%"></audio>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="stack">
      <button class="btn primary" id="btnStart">Start Session</button>
      <button class="btn" id="btnStop" disabled>Stop Session</button>
      <button class="btn alt" id="btnUpload" disabled>Upload Files</button>
      <button class="btn" id="btnCheck" disabled>Check Progress</button>
    </div>

    <div>
      <div class="divider"></div>
      <div class="small">Status</div>
      <div id="status" class="pill">idle</div>
    </div>

    <div>
      <div class="divider"></div>
      <div class="small">Logs</div>
      <pre id="logs"></pre>
      <div class="stack">
        <button class="btn" id="btnCopy">Copy</button>
        <button class="btn danger" id="btnClearLog">Clear</button>
      </div>
    </div>

    <div>
      <div class="divider"></div>
      <div class="small">Previous Sessions</div>
      <div class="stack">
        <button class="btn" id="btnRefreshSessions">Refresh</button>
      </div>
      <div id="sessionsList" class="grid"></div>
    </div>
  </section>

  <script>
    // -------- Logger --------
    const $ = (id) => document.getElementById(id);
    const logsEl = $("logs");
    function log(level, msg, obj){
      const t = new Date().toISOString();
      const line = { t, level, msg, extra: obj ?? "" };
      logsEl.textContent += JSON.stringify(line) + "
";
      logsEl.scrollTop = logsEl.scrollHeight;
      (level==="error"?console.error:level==="warn"?console.warn:console.log)(line);
      $("status").textContent = msg;
      $("status").className = "pill " + (level==="error"?"err":level==="warn"?"warn":"ok");
    }
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

    // -------- Config (localStorage) --------
    const cfg = {
      get base(){ return localStorage.getItem("cb_api_base") || ""; },
      set base(v){ localStorage.setItem("cb_api_base", v || ""); },
      get key(){ return localStorage.getItem("cb_api_key") || ""; },
      set key(v){ localStorage.setItem("cb_api_key", v || ""); },
    };
    $("apiBase").value = cfg.base || "https://conference-buddy-geoutils.replit.app/api";
    $("apiKey").value = cfg.key || "";
    function updateConfig(){
      cfg.base = $("apiBase").value.trim().replace(/\/+$/,'');
      cfg.key = $("apiKey").value.trim();
      log("info","Config updated.");
    }
    $("apiBase").addEventListener("change", updateConfig);
    $("apiKey").addEventListener("change", updateConfig);
    $("btnSaveConfig").addEventListener("click", updateConfig);

    // -------- API core --------
    async function apiFetch(path, { method="GET", headers={}, json, formData }={}){
      const url = (cfg.base || '').replace(/\/+$/,'') + path;
      const h = { "X-API-Key": cfg.key, ...headers };
      let body;
      if (json !== undefined){ h["Content-Type"] = "application/json"; body = JSON.stringify(json); }
      else if (formData instanceof FormData){ body = formData; }

      log("info", `HTTP ${method} ${url}`, "→ request");
      const res = await fetch(url, { method, headers:h, body });
      let payload; try{ payload = await res.json(); } catch { payload = await res.text(); }
      log("info", `HTTP ${method} ${url}`, `← ${res.status} ${res.statusText||''}`);
      if (!res.ok){ const err = new Error((payload&&payload.error)||`${res.status}`); err.response = payload; throw err; }
      return payload;
    }

    // -------- UI state --------
    let currentSession = null; // { id, start }
    let recordedBlob = null;   // inline recorder blob
    let recordedMime = '';

    // -------- Dropdowns --------
    async function loadConferences(){
      const data = await apiFetch('/conferences');
      const sel = $("conferenceSelect"); sel.innerHTML='';
      for (const c of (data.data||[])){ const o=document.createElement('option'); o.value=c.id; o.textContent=c.name||'(Unnamed)'; sel.appendChild(o); }
      log('info','Conferences loaded.');
    }
    async function loadVendors(){
      const data = await apiFetch('/vendors');
      const sel = $("vendorSelect"); sel.innerHTML='';
      for (const v of (data.data||[])){ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name||'(Unnamed)'; sel.appendChild(o); }
      log('info','Vendors loaded.');
    }
    async function loadVendorsForSelectedConference(){
      const confId = $("conferenceSelect").value; if(!confId) return;
      const data = await apiFetch(`/conferences/${confId}/vendors`);
      const sel = $("vendorSelect"); sel.innerHTML='';
      for (const v of (data.data||[])){ const o=document.createElement('option'); o.value=v.id; o.textContent=v.name||'(Unnamed)'; sel.appendChild(o); }
      log('info','Vendors for conference loaded.');
    }
    async function vendorDetails(){ const id=$("vendorSelect").value; if(!id) return; await apiFetch(`/vendors/${id}`); }

    // -------- Sessions list --------
    async function listSessions(){
      const vendorId = $("vendorSelect").value;
      if (!vendorId){ $("sessionsList").innerHTML = "<div class='small'>Select a vendor.</div>"; return; }
      const vendor = await apiFetch(`/vendors/${vendorId}`);
      const sessions = (vendor.data && vendor.data.sessions) || [];
      const wrap = document.createElement('div');
      for (const s of sessions){
        const el = document.createElement('div'); el.className='card';
        el.innerHTML = `<div><b>${(vendor.data && vendor.data.name)||'Vendor'}</b> — <span class="small">${s.processing_status||'n/a'}</span></div>
          <div class="small">Start: ${s.start_time||'?'} </div>
          <div class="small">Id: ${s.id}</div>
          <div class="stack" style="margin-top:8px">
            <button class="btn" data-view="${s.id}">View</button>
            <button class="btn alt" data-check="${s.id}">Check</button>
          </div>`;
        wrap.appendChild(el);
      }
      $("sessionsList").innerHTML = ''; $("sessionsList").appendChild(wrap);
      $("sessionsList").querySelectorAll('[data-view]').forEach(b=>{ b.onclick=()=> apiFetch(`/sessions/${b.dataset.view}`).catch(e=>log('error','View failed',e.message)); });
      $("sessionsList").querySelectorAll('[data-check]').forEach(b=>{ b.onclick=()=> checkProgress(b.dataset.check); });
    }

    // -------- Inline recorder (auto start/stop with session) --------
    const rec = { media:null, chunks:[], timer:null, s:0 };
    const led = $("recLed"), tEl=$("recTimer"), fmtEl=$("audioFormat"), play=$("playback");
    function tick(){ rec.s++; const m=String(Math.floor(rec.s/60)).padStart(2,'0'); const s=String(rec.s%60).padStart(2,'0'); tEl.textContent = `${m}:${s}`; }
    function resetTimer(){ rec.s=0; tEl.textContent='00:00'; clearInterval(rec.timer); rec.timer=null; }
    function clearRecordingUI(){ recordedBlob=null; recordedMime=''; fmtEl.textContent='—'; play.removeAttribute('src'); play.load(); resetTimer(); led.classList.remove('active'); }

    async function startRec(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        const prefer = ['audio/webm','audio/mp4','audio/ogg'];
        const mime = prefer.find(m=> MediaRecorder.isTypeSupported(m)) || 'audio/webm';
        const mr = new MediaRecorder(stream, { mimeType: mime });
        rec.media = mr; rec.chunks = []; recordedBlob=null; recordedMime=mime; fmtEl.textContent = mime;
        mr.ondataavailable = e=>{ if(e.data && e.data.size) rec.chunks.push(e.data); };
        mr.onstop = ()=>{ if (rec.chunks.length){ recordedBlob = new Blob(rec.chunks, { type: recordedMime }); play.src = URL.createObjectURL(recordedBlob); play.load(); } stream.getTracks().forEach(t=>t.stop()); };
        mr.start(); led.classList.add('active'); rec.timer=setInterval(tick,1000); rec.s=0; tEl.textContent='00:00';
      }catch(err){ log('warn','Microphone unavailable, use file picker instead.'); }
    }
    function stopRec(){ if(rec.media && rec.media.state!=='inactive'){ rec.media.stop(); } led.classList.remove('active'); clearInterval(rec.timer); }

    // If user manually picks a file, prefer that over recording
    $("audio").addEventListener('change', ()=>{ if($("audio").files[0]){ recordedBlob=null; recordedMime=''; fmtEl.textContent = $("audio").files[0].type || 'n/a'; play.src = URL.createObjectURL($("audio").files[0]); play.load(); resetTimer(); led.classList.remove('active'); if(rec.media && rec.media.state!=='inactive'){ stopRec(); } } });
    $("btnRecClear").addEventListener('click', ()=>{ clearRecordingUI(); $("audio").value=''; });

    // -------- Two-step flow --------
    async function startSession(){
      updateConfig();
      const conference_id = $("conferenceSelect").value;
      const vendor_id = $("vendorSelect").value;
      if (!cfg.base || !cfg.key) return log('error','API base/key required.');
      if (!conference_id || !vendor_id) return log('warn','Pick a conference and vendor first.');
      const start_time = new Date().toISOString();
      const created = await apiFetch('/mobile/sessions/create', { method:'POST', json:{ vendor_id, conference_id, start_time } });
      const sid = created.session_id || created.id || (created.data && created.data.id);
      if (!sid) throw new Error('Create did not return session_id');
      currentSession = { id:sid, start:start_time };
      $("btnStart").disabled = true; $("btnStop").disabled = false; $("btnUpload").disabled = false; $("btnCheck").disabled = false;
      // Auto‑start inline recording
      await startRec();
      log('info',`Session created: ${sid}`);
    }
    function stopSession(){ if (!currentSession) return log('warn','No active session.'); $("btnStop").disabled = true; stopRec(); log('info','Session stopped. Ready to upload files.'); }

    async function uploadFiles(){
      if (!currentSession) return log('warn','Start a session first.');
      const sid = currentSession.id; const end_time = new Date().toISOString();
      const fd = new FormData();
      // images
      const photos = $("photos").files; for (let i=0;i<photos.length;i++) fd.append('image_files', photos[i], photos[i].name);
      // audio: prefer manual file; otherwise use recorded blob
      const audioFile = $("audio").files[0];
      if (audioFile){ fd.append('audio_files', audioFile, audioFile.name); }
      else if (recordedBlob){ fd.append('audio_files', new File([recordedBlob], `recording.${recordedMime.includes('webm')?'webm': recordedMime.includes('ogg')?'ogg':'m4a'}`, { type: recordedMime||'audio/webm' })); }
      const userNotes = $("notes").value || '';
      if (userNotes){ fd.append('notes', userNotes); fd.append('user_notes', userNotes); }
      fd.append('end_time', end_time);

      await apiFetch(`/sessions/${encodeURIComponent(sid)}/add-files`, { method:'POST', formData: fd });
      log('info',`Files uploaded to ${sid}.`);

      try{ await triggerEnrichment(sid); }catch{ log('warn','Enrichment trigger not available on this server.'); }

      // clear
      $("notes").value=''; $("photos").value=''; $("audio").value=''; clearRecordingUI();
      log('info','Inputs cleared (notes, photos, audio).');
      await listSessions(); await pollProgress(sid,5);
    }

    async function triggerEnrichment(sessionId){
      try{ await apiFetch(`/sessions/${encodeURIComponent(sessionId)}/trigger-enrichment`, { method:'POST', json:{} }); log('info','Enrichment triggered.'); return; }
      catch(e){ log('warn','Primary enrichment route failed, trying mobile variant…'); }
      await apiFetch(`/mobile/sessions/${encodeURIComponent(sessionId)}/trigger-enrichment`, { method:'POST', json:{} });
      log('info','Enrichment triggered (mobile route).');
    }

    async function checkProgress(sessionId){ const sid = sessionId || (currentSession && currentSession.id); if(!sid) return log('warn','No session id.'); await apiFetch(`/sessions/${encodeURIComponent(sid)}`); }
    async function pollProgress(sessionId, attempts=5){
      for (let i=0;i<attempts;i++){ await sleep(1200); try{ const s = await apiFetch(`/sessions/${encodeURIComponent(sessionId)}`); const p = s && (s.data||s); const stage = (p.processing_status||p.status||'n/a'); log('info',`Progress: ${stage}`); if (['transcribed','completed','enriched'].includes(stage)) break; } catch(e){ log('warn','Progress check error.'); break; } }
    }

    // -------- Buttons --------
    $("btnStart").onclick = ()=> startSession().catch(e=>log('error','Create failed', e.response?.error || e.message));
    $("btnStop").onclick = ()=> stopSession();
    $("btnUpload").onclick = ()=> uploadFiles().catch(e=>{ const details = typeof e.response === 'string' ? e.response : (e.response?.details || ''); log('error','Upload failed', (e.response?.error || e.message) + (details?` — ${details}`:'')); });
    $("btnCheck").onclick = ()=> checkProgress().catch(e=>log('error','Check failed', e.response?.error || e.message));

    $("btnRefreshConfs").onclick = ()=> loadConferences().catch(e=>log('error','Load conferences failed', e.message));
    $("btnRefreshVendors").onclick = ()=> loadVendors().catch(e=>log('error','Load vendors failed', e.message));
    $("btnConfsForVendor").onclick = ()=> loadVendorsForSelectedConference().catch(e=>log('error','Load conf vendors failed', e.message));
    $("btnVendorDetails").onclick = ()=> vendorDetails().catch(e=>log('error','Vendor details failed', e.message));

    $("btnRefreshSessions").onclick = ()=> listSessions().catch(e=>log('error','List sessions failed', e.message));

    $("btnCopy").onclick = async ()=>{ try{ await navigator.clipboard.writeText(logsEl.textContent); log('info','Logs copied.'); } catch{ log('error','Copy failed.'); } };
    $("btnClearLog").onclick = ()=>{ logsEl.textContent=''; log('info','Logs cleared.'); };

    // -------- Initial load --------
    (async function init(){
      try{
        updateConfig();
        if (!cfg.base) log('warn','API base URL not configured.');
        await loadConferences(); await loadVendors();
        log('info','Dropdowns populated from API.');
      }catch(e){ log('error','Initial load failed', e.message); }
    })();
  </script>
</body>
</html>
