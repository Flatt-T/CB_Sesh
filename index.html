<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Conference Buddy – Mobile Capture</title>
<style>
  :root{
    --bg:#0b0f14; --card:#111722; --muted:#1a2230; --line:#213148;
    --txt:#e8eef7; --sub:#a9b6c9; --acc:#5cc8ff; --good:#39d98a; --warn:#ffcc66; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,sans-serif}
  .wrap{max-width:860px;margin:0 auto;padding:16px 16px 120px}
  h1{font-size:22px;margin:8px 0 16px;font-weight:700}
  .row{display:grid;gap:12px}
  .grid-2{grid-template-columns:1fr 1fr}
  @media (max-width:720px){ .grid-2{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .card h2{margin:0 0 10px;font-size:16px}
  label{font-size:12px;color:var(--sub);display:block;margin:6px 0 4px}
  select, input[type="text"], textarea{
    width:100%;background:#0e141f;border:1px solid var(--line);color:var(--txt);
    border-radius:10px;padding:10px 12px;font-size:14px;outline:none
  }
  textarea{min-height:140px;resize:vertical}
  .btn{appearance:none;border:1px solid var(--line);background:linear-gradient(180deg,#1a2333,#131a27);
       color:var(--txt);padding:10px 12px;border-radius:12px;font-size:14px;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#1c3246,#152537);border-color:#2a425b}
  .btn.ghost{background:transparent}
  .btn.danger{background:#2a1616;border-color:#4d1d1d}
  .btn.good{background:#162a1d;border-color:#233d2b}
  .btn.warn{background:#2e2714;border-color:#4b3f1a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:8px}
  .pill{padding:6px 10px;border:1px solid var(--line);background:var(--muted);border-radius:999px;color:var(--sub);font-size:12px}
  .hint{font-size:12px;color:var(--sub)}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
  .bar{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .divider{height:1px;background:var(--line);margin:8px 0}
  .hidden{display:none !important}

  /* Logs panel */
  .logs-toggle{position:fixed;right:14px;bottom:14px;z-index:50}
  .drawer{position:fixed;inset:0 0 0 auto;width:min(720px,100%);background:var(--card);border-left:1px solid var(--line);transform:translateX(100%);transition:.25s;z-index:60}
  .drawer.open{transform:translateX(0)}
  .drawer header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
  .drawer .body{padding:12px;height:calc(100% - 54px);overflow:auto}
  .logline{padding:8px;border:1px solid var(--line);border-radius:10px;background:#0e141f;margin-bottom:8px}
  .badge{font-size:11px;border:1px solid var(--line);background:var(--muted);border-radius:8px;padding:2px 6px;color:var(--sub)}
  .status-2xx{color:var(--good)} .status-4xx{color:var(--warn)} .status-5xx{color:var(--bad)}
  .small{font-size:12px;color:var(--sub)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Conference Buddy — Mobile Capture</h1>

    <!-- Credentials -->
    <section id="sec-creds" class="card">
      <h2>API Credentials</h2>
      <div class="row grid-2">
        <div>
          <label>API Base URL</label>
          <input id="apiBase" type="text" placeholder="https://conference-buddy-geoutils.replit.app" />
        </div>
        <div>
          <label>X-API-Key</label>
          <input id="apiKey" type="text" placeholder="•••" />
        </div>
      </div>
      <div class="bar" style="margin-top:10px">
        <div class="hint">Saved once and reused automatically.</div>
        <div class="flex">
          <button id="btnSave" class="btn primary">Save</button>
          <button id="btnReset" class="btn ghost">Reset</button>
        </div>
      </div>
    </section>

    <!-- Record / Upload -->
    <section id="sec-capture" class="card hidden">
      <h2>Record Session</h2>
      <div class="row grid-2">
        <div>
          <label>Conference</label>
          <select id="selConference"><option value="">(None / Unknown)</option></select>
        </div>
        <div>
          <label>Vendor</label>
          <select id="selVendor"><option value="">(None / Unknown)</option></select>
        </div>
      </div>

      <div class="divider"></div>
      <div class="row">
        <div class="stack">
          <label>Notes</label>
          <textarea id="txtNotes" placeholder="Type quick notes…"></textarea>
          <div class="hint">Notes are added with your uploads; cleared after a successful upload.</div>
        </div>

        <div class="row grid-2">
          <div class="stack">
            <label>Photos (multi)</label>
            <input id="inpPhotos" type="file" accept="image/*" capture="environment" multiple />
            <div class="small">You can add several images at once.</div>
          </div>
          <div class="stack">
            <label>Audio</label>
            <div class="flex">
              <button id="btnRec" class="btn">Start</button>
              <button id="btnStop" class="btn warn" disabled>Stop</button>
              <span id="recStatus" class="pill">idle</span>
            </div>
            <input id="inpAudio" type="file" accept="audio/*,.m4a,.aac,.mp3,.wav,.ogg" class="hidden" />
            <div id="audMeta" class="small"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="flex">
          <button id="btnCreate" class="btn primary">Create Session</button>
          <button id="btnUpload" class="btn good" disabled>Upload Files</button>
          <button id="btnRefresh" class="btn ghost">Check Progress</button>
        </div>
        <div id="currentSession" class="small"></div>
      </div>
    </section>

    <!-- Past Sessions -->
    <section id="sec-past" class="card hidden">
      <h2>Previous Sessions</h2>
      <div class="bar">
        <button id="btnReloadSessions" class="btn ghost">Refresh</button>
        <span id="pastInfo" class="small"></span>
      </div>
      <div id="pastList" class="stack" style="margin-top:8px"></div>
    </section>

    <!-- Diagnostics -->
    <section id="sec-diag" class="card hidden">
      <h2>Diagnostics & Logs</h2>
      <div class="flex">
        <button id="btnLogsSimple" class="btn ghost">Simple</button>
        <button id="btnLogsVerbose" class="btn ghost">Verbose</button>
        <button id="btnExportTxt" class="btn ghost">Export .txt</button>
        <button id="btnExportJson" class="btn ghost">Export .json</button>
      </div>
      <div id="diagPreview" class="stack" style="margin-top:8px"></div>
    </section>
  </div>

  <!-- Logs Drawer -->
  <button class="btn logs-toggle" id="openLogs">Logs</button>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <header>
      <strong>Request Logs</strong>
      <div class="flex">
        <button id="modeSimple" class="btn ghost">Simple</button>
        <button id="modeVerbose" class="btn ghost">Verbose</button>
        <button id="btnClose" class="btn">Close</button>
      </div>
    </header>
    <div class="body">
      <div id="logsContainer"></div>
    </div>
  </aside>

<script>
/** ========================
 *  State & Utilities
 *  ======================== */
const $ = sel => document.querySelector(sel);
const api = {
  base: '',
  key: '',
  sessionId: null,
  startTime: null,
  lastVendorId: null,
  lastConfId: null,
  audioBlob: null,
  audioFilename: null,
  images: [],
  logs: [],
  logMode: 'simple', // 'simple' | 'verbose'
};

function saveCreds() {
  const base = $('#apiBase').value.trim().replace(/\/+$/, '');
  const key = $('#apiKey').value.trim();
  if (!base || !key) { alert('Enter API base and key.'); return; }
  localStorage.setItem('cb.apiBase', base);
  localStorage.setItem('cb.apiKey', key);
  api.base = base; api.key = key;
  $('#sec-creds').classList.add('hidden');
  $('#sec-capture').classList.remove('hidden');
  $('#sec-past').classList.remove('hidden');
  $('#sec-diag').classList.remove('hidden');
  logInfo('Config updated.');
  bootstrap();
}

function resetCreds() {
  localStorage.removeItem('cb.apiBase');
  localStorage.removeItem('cb.apiKey');
  location.reload();
}

function loadCreds() {
  const base = localStorage.getItem('cb.apiBase') || '';
  const key  = localStorage.getItem('cb.apiKey')  || '';
  $('#apiBase').value = base;
  $('#apiKey').value = key;
  if (base && key) { api.base = base; api.key = key; $('#sec-creds').classList.add('hidden'); $('#sec-capture').classList.remove('hidden'); $('#sec-past').classList.remove('hidden'); $('#sec-diag').classList.remove('hidden'); bootstrap(); }
}

/** Logging */
function logLine(level,msg,extra=''){
  const t = new Date().toISOString();
  const rec = { t, level, msg, extra };
  api.logs.push(rec);
  renderLogs();
  // Also mirror to Diagnostics preview (compact)
  const p = document.createElement('pre');
  p.className = 'logline mono';
  p.textContent = JSON.stringify(rec);
  const diag = $('#diagPreview');
  if (diag) { diag.prepend(p); }
}
const logInfo = (msg,extra='') => logLine('info', msg, extra);
const logWarn = (msg,extra='') => logLine('warn', msg, extra);
const logErr  = (msg,extra='') => logLine('error', msg, extra);

/** Fetch wrapper that logs requests/responses */
async function apiFetch(path, opts={}){
  const url = path.startsWith('http') ? path : `${api.base}${path}`;
  const headers = Object.assign({}, opts.headers||{}, {'X-API-Key': api.key});
  const start = Date.now();
  logInfo(`HTTP ${opts.method||'GET'} ${url}`, '→ request');
  logInfo(JSON.stringify({ id: Math.random().toString(36).slice(2), method:opts.method||'GET', url, reqHeaders: headers }), '');
  const res = await fetch(url, { ...opts, headers });
  const dur = Date.now()-start;
  let bodyText = '';
  try { bodyText = await res.text(); } catch {}
  logInfo(`HTTP ${opts.method||'GET'} ${url}`, `← ${res.status}  (${dur}ms)`);
  logInfo(JSON.stringify({ dur:String(dur), status:res.status, resHeaders: Object.fromEntries(res.headers.entries()), body: bodyText }) , '');
  if (!res.ok) {
    throw new Error(`HTTP ${res.status} — ${bodyText || res.statusText}`);
  }
  try { return bodyText ? JSON.parse(bodyText) : {}; } catch(e){ return { raw: bodyText }; }
}

/** ========================
 *  Bootstrap data
 *  ======================== */
async function bootstrap(){
  // Conferences
  try{
    const j = await apiFetch('/api/conferences');
    $('#selConference').innerHTML = `<option value="">(None / Unknown)</option>` +
      (j.data||[]).map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
    logInfo('Conferences loaded.');
  }catch(e){ logErr('Initial load failed','Authentication required'); }

  // Vendors (all)
  try{
    const j = await apiFetch('/api/vendors');
    $('#selVendor').innerHTML = `<option value="">(None / Unknown)</option>` +
      (j.data||[]).map(v => `<option value="${v.id}">${escapeHtml(v.name)}</option>`).join('');
    logInfo('Vendors loaded.');
  }catch(e){ /* logged above */ }

  // If a conference is chosen later, filter vendors by conference id
  $('#selConference').addEventListener('change', async () => {
    const confId = $('#selConference').value;
    api.lastConfId = confId || null;
    if (!confId) { return; }
    try{
      const j = await apiFetch(`/api/conferences/${confId}/vendors`);
      $('#selVendor').innerHTML = `<option value="">(None / Unknown)</option>` +
        (j.data||[]).map(v => `<option value="${v.id}">${escapeHtml(v.name)}</option>`).join('');
    }catch(e){}
  });

  // When vendor changes, refresh past sessions
  $('#selVendor').addEventListener('change', () => {
    api.lastVendorId = $('#selVendor').value || null;
    renderPastSessions(); // loads from API
  });
}

/** ========================
 *  Audio Recording (inline)
 *  ======================== */
let mediaRec, recChunks=[], recMime=null, recTimer=null;

function supportedMime(){
  const prefs = ['audio/ogg;codecs=opus','audio/ogg','audio/webm;codecs=opus','audio/webm','audio/mp4','audio/m4a'];
  for (const m of prefs){ if (MediaRecorder.isTypeSupported?.(m)) return m; }
  return null;
}

$('#btnRec').addEventListener('click', async () => {
  try{
    const mime = supportedMime();
    if (!mime) {
      logWarn('Browser cannot produce supported recording; showing file picker fallback.');
      $('#inpAudio').click();
      return;
    }
    recMime = mime;
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    recChunks = [];
    mediaRec = new MediaRecorder(stream, { mimeType: mime });
    mediaRec.ondataavailable = e => { if (e.data?.size) recChunks.push(e.data); };
    mediaRec.onstop = () => {
      const blob = new Blob(recChunks, { type: recMime });
      // Map mime to allowed extension (api allows: mp3,wav,m4a,aac,ogg)
      const ext = recMime.includes('ogg') ? 'ogg'
                 : recMime.includes('mp4') || recMime.includes('m4a') ? 'm4a'
                 : recMime.includes('webm') ? 'ogg' // rename to ogg to pass validator
                 : 'm4a';
      api.audioBlob = new File([blob], `session_audio.${ext}`, { type: blob.type });
      api.audioFilename = api.audioBlob.name;
      $('#audMeta').textContent = `Audio ready: ${api.audioFilename} (${fmtSize(api.audioBlob.size)})`;
      $('#btnUpload').disabled = !api.sessionId;
      logInfo(`Audio captured: ${fmtSize(api.audioBlob.size)}`, '');
    };
    mediaRec.start(100);
    $('#recStatus').textContent = 'recording…';
    $('#btnRec').disabled = true; $('#btnStop').disabled = false;
    recTimer = setInterval(()=>{$('#recStatus').textContent = 'recording… ' + new Date().toLocaleTimeString();},1000);
    logInfo('Audio recording started.');
  }catch(e){
    logWarn('Recording not available — opening file picker.');
    $('#inpAudio').click();
  }
});

$('#btnStop').addEventListener('click', () => {
  try{
    mediaRec?.stop();
    mediaRec?.stream.getTracks().forEach(t=>t.stop());
  }catch{}
  clearInterval(recTimer);
  $('#recStatus').textContent = 'stopped';
  $('#btnRec').disabled = false; $('#btnStop').disabled = true;
  logInfo('Stopping recorder…');
});

$('#inpAudio').addEventListener('change', (e)=>{
  const f = e.target.files?.[0];
  if (f){
    api.audioBlob = f;
    api.audioFilename = f.name;
    $('#audMeta').textContent = `Audio selected: ${f.name} (${fmtSize(f.size)})`;
    $('#btnUpload').disabled = !api.sessionId;
    logInfo(`Audio file selected: ${f.name} (${fmtSize(f.size)})`);
  }
});

/** ========================
 *  Image selection (multi)
 *  ======================== */
$('#inpPhotos').addEventListener('change', (e)=>{
  api.images = Array.from(e.target.files||[]);
  logInfo(`Selected ${api.images.length} image(s).`);
});

/** ========================
 *  Create session → Upload → Progress
 *  ======================== */
$('#btnCreate').addEventListener('click', async ()=>{
  const vendorId = $('#selVendor').value;
  const confId = $('#selConference').value;
  if (!vendorId || !confId){ alert('Pick a conference and a vendor first.'); return; }
  api.startTime = new Date().toISOString();
  try{
    const body = { vendor_id: vendorId, conference_id: confId, start_time: api.startTime };
    const j = await apiFetch('/api/mobile/sessions/create', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    api.sessionId = j.session_id || j.session?.id;
    $('#currentSession').textContent = `Session: ${api.sessionId || '(unknown)'}`;
    $('#btnUpload').disabled = false;
    logInfo(`Session created: ${api.sessionId}`);
  }catch(e){
    logErr(e.message);
    alert('Failed to create session. Check logs.');
  }
});

$('#btnUpload').addEventListener('click', async ()=>{
  if (!api.sessionId){ alert('Create a session first.'); return; }
  try{
    const fd = new FormData();
    // audio_files[]
    if (api.audioBlob){ fd.append('audio_files', api.audioBlob, api.audioFilename || 'audio.m4a'); }
    // image_files[]
    for (const img of api.images){ fd.append('image_files', img, img.name); }
    // notes
    const n = $('#txtNotes').value || '';
    if (n.trim()) fd.append('notes', n);

    const j = await apiFetch(`/api/sessions/${api.sessionId}/add-files`, { method:'POST', body: fd });
    logInfo(`Files uploaded to ${api.sessionId}.`);
    // Try enrichment (non-fatal)
    await tryEnrichment(api.sessionId);

    // Clear inputs after success
    $('#txtNotes').value = '';
    $('#inpPhotos').value = '';
    $('#inpAudio').value = '';
    api.images = []; api.audioBlob = null; api.audioFilename = null;
    $('#audMeta').textContent = '';
    logInfo('Inputs cleared (notes, photos, audio).');

    // Refresh vendor -> sessions
    await renderPastSessions(true);

  }catch(e){
    logErr(e.message);
    alert('Upload failed. See logs for details.');
  }
});

$('#btnRefresh').addEventListener('click', async ()=>{
  if (!api.sessionId){ alert('No session to check.'); return; }
  try{
    const j = await apiFetch(`/api/sessions/${api.sessionId}`);
    const s = j.data || j.session || {};
    const status = s.processing_status || s.status || 'unknown';
    logInfo(`Progress: ${status}`);
    alert(`Processing status: ${status}`);
  }catch(e){ logErr(e.message); }
});

async function tryEnrichment(id){
  // First attempt: /api/sessions/{id}/trigger-enrichment
  try{
    await apiFetch(`/api/sessions/${id}/trigger-enrichment`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})
    });
    logInfo('Enrichment triggered via primary endpoint.');
    return;
  }catch(e){
    // If 404, try mobile variant; if still not found, just log and continue.
    if (String(e.message).includes('404')) {
      logWarn('Primary enrichment route failed, trying mobile variant…');
      try{
        await apiFetch(`/api/mobile/sessions/${id}/trigger-enrichment`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({})
        });
        logInfo('Enrichment triggered via mobile endpoint.');
        return;
      }catch(e2){
        if (String(e2.message).includes('404')){
          logWarn('Enrichment trigger not available on this server.');
        } else {
          logWarn('Enrichment trigger error: ' + e2.message);
        }
      }
    } else {
      logWarn('Enrichment trigger error: ' + e.message);
    }
  }
}

/** ========================
 *  Past sessions area
 *  ======================== */
async function renderPastSessions(force=false){
  const vid = $('#selVendor').value;
  if (!vid) return;
  try{
    const j = await apiFetch(`/api/vendors/${vid}`);
    const v = j.data;
    const sessions = (v?.sessions)||[];
    $('#pastInfo').textContent = `${escapeHtml(v?.name||'')}: ${sessions.length} session(s)`;
    const list = $('#pastList'); list.innerHTML = '';
    if (!sessions.length){ list.innerHTML = `<div class="small">No sessions yet.</div>`; return; }
    for (const s of sessions.slice().reverse()){
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div><strong>${escapeHtml(v.name||'Vendor')}</strong> <span class="badge">${escapeHtml(s.processing_status||s.status||'unknown')}</span></div>
        <div class="small">Start: ${escapeHtml(s.start_time||'')}</div>
        <div class="small">Id: <span class="mono">${escapeHtml(s.id||'')}</span></div>
        <div class="flex" style="margin-top:8px">
          <button class="btn ghost" data-view="${s.id}">View</button>
        </div>
      `;
      div.querySelector('[data-view]').addEventListener('click', async ()=>{
        try{
          const j2 = await apiFetch(`/api/sessions/${s.id}`);
          alert(pretty(j2));
        }catch(e){ logErr(e.message); }
      });
      list.appendChild(div);
    }
  }catch(e){ logErr(e.message); }
}
$('#btnReloadSessions').addEventListener('click', ()=> renderPastSessions(true));

/** ========================
 *  Logs Drawer & Export
 *  ======================== */
function renderLogs(){
  const box = $('#logsContainer'); if (!box) return;
  box.innerHTML = '';
  const mode = api.logMode;
  for (const r of [...api.logs].reverse()){
    const el = document.createElement('div');
    el.className='logline mono';
    if (mode==='simple'){
      el.textContent = JSON.stringify(r);
    }else{
      el.innerHTML = `<div><span class="badge">${r.level}</span> <span class="small">${r.t}</span></div><pre class="mono" style="white-space:pre-wrap">${escapeHtml(r.msg)}${r.extra?`\n${escapeHtml(r.extra)}`:''}</pre>`;
    }
    box.appendChild(el);
  }
}
function exportTxt(){
  const blob = new Blob([api.logs.map(l=>JSON.stringify(l)).join('\n')], {type:'text/plain'});
  dl(blob, 'logs.txt');
}
function exportJson(){
  const blob = new Blob([JSON.stringify(api.logs,null,2)], {type:'application/json'});
  dl(blob, 'logs.json');
}
function dl(blob, name){
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

$('#openLogs').addEventListener('click', ()=> $('#drawer').classList.add('open'));
$('#btnClose').addEventListener('click', ()=> $('#drawer').classList.remove('open'));
$('#modeSimple').addEventListener('click', ()=>{ api.logMode='simple'; renderLogs();});
$('#modeVerbose').addEventListener('click', ()=>{ api.logMode='verbose'; renderLogs();});
$('#btnLogsSimple').addEventListener('click', ()=>{ api.logMode='simple'; renderLogs();});
$('#btnLogsVerbose').addEventListener('click', ()=>{ api.logMode='verbose'; renderLogs();});
$('#btnExportTxt').addEventListener('click', exportTxt);
$('#btnExportJson').addEventListener('click', exportJson);

/** ========================
 *  Helpers
 *  ======================== */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function fmtSize(b){ if (!b && b!==0) return ''; const u=['B','KB','MB','GB']; let i=0; let v=b; while(v>1024&&i<u.length-1){v/=1024;i++;} return `${v.toFixed(2)} ${u[i]}`; }
function pretty(o){ try{return JSON.stringify(o,null,2);}catch{return String(o);} }

/** ========================
 *  Wire up
 *  ======================== */
$('#btnSave').addEventListener('click', saveCreds);
$('#btnReset').addEventListener('click', resetCreds);
loadCreds();
</script>
</body>
</html>
