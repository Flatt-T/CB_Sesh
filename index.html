<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Conference Buddy ‚Äî Session Recorder</title>
<style>
  :root{
    --bg:#0a1020;--bg2:#0f1a33;--fg:#e6eefc;--muted:#9bb3e0;
    --accent:#3b82f6;--accent2:#60a5fa;--danger:#ef4444;--ok:#10b981;
    --card:#0c1428;--border:#1f2a44;--panel:#0b152c;
    --light:#f7faff;--light-fg:#0b1220;--light-border:#d7e3ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#071028);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding-top:86px}
  header{position:fixed;left:0;right:0;top:0;z-index:50;background:linear-gradient(180deg,rgba(10,16,32,.98),rgba(10,16,32,.90));backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
  .hbar{display:flex;align-items:center;justify-content:space-between;padding:8px 10px}
  .brand{display:flex;gap:10px;align-items:center}
  .badge{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;background:#0b1a3a;color:#c5d7ff}
  .chip{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:4px 10px;color:#b9caf2}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-end;padding:8px 10px;border-top:1px solid var(--border);background:linear-gradient(180deg,rgba(12,20,40,.9),rgba(12,20,40,.85))}
  .wrap{max-width:740px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px}
  .section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
  .section h2{margin:0 0 8px;font-size:16px;color:#d7e5ff}
  button,input,select,textarea{width:100%;padding:14px;border-radius:14px;border:1px solid var(--border);background:var(--bg2);color:#e6eefc}
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,var(--accent),var(--accent2));border:none;color:#fff;font-weight:700}
  button.ghost{background:transparent;border:1px solid var(--border)}
  button.danger{background:var(--danger);border:none;color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  label{font-size:12px;color:var(--muted);display:block;margin:6px 0}
  small.muted{color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:480px){.grid2{grid-template-columns:1fr}}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 12px;background:#0d2048;border:1px solid var(--border);border-radius:999px;color:#bcd1ff;font-size:12px}
  .status{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px;max-height:40vh;overflow:auto}
  .thumb{width:92px;height:92px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
  .thumbwrap{position:relative}
  .removebtn{position:absolute;top:4px;right:4px;background:#0008;border:1px solid var(--border);color:#fff;border-radius:999px;padding:2px 6px;font-size:12px}
  .preview{display:flex;gap:8px;flex-wrap:wrap}

  /* Modal (dialog-less) */
  .modal{position:fixed;inset:0;z-index:80;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);padding:14px}
  .modal[open]{display:flex}
  .modal-card{background:var(--light);color:var(--light-fg);border:1px solid var(--light-border);border-radius:18px;padding:14px;min-width:60vw;max-width:980px;max-height:80vh;overflow:auto}
  .modal h2{margin:0 0 8px}
  .modal .row button,.modal input,.modal select,.modal textarea{background:#f2f6ff;border-color:#cfd8ee;color:#0b1220}
  .modal .primary{background:linear-gradient(180deg,#2563eb,#60a5fa);color:#fff;border:none}
  .modal .ghost{background:#fff;border:1px solid #cfd8ee;color:#0b1220}
  .modal pre{background:#eef3ff;border:1px solid #cfd8ee;border-radius:12px;padding:10px;white-space:pre-wrap}
</style>
</head>
<body>
<header>
  <div class="hbar">
    <div class="brand"><strong>Conference Buddy ‚Äî Recorder</strong><span class="badge">mobile</span></div>
    <span id="apiStatus" class="chip">Disconnected</span>
  </div>
  <div class="toolbar">
    <button id="btnOpenAuth" class="ghost" type="button">API</button>
    <button id="btnLogs" class="ghost" type="button">Logs</button>
    <button id="btnSelfTest" class="ghost" type="button">Self-Test</button>
  </div>
</header>

<main class="wrap" id="app">
  <section class="section">
    <h2>Session Recorder</h2>
    <div class="grid2">
      <div>
        <label>Conference</label>
        <div class="row">
          <select id="confSelect" aria-label="Conference"></select>
          <button id="btnAddConf" class="ghost" type="button">+ New</button>
        </div>
        <small class="muted">Optional; blank ‚áí ‚ÄúUnknown Conference‚Äù.</small>
      </div>
      <div>
        <label>Vendor</label>
        <div class="row">
          <select id="vendorSelect" aria-label="Vendor"></select>
          <button id="btnAddVendor" class="ghost" type="button">+ New</button>
        </div>
        <small class="muted">Optional; blank ‚áí ‚ÄúUnknown Vendor‚Äù.</small>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="btnStart" class="primary" type="button">‚ñ∂ Start (audio begins)</button>
      <button id="btnStop" class="danger" type="button" disabled>‚ñ† Stop & Upload</button>
      <button id="btnPrevious" class="ghost" type="button">üìú Previous Sessions</button>
    </div>

    <div class="row" style="margin-top:8px">
      <span class="pill">Audio: <strong id="pillAudio">idle</strong></span>
      <span class="pill">Images: <strong id="pillImages">0</strong></span>
      <span class="pill">Session ID: <strong id="pillSession">‚Äî</strong></span>
    </div>

    <div style="margin-top:8px">
      <label>Notes</label>
      <textarea id="notes" rows="6" placeholder="Type notes here‚Ä¶ (saved as user_notes on upload)"></textarea>
    </div>

    <div style="margin-top:8px">
      <label>Photos</label>
      <input id="imageInput" type="file" accept="image/*" capture="environment" multiple/>
      <div id="imagePreview" class="preview"><small class="muted">Tap to add; remove with √ó.</small></div>
    </div>
  </section>

  <section class="section">
    <h2>Previous Sessions</h2>
    <div class="grid2">
      <div><label>Conference</label><select id="prevConf"></select></div>
      <div><label>Vendor</label><select id="prevVendor"></select></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnLoadSessions" class="ghost" type="button">Load</button>
    </div>
    <div id="prevList" style="margin-top:8px;display:grid;gap:8px"></div>
  </section>

  <section class="section">
    <h2>Status & Diagnostics</h2>
    <div id="status" class="status">Booting‚Ä¶</div>
  </section>
</main>

<!-- API Settings modal -->
<div id="authModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="authTitle">
  <div class="modal-card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 id="authTitle">API Settings</h2>
      <div class="row">
        <button id="btnTest" class="ghost" type="button">Test</button>
        <button id="btnSave" class="primary" type="button">Save</button>
        <button id="btnCloseAuth" class="ghost" type="button">Close</button>
      </div>
    </div>
    <label>Backend API Base URL</label>
    <input id="apiUrl" placeholder="https://conference-buddy-geoutils.replit.app/api"/>
    <div class="grid2">
      <div>
        <label>API Key</label>
        <input id="apiKey" type="password" placeholder="paste API key‚Ä¶"/>
      </div>
      <div>
        <label>Auth Mode</label>
        <select id="authMode">
          <option value="xapikey">Header: X-API-Key</option>
          <option value="bearer">Header: Authorization: Bearer</option>
          <option value="query">Query param (?apiKey=...)</option>
        </select>
      </div>
    </div>
    <div>
      <label>Query parameter name (when using Query mode)</label>
      <input id="authParam" placeholder="apiKey"/>
    </div>
    <p class="muted">We log exact URLs (keys redacted), headers, and a snippet of each response.</p>
  </div>
</div>

<!-- Logs modal -->
<div id="logsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="logsTitle">
  <div class="modal-card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 id="logsTitle">Diagnostics & Logs</h2>
      <div class="row">
        <select id="logVerbosity">
          <option value="compact">Compact</option>
          <option value="verbose">Verbose</option>
        </select>
        <button id="btnCopyLogs" class="ghost" type="button">Copy</button>
        <button id="btnDownloadTxt" class="ghost" type="button">.txt</button>
        <button id="btnDownloadJson" class="ghost" type="button">.json</button>
        <button id="btnCloseLogs" class="ghost" type="button">Close</button>
      </div>
    </div>
    <div id="logsView" class="status" style="min-height:260px;max-height:60vh;background:#eef3ff;color:#0b1220;border-color:#cfd8ee"></div>
  </div>
</div>

<!-- Self-Test modal -->
<div id="selfTestModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="selfTitle">
  <div class="modal-card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 id="selfTitle">API Self-Test Suite</h2>
      <div class="row">
        <button id="btnRunSelfTest" class="primary" type="button">Run Tests</button>
        <button id="btnCloseSelfTest" class="ghost" type="button">Close</button>
      </div>
    </div>
    <p class="muted">Runs OPTIONS/health/conferences/vendors/upload/enrich/report.</p>
    <div id="selfTestOutput" class="status" style="min-height:220px;max-height:60vh;background:#eef3ff;color:#0b1220;border-color:#cfd8ee"></div>
  </div>
</div>

<!-- Add Conference modal -->
<div id="confModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confTitle">
  <div class="modal-card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 id="confTitle">New Conference</h2>
      <button class="ghost" id="btnCloseConf" type="button">Close</button>
    </div>
    <label>Name</label><input id="newConfName" placeholder="e.g., DEF CON 33"/>
    <div class="grid2">
      <div><label>Start Date</label><input id="newConfStart" type="date"/></div>
      <div><label>End Date</label><input id="newConfEnd" type="date"/></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="btnCreateConf" class="primary" type="button">Create</button>
    </div>
  </div>
</div>

<!-- Add Vendor modal -->
<div id="vendorModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="vendTitle">
  <div class="modal-card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 id="vendTitle">New Vendor</h2>
      <button class="ghost" id="btnCloseVendor" type="button">Close</button>
    </div>
    <label>Vendor Name</label><input id="newVendorName" placeholder="e.g., Acme Robotics"/>
    <label>Link to Conference</label><select id="newVendorConf"></select>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="btnCreateVendor" class="primary" type="button">Create</button>
    </div>
  </div>
</div>

<!-- Session Detail modal -->
<div id="detailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
  <div class="modal-card" id="detailContainer"></div>
</div>

<script>
/* ========== Inlined API layer (stable) ========== */
(function(global){
  'use strict';
  const logs=[]; const listeners=new Set();
  function log(msg, level='info', extra=''){ const e={t:new Date().toISOString(),level,msg,extra}; logs.push(e); listeners.forEach(fn=>{try{fn(e);}catch{}}); }
  function onLog(fn){ listeners.add(fn); }
  function getLogs(){ return logs.slice(); }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  let CFG={ url:'', key:'', mode:'xapikey', param:'apiKey' };
  function saveCfg(){ try{ localStorage.setItem('cb_cfg', JSON.stringify(CFG)); }catch{} }
  function loadCfg(){ try{ const raw=localStorage.getItem('cb_cfg'); if(raw) CFG={...CFG, ...JSON.parse(raw)}; }catch{} } loadCfg();
  function setConfig({url,key,mode,param}){ if(url!==undefined) CFG.url=url; if(key!==undefined) CFG.key=key; if(mode!==undefined) CFG.mode=mode; if(param!==undefined) CFG.param=param||'apiKey'; saveCfg(); log('Config updated.'); }
  function getConfig(){ return {...CFG}; }
  function authHeadersAndUrl(u){ const headers={}; let url=u;
    if(CFG.mode==='xapikey'){ headers['X-API-Key']=CFG.key; }
    else if(CFG.mode==='bearer'){ headers['Authorization']='Bearer '+CFG.key; }
    else if(CFG.mode==='query'){ const sep=url.includes('?')?'&':'?'; url=`${url}${sep}${encodeURIComponent(CFG.param||'apiKey')}=${encodeURIComponent(CFG.key)}`; }
    return {headers,url};
  }
  async function req(method,path,{headers={},body,raw=false}={}){
    if(!CFG.url) throw new Error('API base URL not configured.');
    const base=CFG.url.replace(/\/+$/,''); let url=`${base}${path.startsWith('/')?'':'/'}${path}`;
    const auth=authHeadersAndUrl(url); url=auth.url; const h={...auth.headers,...headers};
    const id=Math.random().toString(36).slice(2,9); const started=performance.now();
    log(`HTTP ${method} ${url}`,'info','‚Üí request');
    log(JSON.stringify({id,method,url,reqHeaders:Object.fromEntries(Object.entries(h).map(([k,v])=>[k,k==='X-API-Key'?'***':v]))}));
    let res,text; try{ res=await fetch(url,{method,headers:h,body,mode:'cors'}); text=await res.text(); }catch(e){ log(`HTTP ${method} ${url}`,'error',`‚úñ Failed to fetch (${(performance.now()-started|0)}ms)`); throw e; }
    const dur=(performance.now()-started|0); let data=text; try{ data=text?JSON.parse(text):null; }catch{}
    log(`HTTP ${method} ${url}`,'info',`‚Üê ${res.status} ${(res.statusText||'')} (${dur}ms)`); log(JSON.stringify({id,dur:String(dur),status:res.status,resHeaders:Object.fromEntries(res.headers.entries()),body:raw?text:(typeof data==='string'?data:JSON.stringify(data))}));
    if(!res.ok){ const err=new Error(`HTTP ${res.status} ${res.statusText||''} ‚Äî ${typeof data==='string'?data:JSON.stringify(data)}`); err.status=res.status; err.data=data; throw err; }
    return raw?text:data;
  }

  async function testConnectivity(){ try{ const {url}=authHeadersAndUrl(CFG.url.replace(/\/+$/,'')+'/conferences'); log(`HTTP OPTIONS ${url}`,'info','‚Üí request'); const res=await fetch(url,{method:'OPTIONS'}); log(`HTTP OPTIONS ${url}`,'info',`‚Üê ${res.status} ${(res.statusText||'')}`);}catch{} await req('GET','/health'); await listConferences(); }
  async function listConferences(){ const r=await req('GET','/conferences'); if(Array.isArray(r)) return r; if(r?.data&&Array.isArray(r.data)) return r.data; return []; }
  async function listVendorsForConference(confId){ const r=await req('GET',`/conferences/${encodeURIComponent(confId)}/vendors`); if(Array.isArray(r)) return r; if(r?.data&&Array.isArray(r.data)) return r.data; return []; }
  async function listAllVendors(){ const r=await req('GET','/vendors'); if(Array.isArray(r)) return r; if(r?.data&&Array.isArray(r.data)) return r.data; return []; }
  async function createConference({name,start_date,end_date}){ const r=await req('POST','/conferences',{headers:{'Content-Type':'application/json'},body:JSON.stringify({name,start_date,end_date})}); return r?.data||r; }
  async function createVendor({name,conference_id}){ const r=await req('POST','/vendors',{headers:{'Content-Type':'application/json'},body:JSON.stringify({name,conference_id})}); return r?.data||r; }
  async function ensureConferenceVendor({conferenceId,vendorId,preferredVendorName='Unknown Vendor'}){
    if(!conferenceId){ const sd=todayISO(); const conf=await createConference({name:'Unknown Conference',start_date:sd,end_date:sd}); conferenceId=conf?.id??conf?._id??conf?.uuid; log(`Created fallback conference: ${conferenceId}`); }
    if(!vendorId){ const vendor=await createVendor({name:preferredVendorName||'Unknown Vendor',conference_id:conferenceId}); vendorId=vendor?.id??vendor?._id??vendor?.uuid; log(`Created fallback vendor: ${vendorId}`); }
    return {conferenceId,vendorId};
  }
  async function listSessionsForVendor(vendorId){ const r=await req('GET',`/vendors/${encodeURIComponent(vendorId)}`); if(r?.data?.sessions&&Array.isArray(r.data.sessions)) return r.data.sessions; if(Array.isArray(r?.sessions)) return r.sessions; if(Array.isArray(r)) return r; return []; }
  async function getSession(sessionId){ const r=await req('GET',`/sessions/${encodeURIComponent(sessionId)}`); return r?.data||r; }
  async function getSessionReport(sessionId){ const r=await req('GET',`/sessions/${encodeURIComponent(sessionId)}/report`); return r?.data||r; }

  async function uploadSession({audioBlob,images=[],text='',conferenceId,vendorId,startIso,endIso}){
    const path='/sessions/upload';
    const toB64=blob=>new Promise((resolve,reject)=>{ const r=new FileReader(); r.onloadend=()=>resolve(String(r.result).split(',')[1]||''); r.onerror=reject; r.readAsDataURL(blob); });

    // 1) JSON (recommended)
    try{
      const audio_base64 = audioBlob ? await toB64(audioBlob) : '';
      const images_base64 = []; for(const f of (images||[])) images_base64.push(await toB64(f));
      const payload = {
        conference_id: conferenceId||'',
        vendor_id: vendorId||'',
        start_time: startIso||new Date().toISOString(),
        end_time: endIso||startIso||new Date().toISOString(),
        session_type: 'conversation',
        user_notes: text||'',
        audio_base64, images_base64
      };
      const r=await req('POST',path,{headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const sid=r?.data?.id||r?.id||r?.session_id||r?.sessionId;
      try{ if(sid) await req('POST',`/sessions/${encodeURIComponent(sid)}/enrich`);}catch(e){ log('Enrich trigger failed (non-fatal): '+e.message,'warn'); }
      return sid||'(unknown)';
    }catch(e){ log(`JSON upload failed: ${e.message}. Falling back to multipart‚Ä¶`,'warn'); }

    // 2) Multipart (do not set Content-Type)
    const form=new FormData();
    form.append('conference_id',conferenceId||'');
    form.append('vendor_id',vendorId||'');
    form.append('start_time',startIso||new Date().toISOString());
    form.append('end_time',endIso||startIso||new Date().toISOString());
    form.append('session_type','conversation');
    if(text) form.append('user_notes',text);
    if(audioBlob){ const audioName=`audio.${(audioBlob?.type||'audio/webm').includes('mp4')?'mp4':'webm'}`; form.append('audio',audioBlob,audioName); }
    (images||[]).forEach((f,i)=> form.append('images',f,f.name||`photo_${i+1}.jpg`));

    const {headers,url}=authHeadersAndUrl(CFG.url.replace(/\/+$/,'')+path);
    const id=Math.random().toString(36).slice(2,9);
    log(`HTTP POST ${url}`,'info','‚Üí request');
    const res=await fetch(url,{method:'POST',headers,body:form,mode:'cors'});
    const textRes=await res.text(); let data=textRes; try{ data=textRes?JSON.parse(textRes):null; }catch{}
    log(`HTTP POST ${url}`,'info',`‚Üê ${res.status} ${(res.statusText||'')}`); log(JSON.stringify({id,status:res.status,resHeaders:Object.fromEntries(res.headers.entries()),body:typeof data==='string'?data:JSON.stringify(data)}));
    if(!res.ok){ const err=new Error((typeof data==='string'?data:JSON.stringify(data))||('HTTP '+res.status)); err.status=res.status; err.data=data; throw err; }
    const sid=data?.data?.id||data?.id||data?.session_id||data?.sessionId;
    try{ if(sid) await req('POST',`/sessions/${encodeURIComponent(sid)}/enrich`);}catch(e){ log('Enrich trigger failed (non-fatal): '+e.message,'warn'); }
    return sid||'(unknown)';
  }

  async function runSelfTest(){
    const out=[]; const push=s=>{out.push(s);log(s);};
    try{
      try{ const {url}=authHeadersAndUrl(CFG.url.replace(/\/+$/,'')+'/conferences'); push(`OPTIONS ${url} ‚Üí starting`); const res=await fetch(url,{method:'OPTIONS'}); push(`OPTIONS ${url} ‚Üê ${res.status}`);}catch(e){ push(`OPTIONS failed: ${e.message}`); }
      await req('GET','/health'); push('GET /health ‚úì');
      const confs=await listConferences(); push(`GET /conferences ‚úì (${confs.length})`);
      const sd=todayISO(); const conf=await createConference({name:'SelfTest '+sd,start_date:sd,end_date:sd}); const cid=conf?.id??conf?._id??conf?.uuid; push(`POST /conferences ‚úì (${cid||'unknown'})`);
      const vendor=await createVendor({name:'SelfVendor',conference_id:cid}); const vid=vendor?.id??vendor?._id??vendor?.uuid; push(`POST /vendors ‚úì (${vid||'unknown'})`);
      const blob=new Blob([new Uint8Array(500)],{type:'audio/webm'});
      const sid=await uploadSession({audioBlob:blob,images:[],text:'self-test user_notes',conferenceId:cid,vendorId:vid,startIso:new Date().toISOString(),endIso:new Date().toISOString()});
      push(`POST /sessions/upload ‚úì (${sid||'unknown'})`);
      try{ await req('POST',`/sessions/${encodeURIComponent(sid||'')}/enrich`); push('POST /sessions/{id}/enrich ‚úì'); }catch(e){ push('enrich warn: '+e.message); }
      try{ await getSessionReport(sid||''); push('GET /sessions/{id}/report ‚úì'); }catch(e){ push('report warn: '+e.message); }
    }catch(e){ push(`‚úñ Self-Test failed: ${e.message}`); throw e; }
    return out;
  }

  global.CBAPI={ onLog,getLogs,log,setConfig,getConfig,todayISO,testConnectivity,
    listConferences,listVendorsForConference,listAllVendors,
    createConference,createVendor,ensureConferenceVendor,
    listSessionsForVendor,getSession,getSessionReport,uploadSession,runSelfTest };
})(window);
</script>

<script>
/* ========== App (UI) ========== */
(function(){
  'use strict';

  // Loud surfacing of errors in the Status panel
  window.addEventListener('error', e=>{
    const box=document.getElementById('status');
    if(box) box.textContent += '\n[FATAL] ' + (e.message||e.error?.message||'script error');
  });
  window.addEventListener('unhandledrejection', e=>{
    const box=document.getElementById('status');
    if(box) box.textContent += '\n[UNHANDLED] ' + (e.reason?.message || String(e.reason));
  });

  // Simple modal util
  const $ = id => document.getElementById(id);
  function openModal(el){ el?.setAttribute('open',''); }
  function closeModal(el){ el?.removeAttribute('open'); }
  function downloadBlob(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); }
  function appendStatus(line){ const s=$('status'); s.textContent += (s.textContent?'\n':'') + line; s.scrollTop=s.scrollHeight; }

  document.addEventListener('DOMContentLoaded', ()=>{
    if(!window.CBAPI){ appendStatus('API layer failed to load.'); return; }
    const api = window.CBAPI;

    // Elements
    const els = {
      apiStatus: $('apiStatus'),
      // toolbar
      btnOpenAuth: $('btnOpenAuth'), btnLogs: $('btnLogs'), btnSelfTest: $('btnSelfTest'),
      // modals
      authModal: $('authModal'), logsModal: $('logsModal'), selfTestModal: $('selfTestModal'),
      confModal: $('confModal'), vendorModal: $('vendorModal'), detailModal: $('detailModal'),
      // auth fields
      apiUrl: $('apiUrl'), apiKey: $('apiKey'), authMode: $('authMode'), authParam: $('authParam'),
      btnSave: $('btnSave'), btnTest: $('btnTest'), btnCloseAuth: $('btnCloseAuth'),
      // logs
      logsView: $('logsView'), logVerbosity: $('logVerbosity'),
      btnCopyLogs: $('btnCopyLogs'), btnDownloadTxt: $('btnDownloadTxt'), btnDownloadJson: $('btnDownloadJson'), btnCloseLogs: $('btnCloseLogs'),
      // self-test
      selfTestOutput: $('selfTestOutput'), btnRunSelfTest: $('btnRunSelfTest'), btnCloseSelfTest: $('btnCloseSelfTest'),
      // main UI
      confSelect: $('confSelect'), vendorSelect: $('vendorSelect'), btnAddConf: $('btnAddConf'), btnAddVendor: $('btnAddVendor'),
      imageInput: $('imageInput'), imagePreview: $('imagePreview'), notes: $('notes'),
      btnStart: $('btnStart'), btnStop: $('btnStop'), btnPrevious: $('btnPrevious'),
      prevConf: $('prevConf'), prevVendor: $('prevVendor'), btnLoadSessions: $('btnLoadSessions'), prevList: $('prevList'),
      pillAudio: $('pillAudio'), pillImages: $('pillImages'), pillSession: $('pillSession'),
      // create modals
      newConfName: $('newConfName'), newConfStart: $('newConfStart'), newConfEnd: $('newConfEnd'), btnCreateConf: $('btnCreateConf'), btnCloseConf: $('btnCloseConf'),
      newVendorName: $('newVendorName'), newVendorConf: $('newVendorConf'), btnCreateVendor: $('btnCreateVendor'), btnCloseVendor: $('btnCloseVendor'),
      // detail container
      detailContainer: $('detailContainer')
    };

    // Mirror logs to status + logs modal
    function renderLogs(){
      const verbose = els.logVerbosity.value==='verbose';
      const lines = api.getLogs().map(l => verbose ? JSON.stringify(l,null,2) : `${l.t} [${(l.level||'info').toUpperCase()}] ${l.msg}${l.extra?(' '+l.extra):''}`);
      els.logsView.textContent = lines.join('\n') || '(no logs yet)';
    }
    api.onLog(entry=>{
      const time = new Date(entry.t).toLocaleTimeString();
      appendStatus(`[${time}] [${(entry.level||'info').toUpperCase()}] ${entry.msg}${entry.extra?(' '+entry.extra):''}`);
      if(els.logsModal.hasAttribute('open') && els.logVerbosity.value==='verbose') renderLogs();
    });

    // Dropdown helpers
    function noneOption(sel,label='‚Äî None ‚Äî'){ const o=document.createElement('option'); o.value=''; o.textContent=label; sel.appendChild(o); }
    async function populateConfs(sel){
      const list = await api.listConferences(); sel.innerHTML=''; noneOption(sel);
      (list||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c.id??c._id??c.uuid; o.textContent=c.name||('Conference '+o.value); sel.appendChild(o); });
    }
    async function populateVendorsForConf(cid, sel){
      sel.innerHTML=''; noneOption(sel); if(!cid) return;
      try{
        const list = await api.listVendorsForConference(cid);
        (list||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v.id??v._id??v.uuid; o.textContent=v.name||('Vendor '+o.value); sel.appendChild(o); });
      }catch{
        const all = await api.listAllVendors();
        (all||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v.id??v._id??v.uuid; o.textContent=v.name||('Vendor '+o.value); sel.appendChild(o); });
      }
    }

    // Media handling
    let mediaStream=null, mediaRecorder=null, audioChunks=[], recording=false;
    let sessionStartIso=null, sessionEndIso=null;

    function resetRecording(){ audioChunks=[]; recording=false; sessionStartIso=null; sessionEndIso=null; els.pillAudio.textContent='idle'; els.pillSession.textContent='‚Äî'; }
    async function startRecording(){
      if(!navigator.mediaDevices?.getUserMedia) throw new Error('Media capture not supported on this device.');
      try{ mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true }); }catch{ throw new Error('Microphone permission denied.'); }
      const mime = MediaRecorder?.isTypeSupported?.('audio/webm;codecs=opus')?'audio/webm;codecs=opus':(MediaRecorder?.isTypeSupported?.('audio/mp4')?'audio/mp4':'audio/webm');
      mediaRecorder = new MediaRecorder(mediaStream,{ mimeType:mime });
      audioChunks=[];
      mediaRecorder.addEventListener('dataavailable', e=>{ if(e.data.size>0) audioChunks.push(e.data); });
      mediaRecorder.addEventListener('stop', ()=>{ try{ mediaStream.getTracks().forEach(t=>t.stop()); }catch{} });
      mediaRecorder.start(1000);
      recording=true; sessionStartIso=new Date().toISOString(); els.pillAudio.textContent='recording';
      api.log('Audio recording started.');
    }
    async function stopRecordingGetBlob(){
      if(!mediaRecorder||!recording) return null;
      const p=new Promise(r=> mediaRecorder.addEventListener('stop', r, { once:true }));
      mediaRecorder.stop(); api.log('Stopping recorder‚Ä¶'); await p;
      sessionEndIso=new Date().toISOString();
      const blob=new Blob(audioChunks,{ type: mediaRecorder.mimeType||'audio/webm' });
      api.log(`Audio captured: ${(blob.size/1024/1024).toFixed(2)} MB`);
      recording=false; return blob;
    }

    // Images
    let imageFiles=[];
    function renderImagePreview(){
      const wrap=els.imagePreview; wrap.innerHTML='';
      imageFiles.forEach((f,i)=>{
        const url=URL.createObjectURL(f);
        const w=document.createElement('div'); w.className='thumbwrap';
        const img=document.createElement('img'); img.src=url; img.className='thumb'; img.alt=f.name;
        const x=document.createElement('button'); x.className='removebtn'; x.type='button'; x.textContent='√ó';
        x.addEventListener('click',()=>{ imageFiles.splice(i,1); renderImagePreview(); });
        w.appendChild(img); w.appendChild(x); wrap.appendChild(w);
      });
      els.pillImages.textContent=String(imageFiles.length);
    }
    els.imageInput.addEventListener('change', e=>{ imageFiles=imageFiles.concat(Array.from(e.target.files||[])); renderImagePreview(); });

    // Previous sessions
    async function loadPrevious(confId,vendorId){
      const sessions=[];
      async function forVendor(vid){
        try{
          const list=await api.listSessionsForVendor(vid);
          const arr=Array.isArray(list)?list:(Array.isArray(list?.data)?list.data:[]);
          arr.forEach(s=>sessions.push(s));
        }catch(e){ api.log(`Error loading sessions for vendor ${vid}: ${e.message}`,'error'); }
      }
      if(vendorId) await forVendor(vendorId);
      else if(confId){
        const vendors=await api.listVendorsForConference(confId);
        for(const v of (Array.isArray(vendors)?vendors:(vendors?.data||[]))){
          const vid=v.id??v._id??v.uuid; if(vid) await forVendor(vid);
        }
      }else{
        const all=await api.listAllVendors();
        for(const v of (Array.isArray(all)?all:(all?.data||[]))){
          const vid=v.id??v._id??v.uuid; if(vid) await forVendor(vid);
        }
      }
      const list=els.prevList; list.innerHTML='';
      if(!sessions.length){ list.innerHTML='<div class="section"><em>No sessions found.</em></div>'; return; }
      for(const s of sessions){
        const sid=s.id??s.sessionId??s._id??s.uuid??'(unknown)';
        const status=s.status??s.state??'uploaded';
        const when=s.created_at||s.createdAt? new Date(s.created_at||s.createdAt).toLocaleString() : '';
        const div=document.createElement('div'); div.className='section';
        div.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
          <div><strong>Session ${sid}</strong> <span class="muted">‚Ä¢ ${status}${when?` ‚Ä¢ ${when}`:''}</span></div>
          <button class="ghost" data-sid="${sid}" type="button">Open</button></div>`;
        div.querySelector('button').addEventListener('click',()=>openSessionDetail(sid));
        list.appendChild(div);
      }
    }

    async function openSessionDetail(sessionId){
      let meta=null, report=null;
      try{ meta=await api.getSession(sessionId); }catch(e){ api.log('Error fetching session meta: '+e.message,'error'); }
      try{ report=await api.getSessionReport(sessionId); }catch(e){ api.log('Error fetching session report: '+e.message,'error'); }
      const files=(meta?.files||meta?.uploads||[]);
      const images=(report?.images||meta?.images||[]);
      const ocr=report?.imageOcr||report?.ocr||null;
      const transcript=report?.transcript||report?.transcription||null;
      const summary=report?.summary||null;
      const textField=meta?.user_notes||report?.user_notes||report?.notes||meta?.text||null;
      function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
      const imgHtml=(images&&images.length)?`<div class="preview">${images.map(u=>`<img src="${u}" class="thumb" alt="">`).join('')}</div>`:`<em class="muted">No images</em>`;
      const filesHtml=(files&&files.length)?`<ul>${files.map(f=>`<li><a href="${f.url||f.href||'#'}" target="_blank" rel="noopener">${f.name||f.filename||f.url||'file'}</a></li>`).join('')}</ul>`:`<em class="muted">No files</em>`;
      els.detailContainer.innerHTML=`
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 id="detailTitle" style="margin:0">Session ${sessionId}</h2>
          <button class="ghost" id="btnCloseDetail" type="button">Close</button>
        </div>
        <div class="grid2">
          <div class="section"><strong>Files</strong>${filesHtml}</div>
          <div class="section"><strong>Transcript</strong><pre>${transcript?esc(transcript):'‚Äî'}</pre></div>
        </div>
        <div class="section"><strong>Image OCR</strong><pre>${ocr?esc(typeof ocr==='string'?ocr:JSON.stringify(ocr,null,2)):'‚Äî'}</pre></div>
        <div class="section"><strong>Images</strong>${imgHtml}</div>
        <div class="grid2">
          <div class="section"><strong>Notes</strong><pre>${textField?esc(textField):'‚Äî'}</pre></div>
          <div class="section"><strong>Summary</strong><pre>${summary?esc(summary):'‚Äî'}</pre></div>
        </div>`;
      openModal(els.detailModal); $('btnCloseDetail').onclick=()=>closeModal(els.detailModal);
    }

    // Toolbar buttons
    els.btnOpenAuth.addEventListener('click', ()=>{
      const cfg=api.getConfig()||{url:'',key:'',mode:'xapikey',param:'apiKey'};
      els.apiUrl.value=cfg.url||''; els.apiKey.value=cfg.key||''; els.authMode.value=cfg.mode||'xapikey'; els.authParam.value=cfg.param||'apiKey';
      openModal(els.authModal);
    });
    els.btnCloseAuth.addEventListener('click', ()=> closeModal(els.authModal));
    els.btnSave.addEventListener('click', ()=>{
      const url=els.apiUrl.value.trim(), key=els.apiKey.value.trim(), mode=els.authMode.value, param=(els.authParam.value.trim()||'apiKey');
      if(!url||!key){ alert('Enter API base URL and API key.'); return; }
      api.setConfig({url,key,mode,param}); els.apiStatus.textContent='Connected'; closeModal(els.authModal); boot();
    });
    els.btnTest.addEventListener('click', async ()=>{ try{ await api.testConnectivity(); alert('Connection OK. Check Logs for details.'); }catch(e){ alert('Connection failed: '+e.message); } });

    // Logs modal
    function showLogs(){ renderLogs(); openModal(els.logsModal); }
    els.btnLogs.addEventListener('click', showLogs);
    els.btnCloseLogs.addEventListener('click', ()=> closeModal(els.logsModal));
    els.logVerbosity.addEventListener('change', renderLogs);
    els.btnCopyLogs.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(els.logsView.textContent||''); alert('Logs copied'); }catch{ alert('Copy failed. Select text and copy.'); } });
    els.btnDownloadTxt.addEventListener('click', ()=> downloadBlob('cb-logs.txt', new Blob([els.logsView.textContent||''], {type:'text/plain'})));
    els.btnDownloadJson.addEventListener('click', ()=> downloadBlob('cb-logs.json', new Blob([JSON.stringify(api.getLogs(),null,2)], {type:'application/json'})));

    // Self test modal
    els.btnSelfTest.addEventListener('click', ()=>{ els.selfTestOutput.textContent=''; openModal(els.selfTestModal); });
    els.btnCloseSelfTest.addEventListener('click', ()=> closeModal(els.selfTestModal));
    els.btnRunSelfTest.addEventListener('click', async ()=>{
      els.selfTestOutput.textContent='';
      try{ const out=await api.runSelfTest(); els.selfTestOutput.textContent=out.join('\n'); }
      catch(e){ els.selfTestOutput.textContent='‚úñ Self-Test failed: '+e.message+' ‚Äî check Logs.'; }
    });

    // Create dialogs
    els.btnAddConf.addEventListener('click', ()=> openModal(els.confModal));
    els.btnCloseConf.addEventListener('click', ()=> closeModal(els.confModal));
    els.btnAddVendor.addEventListener('click', async ()=>{ await populateConfs(els.newVendorConf); openModal(els.vendorModal); });
    els.btnCloseVendor.addEventListener('click', ()=> closeModal(els.vendorModal));

    els.btnCreateConf.addEventListener('click', async ()=>{
      try{
        const name=els.newConfName.value.trim(); if(!name) return alert('Enter a conference name.');
        const sd=els.newConfStart.value||api.todayISO(), ed=els.newConfEnd.value||sd;
        const created=await api.createConference({ name, start_date: sd, end_date: ed });
        api.log('Conference created: '+(created?.id||created?.name||'ok'));
        closeModal(els.confModal);
        await populateConfs(els.confSelect);
        const cid=created?.id??created?._id??created?.uuid; if(cid) els.confSelect.value=cid;
        await populateVendorsForConf(els.confSelect.value, els.vendorSelect);
      }catch(e){ alert('Create conference failed: '+e.message); }
    });

    els.btnCreateVendor.addEventListener('click', async ()=>{
      try{
        const name=els.newVendorName.value.trim(), confId=els.newVendorConf.value;
        if(!name||!confId) return alert('Enter vendor name and select a conference.');
        const created=await api.createVendor({ name, conference_id: confId });
        api.log('Vendor created: '+(created?.id||created?.name||'ok'));
        closeModal(els.vendorModal);
        if(els.confSelect.value) await populateVendorsForConf(els.confSelect.value, els.vendorSelect);
        const vid=created?.id??created?._id??created?.uuid; if(vid) els.vendorSelect.value=vid;
      }catch(e){ alert('Create vendor failed: '+e.message); }
    });

    els.confSelect.addEventListener('change', async ()=>{ await populateVendorsForConf(els.confSelect.value, els.vendorSelect); });

    // Start/Stop/Upload
    els.btnStart.addEventListener('click', async ()=>{
      if(!api.getConfig()?.url || !api.getConfig()?.key) return alert('Configure API first (top left API button).');
      els.btnStart.disabled=true; els.btnStop.disabled=false;
      try{ await startRecording(); api.log('Session started. Recording in progress.'); }
      catch(e){ els.btnStart.disabled=false; els.btnStop.disabled=true; alert('Cannot start recording: '+e.message); }
    });

    els.btnStop.addEventListener('click', async ()=>{
      els.btnStop.disabled=true;
      try{
        const audioBlob=await stopRecordingGetBlob();
        if(!audioBlob) throw new Error('No audio captured.');
        let conferenceId=els.confSelect.value||null;
        let vendorId=els.vendorSelect.value||null;
        ({ conferenceId, vendorId } = await api.ensureConferenceVendor({ conferenceId, vendorId, preferredVendorName:'Unknown Vendor' }));
        const sid = await api.uploadSession({
          audioBlob, images: imageFiles, text: els.notes.value,
          conferenceId, vendorId,
          startIso: sessionStartIso||new Date().toISOString(),
          endIso: sessionEndIso||sessionStartIso||new Date().toISOString()
        });
        els.pillSession.textContent=sid;
        alert('Uploaded! Session ID: '+sid+'\nEnrichment started.');
      }catch(e){ alert('Upload failed: '+e.message); }
      finally{
        els.btnStart.disabled=false; els.btnStop.disabled=true;
        imageFiles=[]; els.imagePreview.innerHTML=''; els.pillImages.textContent='0'; els.notes.value='';
        resetRecording();
      }
    });

    // Previous list
    els.btnPrevious.addEventListener('click', async ()=>{
      await populateConfs(els.prevConf);
      if(els.prevConf.value) await populateVendorsForConf(els.prevConf.value, els.prevVendor);
      document.querySelectorAll('h2')[1]?.scrollIntoView({behavior:'smooth'});
    });
    els.prevConf.addEventListener('change', async ()=>{ await populateVendorsForConf(els.prevConf.value, els.prevVendor); });
    els.btnLoadSessions.addEventListener('click', async ()=>{ await loadPrevious(els.prevConf.value||null, els.prevVendor.value||null); });

    // Boot
    async function boot(){
      try{
        const cfg=api.getConfig()||{ url:'https://conference-buddy-geoutils.replit.app/api', key:'', mode:'xapikey', param:'apiKey' };
        api.setConfig(cfg);
        els.apiStatus.textContent = cfg.key ? 'Connected' : 'Disconnected';
        await populateConfs(els.confSelect);
        if(els.confSelect.value) await populateVendorsForConf(els.confSelect.value, els.vendorSelect);
        await populateConfs(els.prevConf);
        if(els.prevConf.value) await populateVendorsForConf(els.prevConf.value, els.prevVendor);
        api.log('Dropdowns populated from API.');
        $('status').textContent='Ready.';
      }catch(e){
        api.log('Could not load initial data: '+e.message,'error');
        $('status').textContent='Error loading initial data. Open API & verify.';
      }
    }
    boot();
  });
})();
</script>
</body>
</html>
