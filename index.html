<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Conference Buddy ‚Äî Session Recorder</title>
<style>
  :root{
    --bg:#0a1020; --bg2:#0f1a33; --fg:#e6eefc; --muted:#9bb3e0;
    --accent:#3b82f6; --accent2:#60a5fa; --danger:#ef4444; --ok:#10b981;
    --card:#0c1428; --border:#1f2a44;
    --dialog-bg:#ffffff; --dialog-fg:#0b1220; --dialog-border:#d9e2f3;
    --selection:#1f2a44;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:linear-gradient(180deg,var(--bg),#071028);
    color:var(--fg);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    padding-top: 82px; /* space for fixed header + toolbar */
  }
  ::selection{background:var(--selection);color:#fff}
  a{color:var(--accent)}

  /* Header + Top Toolbar */
  header{
    position:fixed;left:0;right:0;top:0;z-index:60;
    background:linear-gradient(180deg,rgba(10,16,32,.98),rgba(10,16,32,.90));
    backdrop-filter:blur(8px); border-bottom:1px solid var(--border)
  }
  .hbar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px}
  .brand{display:flex;gap:10px;align-items:center}
  .brand strong{font-size:15px}
  .badge,.chip{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:5px 10px}
  .badge{background:#0b1a3a;color:#c5d7ff}.chip{color:#b9caf2}

  .toolbar{
    display:flex;gap:8px;align-items:center;justify-content:flex-end;
    padding:8px 10px; border-top:1px solid var(--border);
    background:linear-gradient(180deg,rgba(12,20,40,.9),rgba(12,20,40,.85));
  }
  .toolbar button{min-width:92px}

  .wrap{max-width:740px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px}

  /* Controls / Sections */
  button,input,select,textarea{width:100%;padding:14px;border-radius:14px;border:1px solid var(--border);background:var(--bg2);color:var(--fg);outline:none}
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,var(--accent),var(--accent2));border:none;color:#fff;font-weight:700}
  button.ghost{background:transparent;border:1px solid var(--border)}
  button.danger{background:var(--danger);border:none;color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  .section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
  .section h2{margin:.2rem 0 8px;font-size:16px;color:#d7e5ff}
  label{font-size:12px;color:#9bb3e0;display:block;margin:6px 0 6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:480px){ .grid2{grid-template-columns:1fr} }
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 12px;background:#0d2048;border:1px solid var(--border);border-radius:999px;color:#bcd1ff;font-size:12px}

  .status{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b152c;border:1px solid var(--border);border-radius:12px;padding:10px;max-height:40vh;overflow:auto}
  .thumb{width:92px;height:92px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
  .thumbwrap{position:relative}
  .removebtn{position:absolute;top:4px;right:4px;background:#0008;border:1px solid var(--border);color:#fff;border-radius:999px;padding:2px 6px;font-size:12px}
  .preview{display:flex;gap:8px;flex-wrap:wrap}

  /* Dialogs (white, readable) */
  dialog{border:none;border-radius:18px;padding:0;background:transparent;color:inherit}
  .dialog-card{
    background:var(--dialog-bg); color:var(--dialog-fg);
    border:1px solid var(--dialog-border);
    border-radius:18px; padding:14px; min-width:60vw; max-width:980px; max-height:80vh; overflow:auto;
    box-shadow:0 18px 50px rgba(0,0,0,.55)
  }
  .dialog-card h2{color:#0b1220}
  .dialog-card .muted{color:#485e8b}
  .dialog-toolbar{display:flex;gap:8px;justify-content:flex-end}
  .dialog-card input,.dialog-card select,.dialog-card textarea,.dialog-card button{
    background:#f2f6ff;border-color:#cfd8ee;color:#0b1220
  }
  .dialog-card button.primary{background:linear-gradient(180deg,#2563eb,#60a5fa);color:#fff;border:none}
  .dialog-card button.ghost{background:#fff;border:1px solid #cfd8ee;color:#0b1220}
  .dialog-status{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#eef3ff;border:1px solid #cfd8ee;border-radius:12px;padding:10px}
</style>
</head>
<body>
<header>
  <div class="hbar">
    <div class="brand">
      <strong>Conference Buddy ‚Äî Recorder</strong>
      <span class="badge">mobile ¬∑ dark/blue</span>
    </div>
    <span id="apiStatus" class="chip">Disconnected</span>
  </div>
  <div class="toolbar">
    <button id="btnOpenAuth" class="ghost">API</button>
    <button id="btnLogs" class="ghost" title="View & export logs">Logs</button>
    <button id="btnSelfTest" class="ghost" title="Run API self-test">Self-Test</button>
  </div>
</header>

<main class="wrap">
  <!-- Recorder -->
  <section class="section">
    <h2>Session Recorder</h2>

    <div class="grid2">
      <div>
        <label>Conference</label>
        <div class="row">
          <select id="confSelect" aria-label="Conference"></select>
          <button id="btnAddConf" class="ghost">+ New</button>
        </div>
        <small class="muted">Optional; blank ‚áí ‚ÄúUnknown Conference‚Äù.</small>
      </div>
      <div>
        <label>Vendor</label>
        <div class="row">
          <select id="vendorSelect" aria-label="Vendor"></select>
          <button id="btnAddVendor" class="ghost">+ New</button>
        </div>
        <small class="muted">Optional; blank ‚áí ‚ÄúUnknown Vendor‚Äù (scoped to chosen conference).</small>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="btnStart" class="primary">‚ñ∂ Start (audio begins)</button>
      <button id="btnStop" class="danger" disabled>‚ñ† Stop & Upload</button>
      <button id="btnPrevious" class="ghost">üìú Previous Sessions</button>
    </div>

    <div class="row" style="margin-top:8px">
      <span class="pill">Audio: <strong id="pillAudio">idle</strong></span>
      <span class="pill">Images: <strong id="pillImages">0</strong></span>
      <span class="pill">Session ID: <strong id="pillSession">‚Äî</strong></span>
    </div>

    <div style="margin-top:8px">
      <label>Notes</label>
      <textarea id="notes" placeholder="Type notes here‚Ä¶ (big handheld area)"></textarea>
    </div>

    <div style="margin-top:8px">
      <label>Photos</label>
      <input id="imageInput" type="file" accept="image/*" capture="environment" multiple />
      <div id="imagePreview" class="preview"></div>
      <small class="muted">Tap to add; remove with √ó.</small>
    </div>
  </section>

  <!-- Previous -->
  <section class="section">
    <h2>Previous Sessions</h2>
    <div class="grid2">
      <div><label>Conference</label><select id="prevConf"></select></div>
      <div><label>Vendor</label><select id="prevVendor"></select></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnLoadSessions" class="ghost">Load</button>
    </div>
    <div id="prevList" style="margin-top:8px;display:grid;gap:8px"></div>
  </section>

  <!-- Diagnostics -->
  <section class="section">
    <h2>Status & Diagnostics</h2>
    <div id="status" class="status">Ready.</div>
  </section>
</main>

<!-- API / Settings -->
<dialog id="authDialog"><div class="dialog-card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">API Settings</h2>
    <div class="dialog-toolbar">
      <button id="btnTest" class="ghost">Test</button>
      <button id="btnSave" class="primary">Save</button>
      <button id="btnCloseAuth" class="ghost">Close</button>
    </div>
  </div>
  <label>Backend API Base URL</label>
  <input id="apiUrl" placeholder="https://your-api-base" />
  <div class="grid2">
    <div>
      <label>API Key</label>
      <input id="apiKey" type="password" placeholder="paste API key‚Ä¶" />
    </div>
    <div>
      <label>Auth Mode</label>
      <select id="authMode">
        <option value="xapikey">Header: X-API-Key</option>
        <option value="bearer">Header: Authorization: Bearer</option>
        <option value="query">Query param (?apiKey=...)</option>
      </select>
    </div>
  </div>
  <div>
    <label>Query parameter name (when using Query mode)</label>
    <input id="authParam" placeholder="apiKey" />
  </div>
  <p class="muted">We log exact URLs (keys redacted), all headers, and body samples for each request.</p>
</div></dialog>

<!-- Logs -->
<dialog id="logsDialog"><div class="dialog-card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">Diagnostics & Logs</h2>
    <div class="row">
      <select id="logVerbosity">
        <option value="compact">Compact</option>
        <option value="verbose">Verbose</option>
      </select>
      <button id="btnCopyLogs" class="ghost">Copy</button>
      <button id="btnDownloadTxt" class="ghost">.txt</button>
      <button id="btnDownloadJson" class="ghost">.json</button>
      <button id="btnCloseLogs" class="ghost">Close</button>
    </div>
  </div>
  <div id="logsView" class="dialog-status" style="min-height:260px;max-height:60vh"></div>
</div></dialog>

<!-- Self-Test -->
<dialog id="selfTestDialog"><div class="dialog-card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">API Self-Test Suite</h2>
    <div class="row">
      <button id="btnRunSelfTest" class="primary">Run Tests</button>
      <button id="btnCloseSelfTest" class="ghost">Close</button>
    </div>
  </div>
  <p class="muted">Runs: OPTIONS, /health, list/create conference (JSON w/ dates), list/create vendor (JSON w/ conference_id), upload (multipart ‚Üí fallback JSON) with start/end/duration, enrich, fetch session/report.</p>
  <div id="selfTestOutput" class="dialog-status" style="min-height:220px;max-height:60vh"></div>
</div></dialog>

<!-- Add Conference -->
<dialog id="confDialog"><div class="dialog-card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">New Conference</h2>
    <button class="ghost" onclick="document.getElementById('confDialog').close()">Close</button>
  </div>
  <label>Name</label><input id="newConfName" placeholder="e.g., DEF CON 33" />
  <div class="grid2">
    <div><label>Start Date</label><input id="newConfStart" type="date" /></div>
    <div><label>End Date</label><input id="newConfEnd" type="date" /></div>
  </div>
  <div class="row" style="justify-content:flex-end;margin-top:8px">
    <button id="btnCreateConf" class="primary">Create</button>
  </div>
</div></dialog>

<!-- Add Vendor -->
<dialog id="vendorDialog"><div class="dialog-card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">New Vendor</h2>
    <button class="ghost" onclick="document.getElementById('vendorDialog').close()">Close</button>
  </div>
  <label>Vendor Name</label><input id="newVendorName" placeholder="e.g., Acme Robotics" />
  <label>Link to Conference</label><select id="newVendorConf"></select>
  <div class="row" style="justify-content:flex-end;margin-top:8px">
    <button id="btnCreateVendor" class="primary">Create</button>
  </div>
</div></dialog>

<!-- Session Detail -->
<dialog id="detailDialog"><div class="dialog-card" id="detailContainer"></div></dialog>

<script>
/* ================
   Core references
   ================ */
const els = {
  apiStatus: document.getElementById('apiStatus'),
  btnOpenAuth: document.getElementById('btnOpenAuth'),
  btnLogs: document.getElementById('btnLogs'),
  btnSelfTest: document.getElementById('btnSelfTest'),

  authDialog: document.getElementById('authDialog'),
  apiUrl: document.getElementById('apiUrl'),
  apiKey: document.getElementById('apiKey'),
  authMode: document.getElementById('authMode'),
  authParam: document.getElementById('authParam'),
  btnSave: document.getElementById('btnSave'),
  btnCloseAuth: document.getElementById('btnCloseAuth'),
  btnTest: document.getElementById('btnTest'),

  confSelect: document.getElementById('confSelect'),
  vendorSelect: document.getElementById('vendorSelect'),
  btnAddConf: document.getElementById('btnAddConf'),
  btnAddVendor: document.getElementById('btnAddVendor'),

  imageInput: document.getElementById('imageInput'),
  imagePreview: document.getElementById('imagePreview'),
  notes: document.getElementById('notes'),

  btnStart: document.getElementById('btnStart'),
  btnStop: document.getElementById('btnStop'),
  btnPrevious: document.getElementById('btnPrevious'),

  prevConf: document.getElementById('prevConf'),
  prevVendor: document.getElementById('prevVendor'),
  btnLoadSessions: document.getElementById('btnLoadSessions'),
  prevList: document.getElementById('prevList'),

  status: document.getElementById('status'),
  pillAudio: document.getElementById('pillAudio'),
  pillImages: document.getElementById('pillImages'),
  pillSession: document.getElementById('pillSession'),

  confDialog: document.getElementById('confDialog'),
  newConfName: document.getElementById('newConfName'),
  newConfStart: document.getElementById('newConfStart'),
  newConfEnd: document.getElementById('newConfEnd'),
  btnCreateConf: document.getElementById('btnCreateConf'),

  vendorDialog: document.getElementById('vendorDialog'),
  newVendorName: document.getElementById('newVendorName'),
  newVendorConf: document.getElementById('newVendorConf'),
  btnCreateVendor: document.getElementById('btnCreateVendor'),

  detailDialog: document.getElementById('detailDialog'),
  detailContainer: document.getElementById('detailContainer'),

  logsDialog: document.getElementById('logsDialog'),
  logsView: document.getElementById('logsView'),
  logVerbosity: document.getElementById('logVerbosity'),
  btnCopyLogs: document.getElementById('btnCopyLogs'),
  btnDownloadTxt: document.getElementById('btnDownloadTxt'),
  btnDownloadJson: document.getElementById('btnDownloadJson'),
  btnCloseLogs: document.getElementById('btnCloseLogs'),

  selfTestDialog: document.getElementById('selfTestDialog'),
  selfTestOutput: document.getElementById('selfTestOutput'),
  btnRunSelfTest: document.getElementById('btnRunSelfTest'),
  btnCloseSelfTest: document.getElementById('btnCloseSelfTest'),
};

/* =================
   Persistence
   ================= */
const store = {
  get api(){ return JSON.parse(localStorage.getItem('cb_api') || 'null'); },
  set api(v){ localStorage.setItem('cb_api', JSON.stringify(v)); },
  get unknown(){ return JSON.parse(localStorage.getItem('cb_unknown') || 'null'); },
  set unknown(v){ localStorage.setItem('cb_unknown', JSON.stringify(v)); },
};

/* =================
   Logging helpers
   ================= */
const LOG_CAP = 5000; let logBuffer = [];
function redactHeaders(headers){
  const safe = {...headers};
  if('X-API-Key' in safe) safe['X-API-Key'] = '***';
  if('Authorization' in safe) safe['Authorization'] = '***';
  return safe;
}
function redactUrlParam(url, paramName){
  try{ const u = new URL(url); if (u.searchParams.has(paramName)) u.searchParams.set(paramName, '***'); return u.toString(); }
  catch{ return url; }
}
function objFromHeaders(headers){ const o={}; try{ for(const [k,v] of headers.entries()) o[k]=v; }catch{} return o; }
function pushLog(entry){
  const now = new Date(); const item = { t: now.toISOString(), ...entry };
  logBuffer.push(item); if(logBuffer.length>LOG_CAP) logBuffer.shift();
  const label = (entry.level||'info').toUpperCase();
  const msg = entry.msg || ''; const extra = entry.extra ? ` ${entry.extra}` : '';
  const line = `[${now.toLocaleTimeString()}] [${label}] ${msg}${extra}`;
  els.status.textContent += (els.status.textContent ? '\n' : '') + line;
  els.status.scrollTop = els.status.scrollHeight;
  const fn = entry.level==='error'?'error':(entry.level==='warn'?'warn':'log'); console[fn](item);
}
function log(msg, level='info', extra=''){ pushLog({msg, level, extra}); }
function netStart({method, url, headers, paramName}){
  const id = Math.random().toString(36).slice(2,9);
  const start = performance.now();
  const urlRed = redactUrlParam(url, paramName);
  pushLog({ level:'info', msg:`HTTP ${method} ${urlRed}`, extra:'‚Üí request', id, method, url:urlRed, start, reqHeaders:redactHeaders(headers) });
  return { id, start, method, url, paramName };
}
function netEnd(ctx, res, bodySample){
  const dur = (performance.now()-ctx.start).toFixed(0);
  const h = objFromHeaders(res.headers||{});
  pushLog({ level:'info', msg:`HTTP ${ctx.method} ${redactUrlParam(ctx.url, ctx.paramName)}`, extra:`‚Üê ${res.status} ${res.statusText} (${dur}ms)`, id:ctx.id, dur, status:res.status, resHeaders:h, body: bodySample });
}
function netErr(ctx, err){
  const dur = (performance.now()-ctx.start).toFixed(0);
  pushLog({ level:'error', msg:`HTTP ${ctx.method} ${redactUrlParam(ctx.url, ctx.paramName)}`, extra:`‚úñ ${err.message} (${dur}ms)`, id:ctx.id, dur, error:String(err) });
  if (String(err).includes('Failed to fetch')) log('Hint: CORS preflight blocked by browser. Confirm server CORS & allowed headers.', 'warn');
}
function showLogs(){
  const verbose = els.logVerbosity.value === 'verbose';
  const text = logBuffer.map(l=> verbose ? JSON.stringify(l, null, 2) : `${l.t} [${(l.level||'info').toUpperCase()}] ${l.msg}${l.extra?(' '+l.extra):''}`).join('\n');
  els.logsView.textContent = text || '(no logs yet)';
}

/* =================
   Fetch wrapper
   ================= */
function joinUrl(base, path){ return base.replace(/\/+$/,'') + (path.startsWith('/')? path : '/'+path); }
function addQuery(url, kv){ const u = new URL(url); for(const [k,v] of Object.entries(kv)) if (v!=null && v!=='') u.searchParams.set(k, v); return u.toString(); }
function buildAuthHeaders(mode, key){ const h={}; if(mode==='bearer') h['Authorization']=`Bearer ${key}`; else if(mode==='xapikey') h['X-API-Key']=key; return h; }
function applyAuthToUrl(url, mode, key, paramName){ return mode==='query' ? addQuery(url, {[paramName]: key}) : url; }

async function apiFetch(path, opts={}){
  const cfg = store.api; if(!cfg?.url) throw new Error('Missing API base URL. Open API Settings.');
  const method = (opts.method || 'GET').toUpperCase();
  const mode = cfg.mode || 'xapikey'; const key = cfg.key || ''; const paramName = cfg.param || 'apiKey';
  const baseUrl = joinUrl(cfg.url, path); const url = applyAuthToUrl(baseUrl, mode, key, paramName);
  const headers = { ...(opts.headers||{}), ...buildAuthHeaders(mode, key) };
  if (opts.body && typeof opts.body === 'string' && !headers['Content-Type']) headers['Content-Type'] = 'application/json';

  const ctx = netStart({ method, url, headers, paramName });
  try{
    const res = await fetch(url, { method, headers, body: opts.body || undefined, mode:'cors', credentials:'omit' });
    const ct = (res.headers.get('content-type') || '').toLowerCase();

    let bodySample = null;
    try{
      if (ct.includes('application/json')) bodySample = JSON.stringify(await res.clone().json()).slice(0,2000);
      else if (ct.includes('text/')) bodySample = (await res.clone().text()).slice(0,2000);
      else { const blob = await res.clone().blob(); bodySample = `[blob ${blob.type||'application/octet-stream'} ${blob.size} bytes]`; }
    }catch{}

    netEnd(ctx, res, bodySample);
    if(!res.ok){ const err = new Error(`HTTP ${res.status} ${res.statusText}${bodySample ? ' ‚Äî ' + bodySample : ''}`); err.status=res.status; err.body = bodySample||''; throw err; }
    if(ct.includes('application/json')) return res.json();
    return res.blob();
  }catch(e){
    // Upload fallback (multipart -> JSON) when server demands JSON
    if ((e?.status === 415 || (e?.status === 500 && String(e.body||'').includes('Unsupported Media Type'))) && opts.body instanceof FormData) {
      try {
        const asJson = await formDataToJsonPayload(opts.body);
        log('Server rejected multipart for /sessions/upload. Retrying with JSON payload (base64 + timing)‚Ä¶','warn');
        return await apiFetch(path, { ...opts, body: JSON.stringify(asJson) });
      } catch(re){ log('Retry-as-JSON failed to construct payload: ' + re.message, 'error'); }
    }
    netErr(ctx, e); throw e;
  }
}

/* =================
   Shapes / helpers
   ================= */
function asArray(maybe){
  if (Array.isArray(maybe)) return maybe;
  if (maybe && typeof maybe === 'object') {
    if (Array.isArray(maybe.data)) return maybe.data;
    if (Array.isArray(maybe.items)) return maybe.items;
  }
  return [];
}
function escapeHtml(str){ return str.replace(/[&<>"']/g,s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }
function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10); }

/* =================
   File JSON fallback
   ================= */
function readBlobAsDataURL(blob){
  return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onerror=()=>reject(new Error('FileReader error')); r.onload=()=>resolve(String(r.result||'')); r.readAsDataURL(blob); });
}
async function formDataToJsonPayload(fd){
  const payload = { images: [], audio: null };
  const plain = {};
  for (const [k, v] of fd.entries()){
    if (v instanceof Blob){
      const isAudio = k.toLowerCase().includes('audio');
      const dataUrl = await readBlobAsDataURL(v);
      const [meta, b64] = dataUrl.split(',', 2);
      const contentType = (meta.match(/^data:(.*?);base64$/)||[])[1] || (v.type||'application/octet-stream');
      const fileObj = { filename: (v.name||('file.'+(contentType.split('/')[1]||'bin'))), content_type: contentType, data: b64 };
      if (isAudio) payload.audio = fileObj; else payload.images.push(fileObj);
    } else {
      plain[k] = v;
    }
  }
  // carry across known text fields (include snake & camel for compat)
  const confId = plain.conference_id || plain.conferenceId || '';
  const vendId = plain.vendor_id || plain.vendorId || '';
  const text  = plain.text || plain.notes || ''; // map notes -> text
  const st     = plain.start_time || plain.startTime || '';
  const et     = plain.end_time || plain.endTime || '';
  const dur    = plain.duration_seconds || plain.durationSeconds || '';

  if (confId){ payload.conference_id = confId; payload.conferenceId = confId; }
  if (vendId){ payload.vendor_id = vendId; payload.vendorId = vendId; }
  if (text){ payload.text = text; } // do not send payload.notes
  if (st){ payload.start_time = st; payload.startTime = st; }
  if (et){ payload.end_time = et; payload.endTime = et; }
  if (dur){ payload.duration_seconds = dur; payload.durationSeconds = dur; }

  return payload;
}

/* =================
   Dropdowns
   ================= */
async function loadConferences(selectEl){
  const resp = await apiFetch('/conferences'); const list = asArray(resp);
  selectEl.innerHTML = '';
  for(const c of list){
    const opt = document.createElement('option');
    opt.value = c.id ?? c._id ?? c.uuid ?? c.conferenceId;
    opt.textContent = c.name ?? c.title ?? (`Conference ${opt.value}`);
    selectEl.appendChild(opt);
  }
}
async function loadVendorsForConference(confId, selectEl){
  selectEl.innerHTML = ''; if(!confId) return;
  try{
    const resp = await apiFetch(`/conferences/${encodeURIComponent(confId)}/vendors`);
    const list = asArray(resp);
    for(const v of list){
      const opt = document.createElement('option');
      opt.value = v.id ?? v._id ?? v.uuid ?? v.vendorId;
      opt.textContent = v.name ?? (`Vendor ${opt.value}`);
      selectEl.appendChild(opt);
    }
  }catch(e){
    log(`Warn: couldn't load vendors for conference ‚Äî ${e.message}. Falling back to /vendors`, 'warn');
    const resp = await apiFetch('/vendors');
    const list = asArray(resp);
    for(const v of list){
      const opt = document.createElement('option');
      opt.value = v.id ?? v._id ?? v.uuid ?? v.vendorId;
      opt.textContent = v.name ?? (`Vendor ${opt.value}`);
      selectEl.appendChild(opt);
    }
  }
}

/* ================================
   Ensure conference & vendor exist
   ================================ */
async function getOrCreateUnknownConference(){
  try{
    const conferences = await apiFetch('/conferences');
    const list = asArray(conferences);
    const unk = (list||[]).find(c => (c.name||'').toLowerCase() === 'unknown conference');
    if(unk) return (unk.id ?? unk._id ?? unk.uuid ?? unk.conferenceId);
  }catch(e){ log('Could not list conferences while searching for Unknown Conference: '+e.message,'warn'); }
  const payload = { name: 'Unknown Conference', start_date: todayISO(), end_date: todayISO() };
  const created = await apiFetch('/conferences', { method:'POST', body: JSON.stringify(payload) });
  const cid = created?.id ?? created?._id ?? created?.uuid ?? created?.conferenceId;
  log(`Created Unknown Conference: ${cid}`);
  return cid;
}

async function getOrCreateVendorByName(conferenceId, name){
  try{
    const vendors = await apiFetch(`/conferences/${encodeURIComponent(conferenceId)}/vendors`);
    const list = asArray(vendors);
    const found = (list||[]).find(v => (v.name||'').toLowerCase() === (name||'').toLowerCase());
    if(found) return (found.id ?? found._id ?? found.uuid ?? found.vendorId);
  }catch(e){ log(`Could not list vendors for conference ${conferenceId}: `+e.message,'warn'); }
  const created = await apiFetch('/vendors', { method:'POST', body: JSON.stringify({ name, conference_id: conferenceId }) });
  const vid = created?.id ?? created?._id ?? created?.uuid ?? created?.vendorId;
  log(`Created Vendor "${name}" for conference ${conferenceId}: ${vid}`);
  return vid;
}

async function ensureConferenceVendor({conferenceId, vendorId, preferredVendorName}){
  if(!conferenceId){
    conferenceId = await getOrCreateUnknownConference();
  }
  if(vendorId){
    try{
      const v = await apiFetch(`/vendors/${encodeURIComponent(vendorId)}`);
      const vcid = v?.conference_id ?? v?.conferenceId ?? null;
      if (vcid && conferenceId && String(vcid) !== String(conferenceId)) {
        log(`Vendor ${vendorId} belongs to a different conference (${vcid} != ${conferenceId}). Creating scoped vendor.`, 'warn');
        vendorId = await getOrCreateVendorByName(conferenceId, preferredVendorName || 'Unknown Vendor');
      }
    }catch(e){
      log(`Provided vendor ID ${vendorId} not found. Creating vendor instead.`, 'warn');
      vendorId = await getOrCreateVendorByName(conferenceId, preferredVendorName || 'Unknown Vendor');
    }
  } else {
    vendorId = await getOrCreateVendorByName(conferenceId, preferredVendorName || 'Unknown Vendor');
  }
  return { conferenceId, vendorId };
}

/* =================
   Recording
   ================= */
let mediaStream=null, mediaRecorder=null, audioChunks=[], recording=false;
let sessionStartIso=null, sessionEndIso=null;

function resetRecording(){
  audioChunks=[]; recording=false;
  sessionStartIso=null; sessionEndIso=null;
  els.pillAudio.textContent='idle'; els.pillSession.textContent='‚Äî';
}
async function startRecording(){
  try{ mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true }); }
  catch(err){ throw new Error('Microphone permission denied or unavailable.'); }
  const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':
               MediaRecorder.isTypeSupported('audio/mp4')?'audio/mp4':'audio/webm';
  mediaRecorder = new MediaRecorder(mediaStream,{ mimeType:mime });
  audioChunks=[];
  mediaRecorder.addEventListener('dataavailable', e=>{ if(e.data.size>0) audioChunks.push(e.data); });
  mediaRecorder.addEventListener('stop', ()=>{ mediaStream.getTracks().forEach(t=>t.stop()); });
  mediaRecorder.start(1000);
  recording=true;
  sessionStartIso = new Date().toISOString();
  els.pillAudio.textContent='recording';
  log('Audio recording started.');
}
async function stopRecordingGetBlob(){
  if(!mediaRecorder || !recording) return null;
  const stopped = new Promise(resolve=> mediaRecorder.addEventListener('stop', resolve, { once:true }));
  mediaRecorder.stop(); log('Stopping recorder‚Ä¶'); await stopped;
  sessionEndIso = new Date().toISOString();
  const blob = new Blob(audioChunks,{ type: mediaRecorder.mimeType || 'audio/webm' });
  log(`Audio captured: ${(blob.size/1024/1024).toFixed(2)} MB`);
  recording=false;
  return blob;
}

/* =================
   Images (dynamic)
   ================= */
let imageFiles = [];
function renderImagePreview(){
  const preview = els.imagePreview; preview.innerHTML = '';
  imageFiles.forEach((f, idx)=>{
    const url = URL.createObjectURL(f);
    const wrap = document.createElement('div'); wrap.className='thumbwrap';
    const img = document.createElement('img'); img.src=url; img.className='thumb'; img.alt = f.name;
    const btn = document.createElement('button'); btn.className='removebtn'; btn.type='button'; btn.textContent='√ó';
    btn.addEventListener('click', ()=>{ imageFiles.splice(idx,1); renderImagePreview(); });
    wrap.appendChild(img); wrap.appendChild(btn); preview.appendChild(wrap);
  });
  els.pillImages.textContent = String(imageFiles.length);
}
els.imageInput.addEventListener('change', (e)=>{ imageFiles = imageFiles.concat(Array.from(e.target.files || [])); renderImagePreview(); });

/* =================
   Upload & Enrich
   ================= */
function secondsBetweenISO(startIso, endIso){
  try{ const a = new Date(startIso).getTime(); const b = new Date(endIso).getTime(); return Math.max(0, Math.round((b-a)/1000)); }catch{ return 0; }
}

async function uploadSession({audioBlob, images, notes, conferenceId, vendorId}){
  // Ensure vendor exists for the resolved conference (avoid 404 Vendor not found)
  const ensured = await ensureConferenceVendor({ conferenceId, vendorId });
  conferenceId = ensured.conferenceId; vendorId = ensured.vendorId;

  const startIso = sessionStartIso || new Date().toISOString();
  const endIso   = sessionEndIso   || startIso;
  const duration = secondsBetweenISO(startIso, endIso);

  // 1) Try multipart first
  const fd = new FormData();
  if(audioBlob) fd.append('audio', audioBlob, `session.${(audioBlob.type.split('/')[1]||'webm').split(';')[0]}`);
  for(const f of images){ fd.append('images', f, f.name); }
  if(notes) fd.append('text', notes); // backend expects `text`, not `notes`

  // IDs (both cases)
  fd.append('conference_id', conferenceId); fd.append('conferenceId', conferenceId);
  fd.append('vendor_id', vendorId);         fd.append('vendorId', vendorId);

  // Timing metadata (both cases)
  fd.append('start_time', startIso); fd.append('startTime', startIso);
  fd.append('end_time', endIso);     fd.append('endTime', endIso);
  fd.append('duration_seconds', String(duration)); fd.append('durationSeconds', String(duration));

  try{
    const res = await apiFetch('/sessions/upload', { method:'POST', body: fd });
    const sessionId = res.id ?? res.sessionId ?? res._id ?? res.uuid;
    if(!sessionId) throw new Error('Upload succeeded but response did not include a session ID.');
    log(`Uploaded. Session ID: ${sessionId}`); els.pillSession.textContent = sessionId;
    try{ await apiFetch(`/sessions/${encodeURIComponent(sessionId)}/enrich`, { method:'POST' }); log('Enrichment triggered.'); }
    catch(e){ log(`Warning: could not trigger enrichment automatically ‚Äî ${e.message}`,'warn'); }
    return sessionId;
  }catch(err){
    const hint = String(err.body||err.message||'');
    const isMediaTypeComplaint = err.status === 415 || (err.status === 500 && hint.includes('Unsupported Media Type'));
    if (!isMediaTypeComplaint) throw err;

    log('Server rejected multipart for /sessions/upload. Retrying with JSON payload (base64 + timing)‚Ä¶','warn');
    const jsonPayload = await formDataToJsonPayload(fd); // maps notes->text automatically
    const res = await apiFetch('/sessions/upload', { method:'POST', body: JSON.stringify(jsonPayload) });
    const sessionId = res.id ?? res.sessionId ?? res._id ?? res.uuid;
    if(!sessionId) throw new Error('Upload (JSON) succeeded but response did not include a session ID.');
    log(`Uploaded (JSON). Session ID: ${sessionId}`); els.pillSession.textContent = sessionId;
    try{ await apiFetch(`/sessions/${encodeURIComponent(sessionId)}/enrich`, { method:'POST' }); log('Enrichment triggered.'); }
    catch(e){ log(`Warning: could not trigger enrichment automatically ‚Äî ${e.message}`,'warn'); }
    return sessionId;
  } finally {
    resetRecording();
  }
}

/* =================
   Previous sessions
   ================= */
async function loadPrevious(conferenceId, vendorId){
  const sessions = [];
  async function forVendor(vid){
    try{
      const list = await apiFetch(`/vendors/${encodeURIComponent(vid)}/sessions`);
      (Array.isArray(list)?list:asArray(list)).forEach(s=> sessions.push(s));
    }catch(e){ log(`Error loading sessions for vendor ${vid}: ${e.message}`,'error'); }
  }
  if(vendorId) await forVendor(vendorId);
  else if(conferenceId){
    const vendors = await apiFetch(`/conferences/${encodeURIComponent(conferenceId)}/vendors`);
    for(const v of asArray(vendors)){ const vid = v.id ?? v._id ?? v.vendorId ?? v.uuid; if(vid) await forVendor(vid); }
  }else{
    const allV = await apiFetch('/vendors');
    for(const v of asArray(allV)){ const vid = v.id ?? v._id ?? v.vendorId ?? v.uuid; if(vid) await forVendor(vid); }
  }

  els.prevList.innerHTML = '';
  if(!sessions.length){ els.prevList.innerHTML = `<div class="section"><em>No sessions found.</em></div>`; return; }
  for(const s of sessions){
    const sid = s.id ?? s.sessionId ?? s._id ?? s.uuid ?? '(unknown)';
    const status = s.status ?? s.state ?? 'uploaded';
    const when = s.created_at || s.createdAt ? new Date(s.created_at||s.createdAt).toLocaleString() : '';
    const div = document.createElement('div'); div.className='section';
    div.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <div><strong>Session ${sid}</strong> <span class="muted">‚Ä¢ ${status}${when?` ‚Ä¢ ${when}`:''}</span></div>
        <button class="ghost" data-sid="${sid}">Open</button>
      </div>`;
    div.querySelector('button').addEventListener('click', ()=> openSessionDetail(sid));
    els.prevList.appendChild(div);
  }
}

async function openSessionDetail(sessionId){
  let meta=null, report=null;
  try{ meta = await apiFetch(`/sessions/${encodeURIComponent(sessionId)}`); }
  catch(e){ log(`Error fetching session meta: ${e.message}`,'error'); }
  try{ report = await apiFetch(`/reports/session/${encodeURIComponent(sessionId)}`); }
  catch(e){ log(`Error fetching session report: ${e.message}`,'error'); }

  const files = (meta?.files||meta?.uploads||[]);
  const images = (report?.images || meta?.images || []);
  const ocr = report?.imageOcr || report?.ocr || null;
  const transcript = report?.transcript || report?.transcription || null;
  const summary = report?.summary || null;
  const textField = meta?.text || meta?.notes || report?.notes || null; // display stored text

  const imgHtml = (images && images.length) ? `<div class="preview">${images.map(u=>`<img src="${u}" class="thumb" alt="image">`).join('')}</div>` : `<em class="muted">No images</em>`;
  const filesHtml = (files && files.length) ? `<ul>${files.map(f=>`<li><a href="${f.url||f.href||'#'}" target="_blank" rel="noopener">${f.name||f.filename||f.url||'file'}</a></li>`).join('')}</ul>` : `<em class="muted">No files</em>`;

  els.detailContainer.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Session ${sessionId}</h2>
      <button class="ghost" onclick="document.getElementById('detailDialog').close()">Close</button>
    </div>
    <div class="grid2">
      <div class="section"><strong>Files</strong>${filesHtml}</div>
      <div class="section"><strong>Transcript</strong><pre class="status" style="max-height:180px">${transcript ? escapeHtml(String(transcript)) : '‚Äî'}</pre></div>
    </div>
    <div class="section"><strong>Image OCR</strong><pre class="status" style="max-height:180px">${ocr ? escapeHtml(typeof ocr==='string'? ocr : JSON.stringify(ocr,null,2)) : '‚Äî'}</pre></div>
    <div class="section"><strong>Images</strong>${imgHtml}</div>
    <div class="grid2">
      <div class="section"><strong>Notes</strong><pre class="status" style="max-height:140px">${textField ? escapeHtml(String(textField)) : '‚Äî'}</pre></div>
      <div class="section"><strong>Summary</strong><pre class="status" style="max-height:140px">${summary ? escapeHtml(String(summary)) : '‚Äî'}</pre></div>
    </div>`;
  els.detailDialog.showModal();
}

/* =================
   Self-test suite
   ================= */
function writeSelf(msg){ els.selfTestOutput.textContent += (els.selfTestOutput.textContent?'\n':'') + msg; }
function mkSilentWav(seconds=1, sampleRate=8000){
  const numSamples = seconds * sampleRate, bytesPerSample=2, blockAlign=1*bytesPerSample, byteRate=sampleRate*blockAlign, dataSize=numSamples*bytesPerSample;
  const buf = new ArrayBuffer(44 + dataSize); const dv = new DataView(buf); let o=0;
  function w32(v){ dv.setUint32(o, v, true); o+=4; } function w16(v){ dv.setUint16(o, v, true); o+=2; } function ws(s){ for(let i=0;i<s.length;i++) dv.setUint8(o++, s.charCodeAt(i)); }
  ws('RIFF'); w32(36 + dataSize); ws('WAVE'); ws('fmt '); w32(16); w16(1); w16(1); w32(sampleRate); w32(byteRate); w16(blockAlign); w16(16); ws('data'); w32(dataSize);
  return new Blob([buf], { type:'audio/wav' });
}
async function runSelfTest(){
  els.selfTestOutput.textContent = '';
  try{
    const cfg = store.api;
    if(!cfg?.url || !cfg?.key) { writeSelf('‚úñ Missing URL or API key in settings.'); return; }
    writeSelf('‚Ä¢ Using base: ' + cfg.url);

    const optionsUrl = joinUrl(cfg.url, '/conferences');
    const ctx = netStart({method:'OPTIONS', url:optionsUrl, headers:{}, paramName:cfg.param||'apiKey'});
    const res = await fetch(optionsUrl, { method:'OPTIONS', mode:'cors', credentials:'omit' });
    const h = objFromHeaders(res.headers); netEnd(ctx, res, JSON.stringify(h).slice(0,1000));
    writeSelf(`OPTIONS /conferences ‚Üí ${res.status} (see Logs for headers)`);

    await apiFetch('/health'); writeSelf('GET /health ‚úì');

    const confs = await apiFetch('/conferences'); const confArr = asArray(confs);
    writeSelf(`GET /conferences ‚úì (${confArr.length} found)`);

    const cname = 'CB SelfTest ' + new Date().toISOString(); const today = todayISO();
    const cRes = await apiFetch('/conferences', { method:'POST', body: JSON.stringify({ name: cname, start_date: today, end_date: today }) });
    const cid = cRes.id ?? cRes._id ?? cRes.uuid ?? cRes.conferenceId; writeSelf(`POST /conferences ‚úì id=${cid}`);

    const vRes = await apiFetch('/vendors', { method:'POST', body: JSON.stringify({ name: 'CB SelfTest Vendor', conference_id: cid }) });
    const vid = vRes.id ?? vRes._id ?? vRes.uuid ?? vRes.vendorId; writeSelf(`POST /vendors ‚úì id=${vid}`);

    const st = new Date().toISOString();
    const silent = mkSilentWav(1,8000);
    const upload = new FormData();
    upload.append('audio', silent, 'selftest.wav');
    upload.append('text', 'Self-test upload ' + st); // use `text`
    upload.append('conference_id', cid); upload.append('conferenceId', cid);
    upload.append('vendor_id', vid);     upload.append('vendorId', vid);
    upload.append('start_time', st);     upload.append('startTime', st);
    upload.append('end_time', st);       upload.append('endTime', st);
    upload.append('duration_seconds', '1'); upload.append('durationSeconds','1');
    const sRes = await apiFetch('/sessions/upload', { method:'POST', body: upload });
    const sid = sRes.id ?? sRes._id ?? sRes.uuid ?? sRes.sessionId; writeSelf(`POST /sessions/upload ‚úì id=${sid}`);

    await apiFetch(`/sessions/${encodeURIComponent(sid)}/enrich`, { method:'POST' }); writeSelf('POST /sessions/{id}/enrich ‚úì (started)');
    await apiFetch(`/sessions/${encodeURIComponent(sid)}`); writeSelf('GET /sessions/{id} ‚úì');
    await apiFetch(`/reports/session/${encodeURIComponent(sid)}`); writeSelf('GET /reports/session/{id} ‚úì');

    writeSelf('‚úî Self-Test completed. See Logs (Verbose) for details.');
  }catch(e){
    writeSelf('‚úñ Self-Test failed: ' + e.message + ' ‚Äî check Logs for details.');
  }
}

/* =================
   Events & Boot
   ================= */
function setConnected(on){ els.apiStatus.textContent = on?'Connected':'Disconnected'; }

els.btnOpenAuth.addEventListener('click', ()=>{
  const cfg = store.api || { url:'https://conference-buddy-geoutils.replit.app/api', key:'', mode:'xapikey', param:'apiKey' };
  els.apiUrl.value = cfg.url || '';
  els.apiKey.value = cfg.key || '';
  els.authMode.value = cfg.mode || 'xapikey';
  els.authParam.value = cfg.param || 'apiKey';
  els.authDialog.showModal();
});
els.btnCloseAuth.addEventListener('click', ()=> els.authDialog.close());
els.btnSave.addEventListener('click', ()=>{
  const url = els.apiUrl.value.trim();
  const key = els.apiKey.value.trim();
  const mode = els.authMode.value;
  const param = (els.authParam.value.trim() || 'apiKey');
  if(!url || !key){ alert('Please enter API base URL and API key.'); return; }
  store.api = { url, key, mode, param };
  setConnected(true);
  els.authDialog.close();
  boot();
});
els.btnTest.addEventListener('click', async ()=>{
  try{
    const base = store.api?.url || els.apiUrl.value.trim();
    const url = joinUrl(base, '/conferences');
    const ctx = netStart({method:'OPTIONS', url, headers:{}, paramName:store.api?.param||'apiKey'});
    const res = await fetch(url, { method:'OPTIONS', mode:'cors', credentials:'omit' });
    netEnd(ctx, res, JSON.stringify(objFromHeaders(res.headers)).slice(0,1000));
    await apiFetch('/health'); await apiFetch('/conferences');
    alert('Connection OK (OPTIONS + GETs succeeded). Check Logs for details.');
  }catch(e){ alert('Connection failed: ' + e.message); }
});

els.btnLogs.addEventListener('click', ()=>{ showLogs(); els.logsDialog.showModal(); });
els.btnCloseLogs.addEventListener('click', ()=> els.logsDialog.close());
els.logVerbosity.addEventListener('change', showLogs);
els.btnCopyLogs.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(els.logsView.textContent || ''); alert('Logs copied'); } catch(_){ alert('Copy failed. Select text and copy.'); } });
function downloadBlob(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); }
els.btnDownloadTxt.addEventListener('click', ()=> downloadBlob('cb-logs.txt', new Blob([els.logsView.textContent||''], {type:'text/plain'})));
els.btnDownloadJson.addEventListener('click', ()=> downloadBlob('cb-logs.json', new Blob([JSON.stringify(logBuffer,null,2)], {type:'application/json'})));

els.btnSelfTest.addEventListener('click', ()=> { els.selfTestOutput.textContent=''; els.selfTestDialog.showModal(); });
els.btnCloseSelfTest.addEventListener('click', ()=> els.selfTestDialog.close());
els.btnRunSelfTest.addEventListener('click', runSelfTest);

els.btnAddConf.addEventListener('click', ()=> els.confDialog.showModal());
els.btnAddVendor.addEventListener('click', async ()=>{ await loadConferences(els.newVendorConf); els.vendorDialog.showModal(); });

els.btnCreateConf addEventListener('click', async ()=>{
  try{
    const name = els.newConfName.value.trim(); if(!name) return alert('Please enter a conference name.');
    const sd = els.newConfStart.value || todayISO(); const ed = els.newConfEnd.value || sd;
    const payload = { name, start_date: sd, end_date: ed };
    const created = await apiFetch('/conferences', { method:'POST', body: JSON.stringify(payload) });
    log('Conference created: ' + (created?.id || created?.name || 'ok'));
    els.confDialog.close();
    await loadConferences(els.confSelect);
    const cid = created?.id ?? created?._id ?? created?.uuid ?? created?.conferenceId;
    if(cid) els.confSelect.value = cid;
    await loadVendorsForConference(els.confSelect.value, els.vendorSelect);
  }catch(e){ alert('Create conference failed: ' + e.message); }
});
els.btnCreateVendor.addEventListener('click', async ()=>{
  try{
    const name = els.newVendorName.value.trim(); const confId = els.newVendorConf.value;
    if(!name || !confId) return alert('Enter vendor name and select a conference.');
    const created = await apiFetch('/vendors', { method:'POST', body: JSON.stringify({ name, conference_id: confId }) });
    log('Vendor created: ' + (created?.id || created?.name || 'ok'));
    els.vendorDialog.close();
    if(els.confSelect.value) await loadVendorsForConference(els.confSelect.value, els.vendorSelect);
    const vid = created?.id ?? created?._id ?? created?.uuid ?? created?.vendorId;
    if(vid) els.vendorSelect.value = vid;
  }catch(e){ alert('Create vendor failed: ' + e.message); }
});

els.confSelect.addEventListener('change', async ()=>{ await loadVendorsForConference(els.confSelect.value, els.vendorSelect); });

els.imageInput.addEventListener('change', (e)=>{ imageFiles = imageFiles.concat(Array.from(e.target.files || [])); renderImagePreview(); });

els.btnStart.addEventListener('click', async ()=>{
  if(!store.api){ return alert('Configure API first.'); }
  els.btnStart.disabled = true; els.btnStop.disabled = false;
  try{ await startRecording(); log('Session started. Recording in progress.'); }
  catch(e){ els.btnStart.disabled=false; els.btnStop.disabled=true; alert('Cannot start recording: ' + e.message); }
});
els.btnStop.addEventListener('click', async ()=>{
  els.btnStop.disabled = true;
  try{
    const audioBlob = await stopRecordingGetBlob();
    if(!audioBlob) throw new Error('No audio captured.');

    let conferenceId = els.confSelect.value || null;
    let vendorId = els.vendorSelect.value || null;

    // Ensure vendor exists for chosen/unknown conference
    const ensured = await ensureConferenceVendor({ conferenceId, vendorId });
    conferenceId = ensured.conferenceId; vendorId = ensured.vendorId;

    const sessionId = await uploadSession({
      audioBlob, images: imageFiles, notes: els.notes.value,
      conferenceId, vendorId
    });
    alert('Uploaded! Session ID: ' + sessionId + '\nEnrichment started.');
  }catch(e){ alert('Upload failed: ' + e.message); }
  finally{
    els.btnStart.disabled = false; imageFiles = []; renderImagePreview(); els.notes.value='';
  }
});

els.btnPrevious.addEventListener('click', async ()=>{
  await loadConferences(els.prevConf);
  if(els.prevConf.value) await loadVendorsForConference(els.prevConf.value, els.prevVendor);
  document.querySelectorAll('h2')[1]?.scrollIntoView({behavior:'smooth'});
});

/* Closeable dialogs with Esc */
for(const d of [els.authDialog, els.confDialog, els.vendorDialog, els.detailDialog, els.logsDialog, els.selfTestDialog]){
  d?.addEventListener('cancel', e=>{ e.preventDefault(); d.close(); });
}

/* Boot */
async function boot(){
  if(!store.api){
    store.api = {
      url: 'https://conference-buddy-geoutils.replit.app/api',
      key: '', mode: 'xapikey', param: 'apiKey'
    };
  }
  const cfg = store.api;
  if(cfg){
    setConnected(true);
    try{
      await loadConferences(els.confSelect);
      if(els.confSelect.value) await loadVendorsForConference(els.confSelect.value, els.vendorSelect);
      await loadConferences(els.prevConf);
      if(els.prevConf.value) await loadVendorsForConference(els.prevConf.value, els.prevVendor);
      log('Dropdowns populated from API.');
      if(!els.confSelect.options.length) log('No conferences yet. You can record without selecting; we‚Äôll use ‚ÄúUnknown Conference‚Äù.', 'warn');
    }catch(e){ log('Could not load initial data: ' + e.message, 'error'); }
  }else{
    setConnected(false);
    els.authDialog.showModal();
  }
}
boot();
</script>
</body>
</html>
