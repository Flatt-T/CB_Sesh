<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Conference Buddy ‚Äî Session Recorder</title>
<style>
  :root{
    --bg:#0a1020;--bg2:#0f1a33;--fg:#e6eefc;--muted:#9bb3e0;
    --accent:#3b82f6;--accent2:#60a5fa;--danger:#ef4444;--ok:#10b981;
    --card:#0c1428;--border:#1f2a44;--dialog-bg:#ffffff;--dialog-fg:#0b1220;--dialog-border:#d9e2f3;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#071028);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding-top:82px}
  ::selection{background:#1f2a44;color:#fff}
  a{color:var(--accent)}
  header{position:fixed;left:0;right:0;top:0;z-index:60;background:linear-gradient(180deg,rgba(10,16,32,.98),rgba(10,16,32,.90));backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
  .hbar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px}
  .brand{display:flex;gap:10px;align-items:center}
  .chip,.badge{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:5px 10px}
  .badge{background:#0b1a3a;color:#c5d7ff}
  .chip{color:#b9caf2}
  .toolbar{display:flex;gap:8px;align-items:center;justify-content:flex-end;padding:8px 10px;border-top:1px solid var(--border);background:linear-gradient(180deg,rgba(12,20,40,.9),rgba(12,20,40,.85))}
  .toolbar button{min-width:90px}
  .wrap{max-width:740px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px}
  button,input,select,textarea{width:100%;padding:14px;border-radius:14px;border:1px solid var(--border);background:var(--bg2);color:#e6eefc;outline:none}
  button{cursor:pointer} button.primary{background:linear-gradient(180deg,var(--accent),var(--accent2));border:none;color:#fff;font-weight:700}
  button.ghost{background:transparent;border:1px solid var(--border)} button.danger{background:var(--danger);border:none;color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  .section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
  .section h2{margin:.2rem 0 8px;font-size:16px;color:#d7e5ff}
  label{font-size:12px;color:#9bb3e0;display:block;margin:6px 0 6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media(max-width:480px){.grid2{grid-template-columns:1fr}}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 12px;background:#0d2048;border:1px solid var(--border);border-radius:999px;color:#bcd1ff;font-size:12px}
  .status{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b152c;border:1px solid var(--border);border-radius:12px;padding:10px;max-height:40vh;overflow:auto}
  .thumb{width:92px;height:92px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
  .thumbwrap{position:relative}
  .removebtn{position:absolute;top:4px;right:4px;background:#0008;border:1px solid var(--border);color:#fff;border-radius:999px;padding:2px 6px;font-size:12px}
  .preview{display:flex;gap:8px;flex-wrap:wrap}
  dialog{border:none;border-radius:18px;padding:0;background:transparent;color:inherit}
  .dialog-card{background:var(--dialog-bg);color:var(--dialog-fg);border:1px solid var(--dialog-border);border-radius:18px;padding:14px;min-width:60vw;max-width:980px;max-height:80vh;overflow:auto;box-shadow:0 18px 50px rgba(0,0,0,.55)}
  .dialog-card h2{color:#0b1220}
  .dialog-toolbar{display:flex;gap:8px;justify-content:flex-end}
  .dialog-card input,.dialog-card select,.dialog-card textarea,.dialog-card button{background:#f2f6ff;border-color:#cfd8ee;color:#0b1220}
  .dialog-card button.primary{background:linear-gradient(180deg,#2563eb,#60a5fa);color:#fff;border:none}
  .dialog-card button.ghost{background:#fff;border:1px solid #cfd8ee;color:#0b1220}
  .dialog-status{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#eef3ff;border:1px solid #cfd8ee;border-radius:12px;padding:10px}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <div class="hbar">
    <div class="brand"><strong>Conference Buddy ‚Äî Recorder</strong><span class="badge">mobile</span></div>
    <span id="apiStatus" class="chip">Disconnected</span>
  </div>
  <div class="toolbar">
    <button id="btnOpenAuth" class="ghost">API</button>
    <button id="btnLogs" class="ghost">Logs</button>
    <button id="btnSelfTest" class="ghost">Self-Test</button>
  </div>
</header>

<main class="wrap">
  <section class="section">
    <h2>Session Recorder</h2>
    <div class="grid2">
      <div>
        <label>Conference</label>
        <div class="row">
          <select id="confSelect" aria-label="Conference"></select>
          <button id="btnAddConf" class="ghost">+ New</button>
        </div>
        <small class="muted">Optional; blank ‚áí ‚ÄúUnknown Conference‚Äù.</small>
      </div>
      <div>
        <label>Vendor</label>
        <div class="row">
          <select id="vendorSelect" aria-label="Vendor"></select>
          <button id="btnAddVendor" class="ghost">+ New</button>
        </div>
        <small class="muted">Optional; blank ‚áí ‚ÄúUnknown Vendor‚Äù.</small>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="btnStart" class="primary">‚ñ∂ Start (audio begins)</button>
      <button id="btnStop" class="danger" disabled>‚ñ† Stop & Upload</button>
      <button id="btnPrevious" class="ghost">üìú Previous Sessions</button>
    </div>

    <div class="row" style="margin-top:8px">
      <span class="pill">Audio: <strong id="pillAudio">idle</strong></span>
      <span class="pill">Images: <strong id="pillImages">0</strong></span>
      <span class="pill">Session ID: <strong id="pillSession">‚Äî</strong></span>
    </div>

    <div style="margin-top:8px">
      <label>Notes</label>
      <textarea id="notes" placeholder="Type notes here‚Ä¶"></textarea>
    </div>

    <div style="margin-top:8px">
      <label>Photos</label>
      <input id="imageInput" type="file" accept="image/*" capture="environment" multiple/>
      <div id="imagePreview" class="preview"></div>
    </div>
  </section>

  <section class="section">
    <h2>Previous Sessions</h2>
    <div class="grid2">
      <div><label>Conference</label><select id="prevConf"></select></div>
      <div><label>Vendor</label><select id="prevVendor"></select></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnLoadSessions" class="ghost">Load</button>
    </div>
    <div id="prevList" style="margin-top:8px;display:grid;gap:8px"></div>
  </section>

  <section class="section">
    <h2>Status & Diagnostics</h2>
    <div id="status" class="status">Booting‚Ä¶</div>
  </section>
</main>

<!-- API Settings -->
<dialog id="authDialog"><div class="dialog-card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">API Settings</h2>
    <div class="dialog-toolbar">
      <button id="btnTest" class="ghost">Test</button>
      <button id="btnSave" class="primary">Save</button>
      <button id="btnCloseAuth" class="ghost">Close</button>
    </div>
  </div>
  <label>Backend API Base URL</label>
  <input id="apiUrl" placeholder="https://conference-buddy-geoutils.replit.app/api"/>
  <div class="grid2">
    <div>
      <label>API Key</label>
      <input id="apiKey" type="password" placeholder="paste API key‚Ä¶"/>
    </div>
    <div>
      <label>Auth Mode</label>
      <select id="authMode">
        <option value="xapikey">Header: X-API-Key</option>
        <option value="bearer">Header: Authorization: Bearer</option>
        <option value="query">Query param (?apiKey=...)</option>
      </select>
    </div>
  </div>
  <div>
    <label>Query parameter name (when in query mode)</label>
    <input id="authParam" placeholder="apiKey"/>
  </div>
  <p class="muted">We log URLs (keys redacted), headers, and a snippet of the response.</p>
</div></dialog>

<!-- Logs -->
<dialog id="logsDialog"><div class="dialog-card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">Diagnostics & Logs</h2>
    <div class="row">
      <select id="logVerbosity">
        <option value="compact">Compact</option>
        <option value="verbose">Verbose</option>
      </select>
      <button id="btnCopyLogs" class="ghost">Copy</button>
      <button id="btnDownloadTxt" class="ghost">.txt</button>
      <button id="btnDownloadJson" class="ghost">.json</button>
      <button id="btnCloseLogs" class="ghost">Close</button>
    </div>
  </div>
  <div id="logsView" class="dialog-status" style="min-height:260px;max-height:60vh"></div>
</div></dialog>

<!-- Self-Test -->
<dialog id="selfTestDialog"><div class="dialog-card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">API Self-Test Suite</h2>
    <div class="row">
      <button id="btnRunSelfTest" class="primary">Run Tests</button>
      <button id="btnCloseSelfTest" class="ghost">Close</button>
    </div>
  </div>
  <p class="muted">Runs OPTIONS/health/conferences/vendors/upload/enrich/report.</p>
  <div id="selfTestOutput" class="dialog-status" style="min-height:220px;max-height:60vh"></div>
</div></dialog>

<!-- Add Conference -->
<dialog id="confDialog"><div class="dialog-card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">New Conference</h2>
    <button class="ghost" onclick="window.__dlgClose(document.getElementById('confDialog'))">Close</button>
  </div>
  <label>Name</label><input id="newConfName" placeholder="e.g., DEF CON 33"/>
  <div class="grid2">
    <div><label>Start Date</label><input id="newConfStart" type="date"/></div>
    <div><label>End Date</label><input id="newConfEnd" type="date"/></div>
  </div>
  <div class="row" style="justify-content:flex-end;margin-top:8px">
    <button id="btnCreateConf" class="primary">Create</button>
  </div>
</div></dialog>

<!-- Add Vendor -->
<dialog id="vendorDialog"><div class="dialog-card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">New Vendor</h2>
    <button class="ghost" onclick="window.__dlgClose(document.getElementById('vendorDialog'))">Close</button>
  </div>
  <label>Vendor Name</label><input id="newVendorName" placeholder="e.g., Acme Robotics"/>
  <label>Link to Conference</label><select id="newVendorConf"></select>
  <div class="row" style="justify-content:flex-end;margin-top:8px">
    <button id="btnCreateVendor" class="primary">Create</button>
  </div>
</div></dialog>

<!-- Session Detail -->
<dialog id="detailDialog"><div class="dialog-card" id="detailContainer"></div></dialog>

<!-- API layer (non-module; cache-busted to avoid stale JS on Pages) -->
<script src="cb-api.js?v=4"></script>
<script>
(function () {
  'use strict';

  // Visible fatal error hooks so ‚ÄúUI not responding‚Äù is obvious on device
  window.addEventListener('error', e => {
    const s = document.getElementById('status');
    if (s) s.textContent += '\n[FATAL] ' + (e.message || e.error?.message || e.filename || 'script error');
  });
  window.addEventListener('unhandledrejection', e => {
    const s = document.getElementById('status');
    if (s) s.textContent += '\n[UNHANDLED] ' + (e.reason?.message || String(e.reason));
  });

  if (!window.CBAPI) { alert('cb-api.js failed to load'); return; }
  const api = window.CBAPI;

  // Dialog fallback
  function supportsDialog(){ const d=document.createElement('dialog'); return !!d.showModal; }
  function openDlg(d){ if(supportsDialog()) d.showModal(); else d.classList.remove('hidden'); }
  function closeDlg(d){ if(supportsDialog()) d.close(); else d.classList.add('hidden'); }
  window.__dlgClose = closeDlg;

  // Elements
  const $ = id => document.getElementById(id);
  const els = {
    apiStatus: $('apiStatus'), btnOpenAuth: $('btnOpenAuth'), btnLogs: $('btnLogs'), btnSelfTest: $('btnSelfTest'),
    authDialog: $('authDialog'), apiUrl: $('apiUrl'), apiKey: $('apiKey'), authMode: $('authMode'), authParam: $('authParam'),
    btnSave: $('btnSave'), btnCloseAuth: $('btnCloseAuth'), btnTest: $('btnTest'),
    confSelect: $('confSelect'), vendorSelect: $('vendorSelect'), btnAddConf: $('btnAddConf'), btnAddVendor: $('btnAddVendor'),
    imageInput: $('imageInput'), imagePreview: $('imagePreview'), notes: $('notes'),
    btnStart: $('btnStart'), btnStop: $('btnStop'), btnPrevious: $('btnPrevious'),
    prevConf: $('prevConf'), prevVendor: $('prevVendor'), btnLoadSessions: $('btnLoadSessions'), prevList: $('prevList'),
    status: $('status'), pillAudio: $('pillAudio'), pillImages: $('pillImages'), pillSession: $('pillSession'),
    confDialog: $('confDialog'), newConfName: $('newConfName'), newConfStart: $('newConfStart'), newConfEnd: $('newConfEnd'), btnCreateConf: $('btnCreateConf'),
    vendorDialog: $('vendorDialog'), newVendorName: $('newVendorName'), newVendorConf: $('newVendorConf'), btnCreateVendor: $('btnCreateVendor'),
    detailDialog: $('detailDialog'), detailContainer: $('detailContainer'),
    logsDialog: $('logsDialog'), logsView: $('logsView'), logVerbosity: $('logVerbosity'), btnCopyLogs: $('btnCopyLogs'), btnDownloadTxt: $('btnDownloadTxt'), btnDownloadJson: $('btnDownloadJson'), btnCloseLogs: $('btnCloseLogs'),
    selfTestDialog: $('selfTestDialog'), selfTestOutput: $('selfTestOutput'), btnRunSelfTest: $('btnRunSelfTest'), btnCloseSelfTest: $('btnCloseSelfTest')
  };

  // Status/log mirroring
  function appendStatus(line){
    els.status.textContent += (els.status.textContent?'\n':'') + line;
    els.status.scrollTop = els.status.scrollHeight;
  }
  api.onLog(entry=>{
    const time = new Date(entry.t).toLocaleTimeString();
    const lvl = (entry.level||'info').toUpperCase();
    appendStatus(`[${time}] [${lvl}] ${entry.msg}${entry.extra?(' '+entry.extra):''}`);
    if (els.logVerbosity.value==='verbose') renderLogs();
  });
  function renderLogs(){
    const verbose = els.logVerbosity.value==='verbose';
    const text = api.getLogs().map(l=> verbose? JSON.stringify(l,null,2) : `${l.t} [${(l.level||'info').toUpperCase()}] ${l.msg}${l.extra?(' '+l.extra):''}`).join('\n');
    els.logsView.textContent = text || '(no logs yet)';
  }
  function downloadBlob(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); }

  // Dropdowns
  function insertNoneOption(sel,label='‚Äî None ‚Äî'){ const o=document.createElement('option'); o.value=''; o.textContent=label; sel.appendChild(o); }
  async function populateConferences(sel){
    const list = await api.listConferences();
    sel.innerHTML=''; insertNoneOption(sel);
    (list||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c.id??c._id??c.uuid??c.conferenceId; o.textContent=c.name||('Conference '+o.value); sel.appendChild(o); });
  }
  async function populateVendorsForConference(cid, sel){
    sel.innerHTML=''; insertNoneOption(sel);
    if(!cid) return;
    try{
      const list = await api.listVendorsForConference(cid);
      (list||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v.id??v._id??v.uuid??v.vendorId; o.textContent=v.name||('Vendor '+o.value); sel.appendChild(o); });
    }catch{
      const all = await api.listAllVendors();
      (all||[]).forEach(v=>{ const o=document.createElement('option'); o.value=v.id??v._id??v.uuid??v.vendorId; o.textContent=v.name||('Vendor '+o.value); sel.appendChild(o); });
    }
  }

  // Media recording
  let mediaStream=null, mediaRecorder=null, audioChunks=[], recording=false;
  let sessionStartIso=null, sessionEndIso=null;

  function resetRecording(){ audioChunks=[]; recording=false; sessionStartIso=null; sessionEndIso=null; els.pillAudio.textContent='idle'; els.pillSession.textContent='‚Äî'; }
  async function startRecording(){
    if(!navigator.mediaDevices?.getUserMedia) throw new Error('Media capture not supported on this device/browser.');
    try{ mediaStream = await navigator.mediaDevices.getUserMedia({audio:true}); }catch{ throw new Error('Microphone permission denied or unavailable.'); }
    const mime = MediaRecorder?.isTypeSupported?.('audio/webm;codecs=opus')?'audio/webm;codecs=opus':(MediaRecorder?.isTypeSupported?.('audio/mp4')?'audio/mp4':'audio/webm');
    mediaRecorder = new MediaRecorder(mediaStream,{ mimeType:mime });
    audioChunks=[];
    mediaRecorder.addEventListener('dataavailable', e=>{ if(e.data.size>0) audioChunks.push(e.data); });
    mediaRecorder.addEventListener('stop', ()=>{ try{ mediaStream.getTracks().forEach(t=>t.stop()); }catch{} });
    mediaRecorder.start(1000);
    recording=true; sessionStartIso=new Date().toISOString(); els.pillAudio.textContent='recording';
    api.log('Audio recording started.');
  }
  async function stopRecordingGetBlob(){
    if(!mediaRecorder||!recording) return null;
    const p=new Promise(r=> mediaRecorder.addEventListener('stop', r, { once:true }));
    mediaRecorder.stop(); api.log('Stopping recorder‚Ä¶'); await p;
    sessionEndIso=new Date().toISOString();
    const blob=new Blob(audioChunks,{ type: mediaRecorder.mimeType||'audio/webm' });
    api.log(`Audio captured: ${(blob.size/1024/1024).toFixed(2)} MB`);
    recording=false; return blob;
  }

  // Images
  let imageFiles=[];
  function renderImagePreview(){
    const wrap=els.imagePreview; wrap.innerHTML='';
    imageFiles.forEach((f,i)=>{
      const url=URL.createObjectURL(f);
      const w=document.createElement('div'); w.className='thumbwrap';
      const img=document.createElement('img'); img.src=url; img.className='thumb'; img.alt=f.name;
      const x=document.createElement('button'); x.className='removebtn'; x.type='button'; x.textContent='√ó';
      x.addEventListener('click',()=>{ imageFiles.splice(i,1); renderImagePreview(); });
      w.appendChild(img); w.appendChild(x); wrap.appendChild(w);
    });
    els.pillImages.textContent=String(imageFiles.length);
  }
  els.imageInput.addEventListener('change', e=>{ imageFiles=imageFiles.concat(Array.from(e.target.files||[])); renderImagePreview(); });

  // Previous sessions
  async function loadPrevious(confId,vendorId){
    const sessions=[];
    async function forVendor(vid){
      try{
        const list=await api.listSessionsForVendor(vid);
        const arr = Array.isArray(list)?list:(Array.isArray(list?.data)?list.data:[]);
        arr.forEach(s=>sessions.push(s));
      }catch(e){ api.log(`Error loading sessions for vendor ${vid}: ${e.message}`,'error'); }
    }
    if(vendorId) await forVendor(vendorId);
    else if(confId){
      const vendors=await api.listVendorsForConference(confId);
      for(const v of (Array.isArray(vendors)?vendors:(vendors?.data||[]))){
        const vid=v.id??v._id??v.vendorId??v.uuid; if(vid) await forVendor(vid);
      }
    }else{
      const allV=await api.listAllVendors();
      for(const v of (Array.isArray(allV)?allV:(allV?.data||[]))){
        const vid=v.id??v._id??v.vendorId??v.uuid; if(vid) await forVendor(vid);
      }
    }
    els.prevList.innerHTML='';
    if(!sessions.length){ els.prevList.innerHTML=`<div class="section"><em>No sessions found.</em></div>`; return; }
    for(const s of sessions){
      const sid=s.id??s.sessionId??s._id??s.uuid??'(unknown)';
      const status=s.status??s.state??'uploaded';
      const when=s.created_at||s.createdAt? new Date(s.created_at||s.createdAt).toLocaleString() : '';
      const div=document.createElement('div'); div.className='section';
      div.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center">
        <div><strong>Session ${sid}</strong> <span class="muted">‚Ä¢ ${status}${when?` ‚Ä¢ ${when}`:''}</span></div>
        <button class="ghost" data-sid="${sid}">Open</button></div>`;
      div.querySelector('button').addEventListener('click',()=>openSessionDetail(sid));
      els.prevList.appendChild(div);
    }
  }

  async function openSessionDetail(sessionId){
    let meta=null, report=null;
    try{ meta=await api.getSession(sessionId); }catch(e){ api.log(`Error fetching session meta: ${e.message}`,'error'); }
    try{ report=await api.getSessionReport(sessionId); }catch(e){ api.log(`Error fetching session report: ${e.message}`,'error'); }
    const files=(meta?.files||meta?.uploads||[]);
    const images=(report?.images||meta?.images||[]);
    const ocr=report?.imageOcr||report?.ocr||null;
    const transcript=report?.transcript||report?.transcription||null;
    const summary=report?.summary||null;
    const textField=meta?.text||report?.notes||null;
    function esc(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
    const imgHtml=(images&&images.length)?`<div class="preview">${images.map(u=>`<img src="${u}" class="thumb" alt="">`).join('')}</div>`:`<em class="muted">No images</em>`;
    const filesHtml=(files&&files.length)?`<ul>${files.map(f=>`<li><a href="${f.url||f.href||'#'}" target="_blank" rel="noopener">${f.name||f.filename||f.url||'file'}</a></li>`).join('')}</ul>`:`<em class="muted">No files</em>`;
    els.detailContainer.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Session ${sessionId}</h2>
        <button class="ghost" onclick="window.__dlgClose(document.getElementById('detailDialog'))">Close</button>
      </div>
      <div class="grid2">
        <div class="section"><strong>Files</strong>${filesHtml}</div>
        <div class="section"><strong>Transcript</strong><pre class="status" style="max-height:180px">${transcript?esc(transcript):'‚Äî'}</pre></div>
      </div>
      <div class="section"><strong>Image OCR</strong><pre class="status" style="max-height:180px">${ocr?esc(typeof ocr==='string'?ocr:JSON.stringify(ocr,null,2)):'‚Äî'}</pre></div>
      <div class="section"><strong>Images</strong>${imgHtml}</div>
      <div class="grid2">
        <div class="section"><strong>Notes</strong><pre class="status" style="max-height:140px">${textField?esc(textField):'‚Äî'}</pre></div>
        <div class="section"><strong>Summary</strong><pre class="status" style="max-height:140px">${summary?esc(summary):'‚Äî'}</pre></div>
      </div>`;
    openDlg(els.detailDialog);
  }

  // Top toolbar
  els.btnOpenAuth.addEventListener('click', ()=>{
    const cfg=api.getConfig()||{ url:'https://conference-buddy-geoutils.replit.app/api', key:'', mode:'xapikey', param:'apiKey' };
    els.apiUrl.value=cfg.url||''; els.apiKey.value=cfg.key||''; els.authMode.value=cfg.mode||'xapikey'; els.authParam.value=cfg.param||'apiKey';
    openDlg(els.authDialog);
  });
  els.btnCloseAuth.addEventListener('click', ()=> closeDlg(els.authDialog));
  els.btnSave.addEventListener('click', ()=>{
    const url=els.apiUrl.value.trim(), key=els.apiKey.value.trim(), mode=els.authMode.value, param=(els.authParam.value.trim()||'apiKey');
    if(!url||!key) return alert('Enter API base URL and API key.');
    api.setConfig({url,key,mode,param}); els.apiStatus.textContent='Connected'; closeDlg(els.authDialog); boot();
  });
  els.btnTest.addEventListener('click', async ()=>{ try{ await api.testConnectivity(); alert('Connection OK. Check Logs for details.'); }catch(e){ alert('Connection failed: '+e.message); } });

  els.btnLogs.addEventListener('click', ()=>{ renderLogs(); openDlg(els.logsDialog); });
  els.btnCloseLogs.addEventListener('click', ()=> closeDlg(els.logsDialog));
  els.logVerbosity.addEventListener('change', renderLogs);
  els.btnCopyLogs.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(els.logsView.textContent||''); alert('Logs copied'); }catch{ alert('Copy failed. Select text and copy.'); } });
  els.btnDownloadTxt.addEventListener('click', ()=> downloadBlob('cb-logs.txt', new Blob([els.logsView.textContent||''], {type:'text/plain'})));
  // ‚úÖ FIXED: removed extra ")" here that previously broke the entire script.
  els.btnDownloadJson.addEventListener('click', ()=> downloadBlob('cb-logs.json', new Blob([JSON.stringify(api.getLogs(),null,2)], {type:'application/json'})));

  els.btnSelfTest.addEventListener('click', ()=>{ els.selfTestOutput.textContent=''; openDlg(els.selfTestDialog); });
  els.btnCloseSelfTest.addEventListener('click', ()=> closeDlg(els.selfTestDialog));
  els.btnRunSelfTest.addEventListener('click', async ()=>{
    els.selfTestOutput.textContent='';
    try{ const out=await api.runSelfTest(); els.selfTestOutput.textContent=out.join('\n'); }
    catch(e){ els.selfTestOutput.textContent='‚úñ Self-Test failed: '+e.message+' ‚Äî check Logs.'; }
  });

  // New conf/vendor
  els.btnAddConf.addEventListener('click', ()=> openDlg(els.confDialog));
  els.btnAddVendor.addEventListener('click', async ()=>{ await populateConferences(els.newVendorConf); openDlg(els.vendorDialog); });

  els.btnCreateConf.addEventListener('click', async ()=>{
    try{
      const name=els.newConfName.value.trim(); if(!name) return alert('Enter a conference name.');
      const sd=els.newConfStart.value||api.todayISO(), ed=els.newConfEnd.value||sd;
      const created=await api.createConference({ name, start_date: sd, end_date: ed });
      api.log('Conference created: '+(created?.id||created?.name||'ok'));
      closeDlg(els.confDialog);
      await populateConferences(els.confSelect);
      const cid=created?.id??created?._id??created?.uuid??created?.conferenceId;
      if(cid) els.confSelect.value=cid;
      await populateVendorsForConference(els.confSelect.value, els.vendorSelect);
    }catch(e){ alert('Create conference failed: '+e.message); }
  });

  els.btnCreateVendor.addEventListener('click', async ()=>{
    try{
      const name=els.newVendorName.value.trim(), confId=els.newVendorConf.value;
      if(!name||!confId) return alert('Enter vendor name and select a conference.');
      const created=await api.createVendor({ name, conference_id: confId });
      api.log('Vendor created: '+(created?.id||created?.name||'ok'));
      closeDlg(els.vendorDialog);
      if(els.confSelect.value) await populateVendorsForConference(els.confSelect.value, els.vendorSelect);
      const vid=created?.id??created?._id??created?.uuid??created?.vendorId; if(vid) els.vendorSelect.value=vid;
    }catch(e){ alert('Create vendor failed: '+e.message); }
  });

  els.confSelect.addEventListener('change', async ()=>{ await populateVendorsForConference(els.confSelect.value, els.vendorSelect); });

  // Start / Stop / Upload
  els.btnStart.addEventListener('click', async ()=>{
    if(!api.getConfig()?.url || !api.getConfig()?.key) return alert('Configure API first.');
    els.btnStart.disabled=true; els.btnStop.disabled=false;
    try{ await startRecording(); api.log('Session started. Recording in progress.'); }
    catch(e){ els.btnStart.disabled=false; els.btnStop.disabled=true; alert('Cannot start recording: '+e.message); }
  });

  els.btnStop.addEventListener('click', async ()=>{
    els.btnStop.disabled=true;
    try{
      const audioBlob=await stopRecordingGetBlob();
      if(!audioBlob) throw new Error('No audio captured.');
      let conferenceId=els.confSelect.value||null;
      let vendorId=els.vendorSelect.value||null;
      ({ conferenceId, vendorId } = await api.ensureConferenceVendor({ conferenceId, vendorId, preferredVendorName:'Unknown Vendor' }));
      const sid = await api.uploadSession({
        audioBlob, images: imageFiles, text: els.notes.value,
        conferenceId, vendorId,
        startIso: sessionStartIso||new Date().toISOString(),
        endIso: sessionEndIso||sessionStartIso||new Date().toISOString()
      });
      els.pillSession.textContent=sid;
      alert('Uploaded! Session ID: '+sid+'\nEnrichment started.');
    }catch(e){ alert('Upload failed: '+e.message); }
    finally{
      els.btnStart.disabled=false; els.btnStop.disabled=true;
      imageFiles=[]; els.imagePreview.innerHTML=''; els.pillImages.textContent='0'; els.notes.value='';
      resetRecording();
    }
  });

  // Previous sessions
  els.btnPrevious.addEventListener('click', async ()=>{
    await populateConferences(els.prevConf);
    if(els.prevConf.value) await populateVendorsForConference(els.prevConf.value, els.prevVendor);
    document.querySelectorAll('h2')[1]?.scrollIntoView({behavior:'smooth'});
  });
  els.prevConf.addEventListener('change', async ()=>{ await populateVendorsForConference(els.prevConf.value, els.prevVendor); });
  els.btnLoadSessions.addEventListener('click', async ()=>{ await loadPrevious(els.prevConf.value||null, els.prevVendor.value||null); });

  // Boot
  async function boot(){
    try{
      const cfg=api.getConfig()||{ url:'https://conference-buddy-geoutils.replit.app/api', key:'', mode:'xapikey', param:'apiKey' };
      api.setConfig(cfg);
      els.apiStatus.textContent = cfg.key ? 'Connected' : 'Disconnected';
      await populateConferences(els.confSelect);
      if(els.confSelect.value) await populateVendorsForConference(els.confSelect.value, els.vendorSelect);
      await populateConferences(els.prevConf);
      if(els.prevConf.value) await populateVendorsForConference(els.prevConf.value, els.prevVendor);
      api.log('Dropdowns populated from API.');
      els.status.textContent='Ready.';
    }catch(e){
      api.log('Could not load initial data: '+e.message,'error');
      els.status.textContent='Error while loading initial data. Open API settings and verify.';
    }
  }
  boot();
})();
</script>
</body>
  </html>
