<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Conference Buddy ‚Äî Recorder (Mobile)</title>
<style>
  :root{--bg:#0a1020;--bg2:#0f1a33;--fg:#e6eefc;--muted:#9bb3e0;--accent:#3b82f6;--accent2:#60a5fa;--danger:#ef4444;--ok:#10b981;--card:#0c1428;--border:#1f2a44}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#071028);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  a{color:var(--accent)}
  .wrap{max-width:720px;margin:0 auto;padding:12px;display:flex;flex-direction:column;gap:12px}
  header{position:sticky;top:0;z-index:40;background:linear-gradient(180deg,rgba(10,16,32,.95),rgba(10,16,32,.75));backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
  .hbar{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 6px}
  .brand{display:flex;gap:8px;align-items:center}
  .badge{font-size:12px;border:1px solid var(--border);background:#0b1a3a;border-radius:999px;padding:4px 8px;color:#c5d7ff}
  .chip{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;color:#b9caf2}
  button,input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--bg2);color:var(--fg);outline:none}
  button{cursor:pointer} button.primary{background:linear-gradient(180deg,var(--accent),var(--accent2));border:none;color:#fff;font-weight:700}
  button.ghost{background:transparent;border:1px solid var(--border)} button.danger{background:var(--danger);border:none;color:#fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  .section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px}
  .section h2{margin:.2rem 0 8px;font-size:16px;color:#d7e5ff}
  label{font-size:12px;color:var(--muted);display:block;margin:6px 0 6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;background:#0d2048;border:1px solid var(--border);border-radius:999px;color:#bcd1ff;font-size:12px}
  .status{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b152c;border:1px solid var(--border);border-radius:12px;padding:10px;max-height:40vh;overflow:auto}
  .muted{color:var(--muted)}
  .thumb{width:88px;height:88px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
  .thumbwrap{position:relative} .removebtn{position:absolute;top:4px;right:4px;background:#0008;border:1px solid var(--border);color:#fff;border-radius:999px;padding:2px 6px;font-size:12px}
  .preview{display:flex;gap:8px;flex-wrap:wrap}
  #notes{min-height:220px} @media(min-width:900px){.wrap{max-width:1100px} #notes{min-height:260px}}
</style>
</head>
<body>
<header>
  <div class="hbar">
    <div class="brand"><strong>Conference Buddy ‚Äî Recorder</strong><span class="badge">mobile ¬∑ dark/blue</span></div>
    <div class="row">
      <span id="apiStatus" class="chip">Disconnected</span>
      <button id="btnLogs" class="ghost" title="View & export logs">Logs</button>
      <button id="btnOpenAuth" class="ghost">API</button>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- TOP: recorder -->
  <section class="section">
    <h2>Session Recorder</h2>
    <div class="grid2">
      <div>
        <label>Conference</label>
        <div class="row"><select id="confSelect"></select><button id="btnAddConf" class="ghost">+ New</button></div>
        <small class="muted">Optional; blank = ‚ÄúUnknown Conference‚Äù.</small>
      </div>
      <div>
        <label>Vendor</label>
        <div class="row"><select id="vendorSelect"></select><button id="btnAddVendor" class="ghost">+ New</button></div>
        <small class="muted">Optional; blank = ‚ÄúUnknown Vendor‚Äù.</small>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnStart" class="primary">‚ñ∂ Start (audio immediately)</button>
      <button id="btnStop" class="danger" disabled>‚ñ† Stop & Upload</button>
      <button id="btnPrevious" class="ghost">üìú Previous Sessions</button>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="pill">Audio: <strong id="pillAudio">idle</strong></span>
      <span class="pill">Images: <strong id="pillImages">0</strong></span>
      <span class="pill">Session ID: <strong id="pillSession">‚Äî</strong></span>
    </div>
    <div style="margin-top:8px">
      <label>Notes</label>
      <textarea id="notes" placeholder="Type notes here‚Ä¶"></textarea>
    </div>
    <div style="margin-top:8px">
      <label>Photos</label>
      <input id="imageInput" type="file" accept="image/*" capture="environment" multiple />
      <div id="imagePreview" class="preview" aria-live="polite"></div>
      <small class="muted">Tap to add more. Remove any image with √ó.</small>
    </div>
  </section>

  <!-- BOTTOM: previous sessions -->
  <section class="section">
    <h2>Previous Sessions</h2>
    <div class="grid2">
      <div><label>Conference</label><select id="prevConf"></select></div>
      <div><label>Vendor</label><select id="prevVendor"></select></div>
    </div>
    <div class="row" style="margin-top:8px"><button id="btnLoadSessions" class="ghost">Load</button></div>
    <div id="prevList" style="margin-top:8px;display:grid;gap:8px"></div>
  </section>

  <section class="section">
    <h2>Status & Diagnostics</h2>
    <div id="status" class="status" role="status" aria-live="polite">Ready.</div>
  </section>
</main>

<!-- Settings -->
<dialog id="authDialog"><div class="section">
  <h2>API Settings</h2>
  <label>Backend API Base URL</label>
  <input id="apiUrl" placeholder="https://conference-buddy-geoutils.replit.app" />
  <div class="grid2">
    <div><label>API Key</label><input id="apiKey" type="password" placeholder="paste API key‚Ä¶" /></div>
    <div><label>Auth on GET</label>
      <select id="getAuthMode">
        <option value="query">Query (?apiKey=‚Ä¶)</option>
        <option value="header">Header (preflight)</option>
        <option value="auto">Auto (try header then query)</option>
      </select>
    </div>
  </div>
  <div class="grid2" style="margin-top:8px">
    <div><label>Auth Header for non-GET</label>
      <select id="authMode">
        <option value="xapikey">X-API-Key: &lt;key&gt;</option>
        <option value="bearer">Authorization: Bearer &lt;key&gt;</option>
      </select>
    </div>
    <div><label>Base Path Prefix (optional)</label>
      <input id="apiPrefix" placeholder="/api (leave blank if none)" />
    </div>
  </div>
  <div class="row" style="margin-top:8px">
    <button id="btnTest" class="ghost">Test Connection</button>
    <button id="btnSave" class="primary">Save</button>
    <button id="btnCloseAuth" class="ghost">Close</button>
  </div>
  <small class="muted">We log exact final URLs. If <code>/conferences</code> fails, we auto-retry <code>/api/conferences</code>.</small>
</div></dialog>

<!-- Modals: Add Conf/Vendor, Detail, Logs (unchanged layout-wise) -->
<dialog id="confDialog"><div class="section"><h2>New Conference</h2>
  <label>Name</label><input id="newConfName" />
  <label>Start Date (optional)</label><input id="newConfDate" type="date" />
  <div class="row" style="margin-top:8px"><button id="btnCreateConf" class="primary">Create</button><button class="ghost" onclick="document.getElementById('confDialog').close()">Cancel</button></div>
</div></dialog>

<dialog id="vendorDialog"><div class="section"><h2>New Vendor</h2>
  <label>Vendor Name</label><input id="newVendorName" />
  <label>Link to Conference</label><select id="newVendorConf"></select>
  <div class="row" style="margin-top:8px"><button id="btnCreateVendor" class="primary">Create</button><button class="ghost" onclick="document.getElementById('vendorDialog').close()">Cancel</button></div>
</div></dialog>

<dialog id="detailDialog"><div class="section" id="detailContainer"></div></dialog>

<dialog id="logsDialog"><div class="section">
  <div class="row" style="justify-content:space-between"><h2>Diagnostics & Logs</h2>
    <div class="row"><button id="btnCopyLogs" class="ghost">Copy</button><button id="btnDownloadTxt" class="ghost">Download .txt</button><button id="btnDownloadJson" class="ghost">Download .json</button><button id="btnCloseLogs" class="ghost">Close</button></div>
  </div>
  <div id="logsView" class="status" style="min-height:260px;max-height:60vh"></div>
</div></dialog>

<script>
/* ===== Elements ===== */
const els = { apiStatus:$('#apiStatus'), btnOpenAuth:$('#btnOpenAuth'), btnLogs:$('#btnLogs'),
  authDialog:$('#authDialog'), apiUrl:$('#apiUrl'), apiKey:$('#apiKey'), authMode:$('#authMode'),
  getAuthMode:$('#getAuthMode'), apiPrefix:$('#apiPrefix'), btnSave:$('#btnSave'), btnCloseAuth:$('#btnCloseAuth'), btnTest:$('#btnTest'),
  confSelect:$('#confSelect'), vendorSelect:$('#vendorSelect'), btnAddConf:$('#btnAddConf'), btnAddVendor:$('#btnAddVendor'),
  imageInput:$('#imageInput'), imagePreview:$('#imagePreview'), notes:$('#notes'),
  btnStart:$('#btnStart'), btnStop:$('#btnStop'), btnPrevious:$('#btnPrevious'),
  prevConf:$('#prevConf'), prevVendor:$('#prevVendor'), btnLoadSessions:$('#btnLoadSessions'), prevList:$('#prevList'),
  status:$('#status'), pillAudio:$('#pillAudio'), pillImages:$('#pillImages'), pillSession:$('#pillSession'),
  confDialog:$('#confDialog'), newConfName:$('#newConfName'), newConfDate:$('#newConfDate'), btnCreateConf:$('#btnCreateConf'),
  vendorDialog:$('#vendorDialog'), newVendorName:$('#newVendorName'), newVendorConf:$('#newVendorConf'), btnCreateVendor:$('#btnCreateVendor'),
  detailDialog:$('#detailDialog'), detailContainer:$('#detailContainer'),
  logsDialog:$('#logsDialog'), logsView:$('#logsView'), btnCopyLogs:$('#btnCopyLogs'), btnDownloadTxt:$('#btnDownloadTxt'), btnDownloadJson:$('#btnDownloadJson'), btnCloseLogs:$('#btnCloseLogs') };
function $(id){ return document.getElementById(id); }

/* ===== Persist ===== */
const store = {
  get api(){ return JSON.parse(localStorage.getItem('cb_api')||'null'); },
  set api(v){ localStorage.setItem('cb_api', JSON.stringify(v)); },
  get unknown(){ return JSON.parse(localStorage.getItem('cb_unknown')||'null'); },
  set unknown(v){ localStorage.setItem('cb_unknown', JSON.stringify(v)); },
};

/* ===== Logs (with responses) ===== */
const LOG_CAP=3000; let logBuffer=[];
const redact=(h)=>{const x={...h}; if(x['X-API-Key']) x['X-API-Key']='***'; if(x['Authorization']) x['Authorization']='***'; return x;};
function pushLog(entry){const now=new Date();const item={t:now.toISOString(),...entry}; logBuffer.push(item); if(logBuffer.length>LOG_CAP) logBuffer.shift();
  const line=`[${now.toISOString()}] [${(entry.level||'info').toUpperCase()}] ${entry.msg}${entry.extra?(' '+entry.extra):''}`;
  els.status.textContent+=(els.status.textContent?'\n':'')+line; els.status.scrollTop=els.status.scrollHeight;
  (entry.level==='error'?console.error:entry.level==='warn'?console.warn:console.log)(item);}
const log=(m,l='info',e='')=>pushLog({msg:m,level:l,extra:e});
const netStart=({method,url,headers,strategy})=>{const id=Math.random().toString(36).slice(2,9),start=performance.now();
  pushLog({level:'info',msg:`HTTP ${method} ${url}`,extra:`‚Üí request (${strategy})`,id,method,url,start,headers:redact(headers),strategy}); return {id,start,method,url,strategy};};
const netEnd=(c,res,body)=>pushLog({level:'info',msg:`HTTP ${c.method} ${c.url}`,extra:`‚Üê ${res.status} ${res.statusText} (${(performance.now()-c.start).toFixed(0)}ms)`,id:c.id,status:res.status,body});
const netErr=(c,err)=>{pushLog({level:'error',msg:`HTTP ${c.method} ${c.url}`,extra:`‚úñ ${err.message} (${(performance.now()-c.start).toFixed(0)}ms)`,id:c.id,error:String(err)}); if(String(err).includes('Failed to fetch')) log('Hint: CORS preflight/OPTIONS not answered or origin blocked.','warn');};

/* ===== UI helpers ===== */
function setConnected(on){els.apiStatus.textContent=on?'Connected':'Disconnected'; els.apiStatus.style.background=on?'#062f14':''; els.apiStatus.style.color=on?'#a7f3d0':''; els.apiStatus.style.borderColor=on?'#134e4a':'var(--border)';}
const esc=(s)=>String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

/* ===== URL helpers ===== */
function joinUrl(base, prefix, path){const root=base.replace(/\/+$/,''); const pre=prefix?('/'+prefix.replace(/^\/+/,'').replace(/\/+$/,'')) : ''; const p=path.startsWith('/')?path:('/'+path); return root+pre+p;}
function addQuery(url, kv){const u=new URL(url); Object.entries(kv).forEach(([k,v])=>u.searchParams.set(k,v)); return u.toString();}

/* ===== Auth strategies ===== */
function buildHeadersForNonGet(mode,key){ return mode==='bearer' ? {'Authorization':`Bearer ${key}`} : {'X-API-Key':key}; }
function buildGetUrlWithKey(url, key){
  // Prefer ?apiKey=; fallbacks supported by some stacks: ?key= or ?api_key=
  const u1=addQuery(url,{apiKey:key});
  return {primary:u1, fallbacks:[addQuery(url,{key:key}), addQuery(url,{api_key:key})]};
}

/* ===== Core fetch with: GET query-key + prefix fallback ===== */
async function apiFetch(path, opts={}){
  const cfg=store.api; if(!cfg?.url) throw new Error('Missing API base URL. Open API Settings.');
  const method=(opts.method||'GET').toUpperCase();
  const prefixes = [cfg.prefix||'', '/api']; // try user prefix first, then /api as fallback
  let lastErr = null;

  for (const pre of prefixes){
    const baseUrl = joinUrl(cfg.url, pre, path);
    const useHeaderOnGet = cfg.getAuthMode === 'header';
    const useQueryOnGet  = cfg.getAuthMode === 'query';
    const useAutoOnGet   = cfg.getAuthMode === 'auto';

    // Strategy for this attempt:
    let strategy = 'header';
    let url = baseUrl;
    let headers = {};
    let body = opts.body || undefined;

    if (method === 'GET'){
      if (useQueryOnGet){
        const q = buildGetUrlWithKey(baseUrl, cfg.key);
        url = q.primary; strategy = 'query-param';
        headers = {}; // no custom headers -> no preflight
      } else {
        // header or auto(header first)
        headers = buildHeadersForNonGet(cfg.mode, cfg.key);
        strategy = (useAutoOnGet ? 'auto:header-first' : 'header');
      }
    } else {
      headers = { ...buildHeadersForNonGet(cfg.mode, cfg.key), ...(opts.headers||{}) };
      if (body && !opts.formData && !headers['Content-Type']) headers['Content-Type']='application/json';
    }

    const ctx = netStart({method, url, headers, strategy});
    try{
      const res = await fetch(url, { method, headers, body, mode:'cors', credentials:'omit' });
      const ct = res.headers.get('content-type') || '';
      let sample=null; try{ sample = ct.includes('application/json') ? JSON.stringify(await res.clone().json()).slice(0,2000) : (await res.clone().text()).slice(0,2000); }catch(_){}
      netEnd(ctx,res,sample);
      if(!res.ok){ const err = new Error(`HTTP ${res.status} ${res.statusText}${sample?` ‚Äî ${sample}`:''}`); err.status=res.status; throw err; }
      return ct.includes('application/json') ? res.json() : res.blob();
    }catch(e){
      netErr(ctx,e);
      lastErr = e;

      // Auto fallback: if GET with auto mode and header failed due to CORS or 401/403, retry once with query-param on same prefix
      if (method==='GET' && useAutoOnGet && (String(e).includes('Failed to fetch') || (e.status && [401,403].includes(e.status)))){
        const q = buildGetUrlWithKey(baseUrl, cfg.key);
        const url2 = q.primary;
        const ctx2 = netStart({method, url:url2, headers:{}, strategy:'auto:query-fallback'});
        try{
          const res2 = await fetch(url2, { method, mode:'cors', credentials:'omit' });
          const ct2 = res2.headers.get('content-type')||''; let sample2=null; try{ sample2 = ct2.includes('application/json') ? JSON.stringify(await res2.clone().json()).slice(0,2000) : (await res2.clone().text()).slice(0,2000);}catch(_){}
          netEnd(ctx2,res2,sample2);
          if(!res2.ok){ const err2=new Error(`HTTP ${res2.status} ${res2.statusText}${sample2?` ‚Äî ${sample2}`:''}`); err2.status=res2.status; throw err2; }
          return ct2.includes('application/json') ? res2.json() : res2.blob();
        }catch(e2){ netErr(ctx2,e2); lastErr = e2; }
      }

      // Try next prefix (e.g., /api) if we failed here
      continue;
    }
  }
  throw lastErr || new Error('Request failed');
}

/* ===== Data loaders ===== */
async function loadConferences(sel){ const list=await apiFetch('/conferences'); sel.innerHTML=''; (list||[]).forEach(c=>{const o=document.createElement('option'); o.value=c.id??c._id??c.uuid??c.conferenceId; o.textContent=c.name??c.title??`Conference ${o.value}`; sel.appendChild(o);}); }
async function loadVendorsForConference(confId, sel){
  sel.innerHTML=''; if(!confId) return;
  try{ const list=await apiFetch(`/conferences/${encodeURIComponent(confId)}/vendors`); (list||[]).forEach(v=>{const o=document.createElement('option'); o.value=v.id??v._id??v.uuid??v.vendorId; o.textContent=v.name??`Vendor ${o.value}`; sel.appendChild(o);}); }
  catch(e){ log(`Warn: vendors for conf failed ‚Äî ${e.message}. Falling back to /vendors`,'warn'); const list=await apiFetch('/vendors'); (list||[]).forEach(v=>{const o=document.createElement('option'); o.value=v.id??v._id??v.uuid??v.vendorId; o.textContent=v.name??`Vendor ${o.value}`; sel.appendChild(o);}); }
}

/* ===== Unknown entities ===== */
async function ensureUnknowns(){
  const cached=store.unknown; if(cached?.conferenceId && cached?.vendorId) return cached;
  let confId=null, vendorId=null;
  try{ const confs=await apiFetch('/conferences'); const unk=(confs||[]).find(c=>(c.name||'').toLowerCase()==='unknown conference'); if(unk) confId=unk.id??unk._id??unk.uuid??unk.conferenceId; }catch(e){ log('List conferences failed while seeking Unknown Conference: '+e.message,'warn'); }
  if(!confId){ const created=await apiFetch('/conferences',{method:'POST', body:JSON.stringify({name:'Unknown Conference'})}); confId=created?.id??created?._id??created?.uuid??created?.conferenceId; log('Created Unknown Conference: '+confId); }
  try{ const vs=await apiFetch(`/conferences/${encodeURIComponent(confId)}/vendors`); const uv=(vs||[]).find(v=>(v.name||'').toLowerCase()==='unknown vendor'); if(uv) vendorId=uv.id??uv._id??uv.uuid??uv.vendorId; }catch(e){ log('List vendors for Unknown Conference failed: '+e.message,'warn'); }
  if(!vendorId){ const createdV=await apiFetch('/vendors',{method:'POST', body:JSON.stringify({name:'Unknown Vendor', conferenceId:confId})}); vendorId=createdV?.id??createdV?._id??createdV?.uuid??createdV?.vendorId; log('Created Unknown Vendor: '+vendorId); }
  const out={conferenceId:confId, vendorId}; store.unknown=out; return out;
}

/* ===== Recording ===== */
let mediaStream=null, mediaRecorder=null, audioChunks=[], recording=false;
function resetRec(){ audioChunks=[]; recording=false; els.pillAudio.textContent='idle'; els.pillSession.textContent='‚Äî'; }
async function startRec(){ try{ mediaStream=await navigator.mediaDevices.getUserMedia({audio:true}); }catch(err){ throw new Error('Microphone permission denied/unavailable.'); }
  const mime=MediaRecorder.isTypeSupported('audio/webm;codecs=opus')?'audio/webm;codecs=opus':(MediaRecorder.isTypeSupported('audio/mp4')?'audio/mp4':'audio/webm');
  mediaRecorder=new MediaRecorder(mediaStream,{mimeType:mime}); audioChunks=[]; mediaRecorder.addEventListener('dataavailable',e=>{if(e.data.size>0) audioChunks.push(e.data);});
  mediaRecorder.addEventListener('stop',()=>{mediaStream.getTracks().forEach(t=>t.stop());});
  mediaRecorder.start(1000); recording=true; els.pillAudio.textContent='recording'; log('Audio recording started.'); }
async function stopRec(){ if(!mediaRecorder||!recording) return null; const stopped=new Promise(r=>mediaRecorder.addEventListener('stop',r,{once:true})); mediaRecorder.stop(); log('Stopping recorder‚Ä¶'); await stopped;
  const blob=new Blob(audioChunks,{type: mediaRecorder.mimeType||'audio/webm'}); log(`Audio captured: ${(blob.size/1024/1024).toFixed(2)} MB`); resetRec(); return blob; }

/* ===== Images ===== */
let imageFiles=[]; function renderImgs(){ els.imagePreview.innerHTML=''; imageFiles.forEach((f,i)=>{const url=URL.createObjectURL(f); const wrap=document.createElement('div'); wrap.className='thumbwrap';
  const img=document.createElement('img'); img.src=url; img.className='thumb'; img.alt=f.name; const x=document.createElement('button'); x.className='removebtn'; x.type='button'; x.textContent='√ó';
  x.addEventListener('click',()=>{imageFiles.splice(i,1); renderImgs();}); wrap.appendChild(img); wrap.appendChild(x); els.imagePreview.appendChild(wrap);}); els.pillImages.textContent=String(imageFiles.length); }
els.imageInput.addEventListener('change',e=>{ imageFiles = imageFiles.concat(Array.from(e.target.files||[])); renderImgs(); });

/* ===== Upload & Enrich ===== */
async function uploadSession({audioBlob, images, notes, conferenceId, vendorId}){
  const fd=new FormData(); if(audioBlob) fd.append('audio', audioBlob, `session.${(audioBlob.type.split('/')[1]||'webm').split(';')[0]}`); images.forEach(f=>fd.append('images',f,f.name));
  if(notes) fd.append('notes',notes); if(conferenceId) fd.append('conferenceId',conferenceId); if(vendorId) fd.append('vendorId',vendorId);
  const res=await apiFetch('/sessions/upload',{method:'POST', body:fd, formData:true}); const sessionId=res.id??res.sessionId??res._id??res.uuid; if(!sessionId) throw new Error('Upload succeeded but no session ID.');
  log('Uploaded. Session ID: '+sessionId); els.pillSession.textContent=sessionId; try{ await apiFetch(`/sessions/${encodeURIComponent(sessionId)}/enrich`,{method:'POST'}); log('Enrichment triggered.'); }catch(e){ log('Could not trigger enrichment: '+e.message,'warn'); }
  return sessionId;
}

/* ===== Previous sessions ===== */
async function loadPrevious(conferenceId, vendorId){
  const sessions=[]; const forVendor=async(vid)=>{try{ (await apiFetch(`/vendors/${encodeURIComponent(vid)}/sessions`)||[]).forEach(s=>sessions.push(s)); }catch(e){ log(`Load sessions for vendor ${vid} failed: `+e.message,'error'); }};
  if(vendorId) await forVendor(vendorId); else if(conferenceId){ (await apiFetch(`/conferences/${encodeURIComponent(conferenceId)}/vendors`)||[]).forEach(async v=>{const vid=v.id??v._id??v.vendorId??v.uuid; if(vid) await forVendor(vid);}); }
  else{ (await apiFetch('/vendors')||[]).forEach(async v=>{ const vid=v.id??v._id??v.vendorId??v.uuid; if(vid) await forVendor(vid); }); }
  els.prevList.innerHTML=''; if(!sessions.length){ els.prevList.innerHTML='<div class="section"><em>No sessions found.</em></div>'; return; }
  sessions.forEach(s=>{const sid=s.id??s.sessionId??s._id??s.uuid??'(unknown)'; const status=s.status??s.state??'uploaded'; const when=s.createdAt?new Date(s.createdAt).toLocaleString():'';
    const div=document.createElement('div'); div.className='section'; div.innerHTML=`<div class="row" style="justify-content:space-between;align-items:center"><div><strong>Session ${sid}</strong> <span class="muted">‚Ä¢ ${status}${when?` ‚Ä¢ ${when}`:''}</span></div><button class="ghost" data-sid="${sid}">Open</button></div>`; 
    div.querySelector('button').addEventListener('click',()=>openSessionDetail(sid)); els.prevList.appendChild(div); });
}
async function openSessionDetail(sessionId){
  let meta=null, report=null; try{ meta=await apiFetch(`/sessions/${encodeURIComponent(sessionId)}`);}catch(e){log('Meta error: '+e.message,'error');}
  try{ report=await apiFetch(`/reports/session/${encodeURIComponent(sessionId)}`);}catch(e){log('Report error: '+e.message,'error');}
  const files=(meta?.files||meta?.uploads||[]), images=(report?.images||meta?.images||[]), ocr=report?.imageOcr||report?.ocr||null, transcript=report?.transcript||report?.transcription||null, summary=report?.summary||null, notes=meta?.notes||report?.notes||null;
  const imgHtml=images.length?`<div class="preview">${images.map(u=>`<img src="${u}" class="thumb" alt="image">`).join('')}</div>`:`<em class="muted">No images</em>`;
  const filesHtml=files.length?`<ul>${files.map(f=>`<li><a href="${f.url||f.href||'#'}" target="_blank" rel="noopener">${f.name||f.filename||f.url||'file'}</a></li>`).join('')}</ul>`:`<em class="muted">No files</em>`;
  els.detailContainer.innerHTML=`
    <div class="row" style="justify-content:space-between;align-items:center"><h2 style="margin:0">Session ${sessionId}</h2><button class="ghost" onclick="document.getElementById('detailDialog').close()">Close</button></div>
    <div class="grid2"><div class="section"><strong>Files</strong>${filesHtml}</div><div class="section"><strong>Transcript</strong><pre class="status" style="max-height:180px">${transcript?esc(transcript):'‚Äî'}</pre></div></div>
    <div class="section"><strong>Image OCR</strong><pre class="status" style="max-height:180px">${ocr?esc(typeof ocr==='string'?ocr:JSON.stringify(ocr,null,2)):'‚Äî'}</pre></div>
    <div class="section"><strong>Images</strong>${imgHtml}</div>
    <div class="grid2"><div class="section"><strong>Notes</strong><pre class="status" style="max-height:140px">${notes?esc(notes):'‚Äî'}</pre></div><div class="section"><strong>Summary</strong><pre class="status" style="max-height:140px">${summary?esc(summary):'‚Äî'}</pre></div></div>`;
  els.detailDialog.showModal();
}

/* ===== Events ===== */
els.btnOpenAuth.addEventListener('click',()=>{const cfg=store.api||{url:'https://conference-buddy-geoutils.replit.app',key:'',mode:'xapikey',getAuthMode:'query',prefix:''};
  els.apiUrl.value=cfg.url||''; els.apiKey.value=cfg.key||''; els.authMode.value=cfg.mode||'xapikey'; els.getAuthMode.value=cfg.getAuthMode||'query'; els.apiPrefix.value=cfg.prefix||''; els.authDialog.showModal();});
els.btnCloseAuth.addEventListener('click',()=>els.authDialog.close());
els.btnSave.addEventListener('click',()=>{const url=els.apiUrl.value.trim(); const key=els.apiKey.value.trim();
  if(!url||!key) return alert('Enter API base URL and API key.'); store.api={url,key,mode:els.authMode.value,getAuthMode:els.getAuthMode.value,prefix:els.apiPrefix.value.trim()}; setConnected(true); els.authDialog.close(); boot();});
els.btnTest.addEventListener('click',async()=>{ try{ await apiFetch('/test/ping'); alert('OK: /test/ping'); }catch(e1){ try{ await apiFetch('/health'); alert('OK: /health'); }catch(e2){ alert('Connection failed:\\n'+e1.message+'\\n'+e2.message); } }});
els.btnAddConf.addEventListener('click',()=>els.confDialog.showModal());
els.btnAddVendor.addEventListener('click',async()=>{ await loadConferences(els.newVendorConf); els.vendorDialog.showModal(); });
els.btnCreateConf.addEventListener('click',async()=>{ try{ const body={name:els.newConfName.value.trim()}; const d=els.newConfDate.value; if(d) body.date=d; if(!body.name) return alert('Enter a conference name.');
  const created=await apiFetch('/conferences',{method:'POST',body:JSON.stringify(body)}); log('Conference created: '+(created?.id||created?.name||'ok'));
  els.confDialog.close(); await loadConferences(els.confSelect); const cid=created?.id??created?._id??created?.uuid??created?.conferenceId; if(cid) els.confSelect.value=cid; await loadVendorsForConference(els.confSelect.value, els.vendorSelect);
}catch(e){ alert('Create conference failed: '+e.message); }});
els.btnCreateVendor.addEventListener('click',async()=>{ try{ const name=els.newVendorName.value.trim(); const confId=els.newVendorConf.value; if(!name||!confId) return alert('Enter vendor name and select a conference.');
  const created=await apiFetch('/vendors',{method:'POST',body:JSON.stringify({name,conferenceId:confId})}); log('Vendor created: '+(created?.id||created?.name||'ok'));
  els.vendorDialog.close(); if(els.confSelect.value) await loadVendorsForConference(els.confSelect.value, els.vendorSelect); const vid=created?.id??created?._id??created?.uuid??created?.vendorId; if(vid) els.vendorSelect.value=vid;
}catch(e){ alert('Create vendor failed: '+e.message); }});
els.confSelect.addEventListener('change',async()=>{ await loadVendorsForConference(els.confSelect.value,els.vendorSelect); });

els.btnStart.addEventListener('click',async()=>{ if(!store.api) return alert('Configure API first.');
  els.btnStart.disabled=true; els.btnStop.disabled=false; try{ await startRec(); log('Session started. Recording in progress.'); }catch(e){ els.btnStart.disabled=false; els.btnStop.disabled=true; alert('Cannot start recording: '+e.message); }});
els.btnStop.addEventListener('click',async()=>{ els.btnStop.disabled=true;
  try{
    const audioBlob=await stopRec(); if(!audioBlob) throw new Error('No audio captured.');
    let conferenceId=els.confSelect.value||null, vendorId=els.vendorSelect.value||null;
    if(!conferenceId || !vendorId){ const unk=await ensureUnknowns(); conferenceId=conferenceId||unk.conferenceId; vendorId=vendorId||unk.vendorId; log(`Using unknown placeholders ‚Äî conference: ${conferenceId}, vendor: ${vendorId}`); }
    const sessionId=await uploadSession({audioBlob, images:imageFiles, notes:els.notes.value, conferenceId, vendorId});
    alert('Uploaded! Session ID: '+sessionId+'\\nEnrichment started.');
  }catch(e){ alert('Upload failed: '+e.message); }
  finally{ els.btnStart.disabled=false; imageFiles=[]; renderImgs(); els.notes.value=''; }});

els.btnPrevious.addEventListener('click',async()=>{ await loadConferences(els.prevConf); if(els.prevConf.value) await loadVendorsForConference(els.prevConf.value, els.prevVendor);
  document.querySelectorAll('h2')[1]?.scrollIntoView({behavior:'smooth'}); });
els.prevConf.addEventListener('change',async()=>{ await loadVendorsForConference(els.prevConf.value, els.prevVendor); });
els.btnLoadSessions.addEventListener('click',async()=>{ els.prevList.innerHTML='<div class="section"><em>Loading‚Ä¶</em></div>'; try{ await loadPrevious(els.prevConf.value||null, els.prevVendor.value||null); }catch(e){ els.prevList.innerHTML=`<div class="section"><strong>Error:</strong> ${esc(e.message)}</div>`; }});

/* Logs modal */
els.btnLogs.addEventListener('click',()=>{ els.logsView.textContent=logBuffer.map(l=>{const base=`${l.t} [${(l.level||'info').toUpperCase()}] ${l.msg}${l.extra?(' '+l.extra):''}`; return l.body?base+`\\n  response: ${typeof l.body==='string'?l.body:JSON.stringify(l.body)}`:base; }).join('\\n'); els.logsDialog.showModal(); });
els.btnCloseLogs.addEventListener('click',()=>els.logsDialog.close());
els.btnCopyLogs.addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(els.logsView.textContent||''); alert('Logs copied'); }catch(_){ alert('Copy failed. Select text and copy manually.'); }});
function downloadBlob(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); }
els.btnDownloadTxt.addEventListener('click',()=>{ downloadBlob('cb-logs.txt', new Blob([els.logsView.textContent||''],{type:'text/plain'})); });
els.btnDownloadJson.addEventListener('click',()=>{ downloadBlob('cb-logs.json', new Blob([JSON.stringify(logBuffer,null,2)],{type:'application/json'})); });

/* ===== Boot ===== */
async function boot(){
  const cfg=store.api;
  if(cfg){ setConnected(true);
    try{
      await loadConferences(els.confSelect);
      if(els.confSelect.value) await loadVendorsForConference(els.confSelect.value, els.vendorSelect);
      await loadConferences(els.prevConf);
      if(els.prevConf.value) await loadVendorsForConference(els.prevConf.value, els.prevVendor);
      log('Dropdowns populated from API.');
      if(!els.confSelect.options.length) log('No conferences found (OK). You can record without selecting; we‚Äôll use ‚ÄúUnknown Conference‚Äù.','warn');
    }catch(e){
      log('Could not load initial data: '+e.message,'error');
      if(String(e).includes('HTTP 401')) log('Hint: Check API Key and modes.','warn');
    }
  } else { setConnected(false); els.authDialog.showModal(); }
}
boot();
</script>
</body>
</html>
