<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ConferenceBuddy ‚Äì Session Recorder (Mobile)</title>
<style>
  :root{
    --bg:#0b1220; --panel:#0f1a2b; --accent:#1c66ff; --accent-2:#2a84ff;
    --text:#e8f0ff; --muted:#9fb7ff; --bad:#ff5a6b; --good:#3bcf8e; --warn:#ffb020;
    --card:#111d33; --chip:#0c1730; --border:#1c2a45;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:linear-gradient(180deg,#08101e, #0b1220 40%, #0b1220);
    color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial;
  }
  .topbar{
    position:sticky;top:0;z-index:50;background:rgba(10,18,34,.9);backdrop-filter:saturate(1.2) blur(8px);
    border-bottom:1px solid var(--border);
  }
  .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;padding:.6rem .8rem}
  .grow{flex:1}
  .btn{
    -webkit-tap-highlight-color: transparent;
    display:inline-flex;align-items:center;justify-content:center;gap:.4rem;
    padding:.75rem 1rem;border-radius:14px;border:1px solid var(--border);
    background:linear-gradient(180deg,#0f1d3a,#0a1730); color:var(--text);
    font-weight:600; letter-spacing:.2px; box-shadow:0 1px 0 rgba(255,255,255,.05) inset;
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));border-color:#3a6dff;color:white}
  .btn.warn{background:linear-gradient(180deg,#2a2130,#1b1422);border-color:#4a2a3a}
  .btn.good{background:linear-gradient(180deg,#0f2b23,#0b231c);border-color:#1f614d}
  .btn.ghost{background:transparent}
  .chip{padding:.35rem .6rem;border:1px solid var(--border);border-radius:999px;background:var(--chip);color:var(--muted);font-size:.8rem}
  .section{padding:.8rem}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:.9rem}
  .stack{display:flex;flex-direction:column;gap:.7rem}
  .grid{display:grid;gap:.7rem}
  .cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  label{font-size:.85rem;color:var(--muted)}
  select, input[type="text"], input[type="url"], input[type="date"], textarea{
    width:100%; padding:.75rem .8rem; border-radius:12px; background:#0a1426; color:var(--text);
    border:1px solid var(--border); outline:none;
  }
  textarea{min-height:140px; resize:vertical}
  .thumbs{display:flex; gap:.6rem; flex-wrap:wrap}
  .thumb{width:88px; height:88px; border-radius:12px; border:1px solid var(--border); background:#091426; overflow:hidden}
  .thumb img{width:100%; height:100%; object-fit:cover}
  .muted{color:var(--muted); font-size:.9rem}
  .divider{height:1px;background:var(--border);margin:.6rem 0}
  .list{display:flex; flex-direction:column; gap:.6rem; max-height:40vh; overflow:auto}
  .row-between{display:flex; align-items:center; justify-content:space-between; gap:.5rem}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .logwrap{max-height:40vh; overflow:auto; background:#071022; border-radius:12px; border:1px solid var(--border); padding:.6rem}
  .pill{padding:.2rem .5rem; border-radius:999px; font-size:.75rem}
  .ok{background:#102b1f; color:#63e2a8; border:1px solid #1f614d}
  .err{background:#2b1216; color:#ff8ea0; border:1px solid #5a2a34}
  .warn{background:#2b2410; color:#ffd479; border:1px solid #5c4a1a}
  .tiny{font-size:.8rem}
  .footer-pad{height:20vh}
</style>
</head>
<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="row">
      <button id="btnApi" class="btn">API</button>
      <button id="btnLogs" class="btn">Logs</button>
      <button id="btnSelfTest" class="btn">Self-Test</button>
      <div class="grow"></div>
      <span class="chip" id="statusChip">Disconnected</span>
    </div>
  </div>

  <!-- API Panel -->
  <div class="section">
    <div class="card stack" id="apiPanel" hidden>
      <div class="grid cols-2">
        <div class="stack">
          <label for="apiBase">API Base URL</label>
          <input id="apiBase" type="url" placeholder="https://‚Ä¶/api" inputmode="url" autocomplete="url" />
        </div>
        <div class="stack">
          <label for="apiKey">API Key</label>
          <input id="apiKey" type="text" placeholder="X-API-Key" inputmode="text" autocomplete="off" />
        </div>
      </div>
      <div class="row">
        <button id="btnSaveCfg" class="btn primary">Save & Connect</button>
        <button id="btnPing" class="btn">Health</button>
        <button id="btnClearCfg" class="btn warn">Clear</button>
      </div>
      <div class="muted tiny">Tip: Base must include <span class="mono">/api</span>. Example: <span class="mono">https://conference-buddy‚Ä¶/api</span></div>
    </div>
  </div>

  <!-- Session Recorder (Mobile-first) -->
  <div class="section">
    <div class="card stack">
      <div class="row-between">
        <div>
          <div style="font-weight:700">Session Recorder</div>
          <div class="muted tiny">Start captures audio immediately; images & notes optional.</div>
        </div>
        <div id="recState" class="pill warn">Idle</div>
      </div>

      <div class="grid cols-2">
        <div class="stack">
          <label for="confSelect">Conference</label>
          <select id="confSelect"></select>
        </div>
        <div class="stack">
          <label for="vendorSelect">Vendor</label>
          <select id="vendorSelect"></select>
        </div>
      </div>

      <div class="grid cols-2">
        <div class="stack">
          <label for="newConfName">New Conference (quick add)</label>
          <input id="newConfName" type="text" placeholder="eg. Conf 2025" />
        </div>
        <div class="stack">
          <label for="newVendorName">New Vendor (quick add)</label>
          <input id="newVendorName" type="text" placeholder="eg. Acme Co." />
        </div>
      </div>

      <div class="stack">
        <label for="notes">Notes</label>
        <textarea id="notes" placeholder="Type notes while recording‚Ä¶"></textarea>
      </div>

      <div class="stack">
        <label>Photos (multiple)</label>
        <div class="row" style="gap:.6rem;flex-wrap:wrap">
          <input id="photoInput" type="file" accept="image/*" capture="environment" multiple />
          <button id="btnCamera" class="btn">Open Camera</button>
          <div id="photoThumbs" class="thumbs"></div>
        </div>
      </div>

      <div class="row" style="flex-wrap:wrap; gap:.6rem">
        <button id="btnStart" class="btn primary">Start Session</button>
        <button id="btnStop" class="btn warn" disabled>Stop & Upload</button>
        <button id="btnClear" class="btn ghost">Clear Media</button>
      </div>

      <div class="row-between tiny">
        <div>Audio size: <span id="audioSize">0.00 MB</span> ‚Ä¢ Images: <span id="imgCount">0</span></div>
        <div class="muted">Type: <span id="audioType">‚Äì</span></div>
      </div>
    </div>
  </div>

  <!-- Previous Sessions -->
  <div class="section">
    <div class="card stack">
      <div class="row-between">
        <div style="font-weight:700">Previous Sessions</div>
        <button id="btnLoadSessions" class="btn">View All</button>
      </div>
      <div id="sessionsList" class="list"></div>
    </div>
  </div>

  <!-- Logs Panel -->
  <div class="section" id="logsPanel" hidden>
    <div class="card stack">
      <div class="row-between">
        <div style="font-weight:700">Diagnostics & Logs</div>
        <div class="row">
          <button id="btnLogLevel" class="btn">Verbose</button>
          <button id="btnCopyLogs" class="btn">Copy</button>
          <button id="btnDownloadTxt" class="btn">.txt</button>
          <button id="btnDownloadJson" class="btn">.json</button>
        </div>
      </div>
      <div class="logwrap mono tiny" id="logOutput" aria-live="polite"></div>
    </div>
  </div>

  <div class="footer-pad"></div>

<script>
/* ==========================================================
   Lightweight Client ‚Äì API + Logger + WAV Recorder (mobile)
   ========================================================== */

const $ = (id)=>document.getElementById(id);

// ---------- Logger ----------
const LOGS = [];
let VERBOSE = true;
function log(level, msg, extra){
  const entry = { t:new Date().toISOString(), level, msg:String(msg), extra: extra ?? "" };
  LOGS.push(entry);
  if (!document.hidden && (level!=='debug' || VERBOSE)) {
    const el = $("logOutput");
    if (el) {
      const pill = level==='error'?'err':level==='warn'?'warn':'ok';
      const line = `<div><span class="pill ${pill}">${level.toUpperCase()}</span> <span>${escapeHtml(entry.msg)}</span></div>`;
      el.insertAdjacentHTML('afterbegin', line);
    }
  }
  // console mirror
  (level==='error'?console.error:level==='warn'?console.warn:console.log)(msg, extra||'');
}
function escapeHtml(s){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
function download(name, text, type='text/plain'){
  const blob = new Blob([text], {type}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove()}, 0);
}

// ---------- Config ----------
const CFG_KEY = 'cb_cfg_v2';
let CFG = { base:'', key:'' };
function saveCfg(){ localStorage.setItem(CFG_KEY, JSON.stringify(CFG)); log('info','Config updated.'); }
function loadCfg(){
  try{ const j = localStorage.getItem(CFG_KEY); if (j) CFG = JSON.parse(j) }catch{}
  $("apiBase").value = CFG.base||''; $("apiKey").value = CFG.key||'';
  setChip();
}
function setChip(ok){
  const chip = $("statusChip");
  if (!CFG.base || !CFG.key){ chip.textContent="Disconnected"; chip.className="chip"; return; }
  chip.textContent = ok===false ? "Connected (warn)" : "Connected";
  chip.className="chip";
}

// ---------- HTTP helper ----------
async function http(method, path, {json, form, raw, headers}={}){
  if (!CFG.base) throw new Error("API base URL not configured.");
  const url = CFG.base.replace(/\/$/, '') + path;
  const id = Math.random().toString(36).slice(2);
  const reqHeaders = { 'Accept':'application/json', 'X-API-Key': CFG.key, ...(headers||{}) };

  let body, initHeaders = {...reqHeaders};
  if (json){
    initHeaders['Content-Type']='application/json';
    body = JSON.stringify(json);
  } else if (form){
    // Do NOT set Content-Type when sending FormData
    body = form;
  } else if (raw){
    body = raw;
  }

  log('info', `HTTP ${method} ${url}`, '‚Üí request');
  log('info', JSON.stringify({id, method, url, reqHeaders:initHeaders}), '');

  const t0 = performance.now();
  const res = await fetch(url, { method, headers:initHeaders, body, mode:'cors' });
  const dur = Math.round(performance.now()-t0);

  const ctype = res.headers.get('content-type')||'';
  let data;
  if (ctype.includes('application/json')){
    data = await res.json();
  } else {
    data = await res.text();
  }
  log('info', `HTTP ${method} ${url}`, `‚Üê ${res.status}  (${dur}ms)`);
  log('info', JSON.stringify({id, dur:String(dur), status:res.status, resHeaders: Object.fromEntries(res.headers.entries()), body: typeof data==='string'?data:JSON.stringify(data)+"\n"}), '');
  if (!res.ok){
    const err = new Error(`HTTP ${res.status} ‚Äî ${typeof data==='string'?data:JSON.stringify(data)}`);
    log('error', `HTTP ${method} ${url}`, `‚úñ ${err.message} (${dur}ms)`);
    throw err;
  }
  return data;
}

// ---------- API Wrappers ----------
const api = {
  health: ()=> http('GET','/health'),
  conferences: ()=> http('GET','/conferences'),
  vendors: ()=> http('GET','/vendors'),
  vendorsByConf: (confId)=> http('GET', `/conferences/${confId}/vendors`),
  createConference: ({name, start_date, end_date})=> http('POST','/conferences',{json:{name, start_date, end_date}}),
  createVendor: ({conference_id, name})=> http('POST','/vendors',{json:{conference_id, name}}),
  getVendor: (id)=> http('GET', `/vendors/${id}`),
  listSessions: ()=> http('GET','/sessions'),
  uploadSessionMultipart: (fd)=> http('POST','/sessions/upload',{form:fd}),
  triggerEnrichment: (sessionId)=> http('POST', `/sessions/${sessionId}/trigger-enrichment`, {json:{reason:'user_requested'}}),
};

// ---------- UI refs ----------
const els = {
  confSelect: $("confSelect"),
  vendorSelect: $("vendorSelect"),
  newConfName: $("newConfName"),
  newVendorName: $("newVendorName"),
  notes: $("notes"),
  btnStart: $("btnStart"),
  btnStop: $("btnStop"),
  btnClear: $("btnClear"),
  photoInput: $("photoInput"),
  btnCamera: $("btnCamera"),
  photoThumbs: $("photoThumbs"),
  audioSize: $("audioSize"),
  audioType: $("audioType"),
  recState: $("recState"),
  sessionsList: $("sessionsList"),
};

// ---------- Media (WAV recorder fallback) ----------
let mediaStream, wavRecorder=null;

function createWavRecorder(){
  let ctx, source, proc, buffersL=[], buffersR=[], sampleRate=44100, recording=false, bytes=0;
  return {
    async start(){
      if (!mediaStream) mediaStream = await navigator.mediaDevices.getUserMedia({audio:true});
      ctx = new (window.AudioContext||window.webkitAudioContext)({ sampleRate });
      source = ctx.createMediaStreamSource(mediaStream);
      const bufferSize = 4096;
      proc = ctx.createScriptProcessor(bufferSize, 2, 2);
      proc.onaudioprocess = (e)=>{
        if (!recording) return;
        const L = e.inputBuffer.getChannelData(0).slice(0);
        const R = e.inputBuffer.numberOfChannels>1 ? e.inputBuffer.getChannelData(1).slice(0) : L;
        buffersL.push(L); buffersR.push(R);
        bytes += L.length*2 + R.length*2;
      };
      source.connect(proc); proc.connect(ctx.destination);
      recording = true;
    },
    async stop(){
      if (!mediaStream) return new Blob([]);
      // stop stream tracks (do not close ctx until export)
      mediaStream.getTracks().forEach(t=>t.stop());
      // PCM merge
      const merge = (bufs)=>{
        let len=0; bufs.forEach(b=>len+=b.length);
        const out = new Float32Array(len);
        let off=0; bufs.forEach(b=>{out.set(b,off); off+=b.length});
        return out;
      };
      const interleave = (L,R)=>{
        const len = L.length + R.length; const out = new Float32Array(len);
        let i=0,j=0;
        while(i<L.length && j<R.length){
          out[j+i] = L[i]; out[j+i+1] = R[i]; i++; j++;
        }
        return out;
      };
      const writeWav = (samples, sr=sampleRate)=>{
        // 16-bit PCM WAV writer
        const bytesPerSample = 2;
        const dataSize = samples.length * bytesPerSample;
        const buffer = new ArrayBuffer(44 + dataSize);
        const view = new DataView(buffer);
        const writeString = (off,str)=>{ for (let i=0;i<str.length;i++) view.setUint8(off+i, str.charCodeAt(i)); };
        let offset=0;
        writeString(0,'RIFF'); view.setUint32(4, 36 + dataSize, true); writeString(8,'WAVE');
        writeString(12,'fmt '); view.setUint32(16,16,true); view.setUint16(20,1,true); // PCM
        view.setUint16(22,2,true); // channels
        view.setUint32(24,sr,true); view.setUint32(28, sr*4,true); view.setUint16(32,4,true); view.setUint16(34,16,true);
        writeString(36,'data'); view.setUint32(40,dataSize,true);
        offset = 44;
        // float [-1,1] -> int16
        for (let i=0;i<samples.length;i++, offset+=2){
          let s = Math.max(-1, Math.min(1, samples[i]));
          view.setInt16(offset, s<0 ? s*0x8000 : s*0x7FFF, true);
        }
        return new Blob([view], {type:'audio/wav'});
      };
      // export
      const L = merge(buffersL); const R = merge(buffersR);
      const inter = interleave(L,R);
      const wav = writeWav(inter, ctx.sampleRate);
      // cleanup
      try{ proc.disconnect(); source.disconnect(); ctx.close(); }catch{}
      buffersL=[]; buffersR=[]; recording=false; bytes=0; mediaStream=null;
      return wav;
    }
  };
}

// ---------- App state ----------
let currentStartISO = null;
let capturedAudioBlob = null;
let capturedPhotos = []; // File[]
let uploading = false;

// ---------- UI helpers ----------
function setRecState(s){ els.recState.textContent=s; }
function setButtonsRecording(on){
  els.btnStart.disabled = on;
  els.btnStop.disabled = !on;
}
function updateCounters(){
  const mb = (capturedAudioBlob? capturedAudioBlob.size : 0)/ (1024*1024);
  $("audioSize").textContent = mb.toFixed(2) + " MB";
  $("imgCount").textContent = String(capturedPhotos.length);
  $("audioType").textContent = capturedAudioBlob? (capturedAudioBlob.type||'audio/wav') : '‚Äì';
}
function addThumb(file){
  const url = URL.createObjectURL(file);
  const div = document.createElement('div'); div.className='thumb';
  div.innerHTML = `<img alt="">`;
  div.querySelector('img').src = url;
  els.photoThumbs.appendChild(div);
}
function resetMedia(){
  capturedAudioBlob = null; capturedPhotos = []; els.photoThumbs.innerHTML='';
  updateCounters();
}

// ---------- Data loaders ----------
async function populateDropdowns(){
  const conferences = await api.conferences();
  const confSel = els.confSelect; confSel.innerHTML='';
  const blankOpt = document.createElement('option'); blankOpt.value=''; blankOpt.textContent='(no conference)';
  confSel.appendChild(blankOpt);
  (conferences.data||[]).forEach(c=>{
    const o = document.createElement('option'); o.value=c.id; o.textContent=c.name; confSel.appendChild(o);
  });

  // initial vendors (all)
  const vendors = await api.vendors();
  const vendSel = els.vendorSelect; vendSel.innerHTML='';
  const blankV = document.createElement('option'); blankV.value=''; blankV.textContent='(no vendor)';
  vendSel.appendChild(blankV);
  (vendors.data||[]).forEach(v=>{
    const o = document.createElement('option'); o.value=v.id; o.textContent=v.name; vendSel.appendChild(o);
  });

  log('info','Dropdowns populated from API.');
}
els.confSelect?.addEventListener('change', async (e)=>{
  const confId = e.target.value;
  if (!confId){
    // Load all vendors
    const vendors = await api.vendors();
    els.vendorSelect.innerHTML='';
    const blankV = document.createElement('option'); blankV.value=''; blankV.textContent='(no vendor)';
    els.vendorSelect.appendChild(blankV);
    (vendors.data||[]).forEach(v=>{
      const o = document.createElement('option'); o.value=v.id; o.textContent=v.name; els.vendorSelect.appendChild(o);
    });
    return;
  }
  const resp = await api.vendorsByConf(confId);
  els.vendorSelect.innerHTML='';
  const blankV = document.createElement('option'); blankV.value=''; blankV.textContent='(no vendor)';
  els.vendorSelect.appendChild(blankV);
  (resp.data||[]).forEach(v=>{
    const o = document.createElement('option'); o.value=v.id; o.textContent=v.name; els.vendorSelect.appendChild(o);
  });
});

// ---------- Unknown helpers ----------
async function ensureUnknownConferenceId(){
  const today = new Date().toISOString().slice(0,10);
  const list = await api.conferences();
  const found = (list.data||[]).find(c=> (c.name||'').toLowerCase()==='unknown conference');
  if (found) return found.id;
  const created = await api.createConference({name:'Unknown Conference', start_date:today, end_date:today});
  return created.data?.id || created.id || created.conference_id || created?.data?.conference_id;
}
async function ensureUnknownVendorId(confId){
  // Try to find by name under all vendors
  const vList = await api.vendors();
  const found = (vList.data||[]).find(v=> (v.name||'').toLowerCase()==='unknown vendor' && v.conference_id===confId);
  if (found) return found.id;
  const created = await api.createVendor({conference_id:confId, name:'Unknown Vendor'});
  return created.data?.id || created.id || created.vendor_id || created?.data?.vendor_id;
}

// ---------- Start / Stop flow ----------
els.btnStart?.addEventListener('click', async ()=>{
  try{
    // Resolve conference/vendor (or unknown)
    let confId = els.confSelect.value;
    let vendorId = els.vendorSelect.value;

    if (!confId && els.newConfName.value.trim()){
      const today = new Date().toISOString().slice(0,10);
      const created = await api.createConference({name: els.newConfName.value.trim(), start_date:today, end_date:today});
      confId = created.data?.id || created.id;
      log('info', `Created conference: ${confId}`);
    }
    if (!confId){
      confId = await ensureUnknownConferenceId();
      log('warn', `No conference selected, using Unknown: ${confId}`);
    }

    if (!vendorId && els.newVendorName.value.trim()){
      const created = await api.createVendor({conference_id: confId, name: els.newVendorName.value.trim()});
      vendorId = created.data?.id || created.id;
      log('info', `Created vendor: ${vendorId}`);
    }
    if (!vendorId){
      vendorId = await ensureUnknownVendorId(confId);
      log('warn', `No vendor selected, using Unknown: ${vendorId}`);
    }

    // store for upload
    els.btnStart.dataset.confId = confId;
    els.btnStart.dataset.vendorId = vendorId;

    // Start WAV recorder
    wavRecorder = createWavRecorder();
    await wavRecorder.start();
    currentStartISO = new Date().toISOString();
    setRecState('Recording‚Ä¶');
    setButtonsRecording(true);
    log('info','Audio recording started.');
  }catch(err){
    log('error','Failed to start recording: '+err.message);
    alert('Microphone permission required or start failed.\n'+err.message);
  }
});

els.btnStop?.addEventListener('click', async ()=>{
  try{
    setRecState('Stopping‚Ä¶');
    log('info','Stopping recorder‚Ä¶');
    if (wavRecorder){
      capturedAudioBlob = await wavRecorder.stop();
      log('info', `Audio captured: ${(capturedAudioBlob.size/1024/1024).toFixed(2)} MB`);
    }
    updateCounters();
    const endISO = new Date().toISOString();

    const confId = els.btnStart.dataset.confId;
    const vendorId = els.btnStart.dataset.vendorId;

    // Build multipart form for /sessions/upload
    const fd = new FormData();
    fd.append('vendor_id', vendorId);
    fd.append('conference_id', confId);
    fd.append('start_time', currentStartISO);
    fd.append('end_time', endISO);
    const notesTxt = els.notes.value || '';
    if (notesTxt) fd.append('user_notes', notesTxt);
    // audio (API supports: mp3, wav, m4a, aac, ogg). We generate WAV.
    if (capturedAudioBlob && capturedAudioBlob.size>0){
      const wavFile = new File([capturedAudioBlob], 'session_audio.wav', {type: 'audio/wav'});
      fd.append('audio_file', wavFile);
    }
    // photos (multiple)
    for (const f of capturedPhotos){ fd.append('photos', f, f.name); }

    uploading = true;
    const res = await api.uploadSessionMultipart(fd);
    uploading = false;

    // API returns 201 with data; try to get session id from common shapes
    const sessionId = res.data?.id || res.session_id || res.id;
    log('info', `Upload success. Session ID: ${sessionId||'(unknown)'}`);

    // Trigger enrichment (best-effort)
    if (sessionId){
      try{
        await api.triggerEnrichment(sessionId);
        log('info', 'Enrichment triggered.');
      }catch(e){ log('warn', 'Enrichment trigger failed (non-fatal): '+e.message); }
    }

    // Clear notes on success & media
    els.notes.value = '';
    resetMedia();
    currentStartISO = null;
    setRecState('Idle');
    setButtonsRecording(false);
    alert('Session uploaded successfully.');
  }catch(err){
    uploading = false;
    setRecState('Idle');
    setButtonsRecording(false);
    log('error', 'Upload failed: '+err.message+'\n');
    alert('Upload failed:\n'+err.message);
  }
});

els.btnClear?.addEventListener('click', ()=>{
  resetMedia(); els.notes.value='';
});

// Photos
els.photoInput?.addEventListener('change', ()=>{
  for (const file of els.photoInput.files||[]){
    capturedPhotos.push(file); addThumb(file);
  }
  updateCounters();
});
els.btnCamera?.addEventListener('click', ()=> els.photoInput.click());

// ---------- Sessions list ----------
$("btnLoadSessions")?.addEventListener('click', async ()=>{
  const list = await api.listSessions();
  const el = $("sessionsList"); el.innerHTML='';
  (list.data||list.sessions||[]).forEach(s=>{
    const div = document.createElement('div');
    div.className='card';
    const title = s.start_time || s.created_at || '(unknown time)';
    const id = s.id || s.session_id || '';
    const photos = (s.photo_urls||[]).length;
    const aud = s.audio_file_url ? 'üéôÔ∏è' : '‚Äî';
    div.innerHTML = `
      <div class="row-between">
        <div style="font-weight:600">${title}</div>
        <span class="chip">${s.processing_status||s.status||''}</span>
      </div>
      <div class="tiny muted mono">ID: ${id}</div>
      <div class="tiny">Audio: ${aud} ‚Ä¢ Images: ${photos}</div>
      <div class="divider"></div>
      <div class="tiny">${escapeHtml(s.user_notes||'')}</div>
    `;
    el.appendChild(div);
  });
});

// ---------- Top bar actions ----------
$("btnApi")?.addEventListener('click', ()=>{ const p=$("apiPanel"); p.hidden=!p.hidden; });
$("btnLogs")?.addEventListener('click', ()=>{ const p=$("logsPanel"); p.hidden=!p.hidden; });
$("btnSelfTest")?.addEventListener('click', async ()=>{
  try{
    const ok = await api.health();
    alert('Health: '+JSON.stringify(ok));
  }catch(e){
    alert('Health failed: '+e.message);
  }
});
$("btnSaveCfg")?.addEventListener('click', async ()=>{
  CFG.base = $("apiBase").value.trim();
  CFG.key = $("apiKey").value.trim();
  saveCfg(); setChip(false);
  try{ await initLoad(); setChip(true); }catch(e){ log('error','Could not load initial data: '+e.message); }
});
$("btnPing")?.addEventListener('click', async ()=>{
  try{ const h= await api.health(); alert(JSON.stringify(h)); }catch(e){ alert(e.message) }
});
$("btnClearCfg")?.addEventListener('click', ()=>{
  CFG={base:'',key:''}; saveCfg(); loadCfg();
});

// Logs panel actions
$("btnLogLevel")?.addEventListener('click', ()=>{
  VERBOSE=!VERBOSE; $("btnLogLevel").textContent = VERBOSE ? 'Verbose' : 'Compact';
});
$("btnCopyLogs")?.addEventListener('click', async ()=>{
  const txt = LOGS.map(l=>JSON.stringify(l)).join("\n");
  await navigator.clipboard.writeText(txt);
  alert('Logs copied.');
});
$("btnDownloadTxt")?.addEventListener('click', ()=>{
  const txt = LOGS.map(l=>`${l.t} [${l.level.toUpperCase()}] ${l.msg} ${l.extra||''}`).join("\n");
  download(`cb-logs-${new Date().toISOString().replace(/[:.]/g,'-')}.txt`, txt);
});
$("btnDownloadJson")?.addEventListener('click', ()=>{
  download(`cb-logs-${new Date().toISOString().replace(/[:.]/g,'-')}.json`, JSON.stringify(LOGS,null,2), 'application/json');
});

// ---------- Bootstrap ----------
async function initLoad(){
  if (!CFG.base || !CFG.key){ log('error','Could not load initial data: API base URL not configured.'); return; }
  try{
    await populateDropdowns();
  }catch(e){ log('error','Could not load initial data: '+e.message); }
}
document.addEventListener('DOMContentLoaded', ()=>{
  loadCfg();
  // sensible defaults for quick testing if fields are empty (no write!)
  if (!CFG.base) $("apiBase").placeholder = "https://conference-buddy-geoutils.replit.app/api";
});
</script>
</body>
</html>
