<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
  />
  <title>conferenceBuddy — Session Recorder</title>
  <style>
    :root{
      --bg:#0b132b;        /* dark blue */
      --panel:#1c2541;     /* mid blue */
      --accent:#3a506b;    /* slate blue */
      --ink:#e6f1ff;       /* white-ish text */
      --muted:#9fb3c8;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
      --btn:#1f6feb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background:var(--bg); color:var(--ink);
    }
    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; gap:.5rem; align-items:center; padding:.5rem;
      background:linear-gradient(180deg,var(--bg),rgba(11,19,43,.9));
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar input[type="text"]{
      width:100%; max-width:420px; background:var(--panel); color:var(--ink);
      border:1px solid rgba(255,255,255,.12); border-radius:.5rem; padding:.6rem .7rem;
    }
    .topbar input[type="password"]{ width:220px }
    .btn{
      background:var(--btn); color:#fff; border:none; border-radius:.55rem;
      padding:.6rem .8rem; font-weight:600; cursor:pointer;
    }
    .btn.secondary{ background:var(--accent) }
    .btn.ghost{
      background:transparent; border:1px solid rgba(255,255,255,.18);
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed }
    .wrap{ display:flex; flex-direction:column; gap:.8rem; padding:.8rem }
    .card{
      background:var(--panel); border:1px solid rgba(255,255,255,.08);
      border-radius:1rem; padding:.9rem;
    }
    .row{ display:flex; gap:.7rem; flex-wrap:wrap; align-items:center }
    label{ font-size:.85rem; color:var(--muted) }
    select, textarea{
      width:100%; background:#0f1832; color:var(--ink);
      border:1px solid rgba(255,255,255,.12); border-radius:.6rem; padding:.6rem;
    }
    textarea{ min-height:120px }
    .grid{
      display:grid; gap:.7rem;
      grid-template-columns:1fr;
    }
    @media (min-width:700px){
      .grid{ grid-template-columns:1fr 1fr }
    }
    .previewImgs{ display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.4rem }
    .previewImgs img{ width:78px; height:78px; object-fit:cover; border-radius:.5rem; border:1px solid rgba(255,255,255,.12) }
    .logbar{ display:flex; gap:.4rem; align-items:center; flex-wrap:wrap }
    .logs{
      height:220px; overflow:auto; background:#0a1026; border-radius:.6rem; padding:.6rem;
      border:1px solid rgba(255,255,255,.08); font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.85rem;
      color:#d9e6ff; white-space:pre-wrap;
    }
    .pill{ padding:.2rem .5rem; border-radius:999px; font-size:.74rem; border:1px solid rgba(255,255,255,.14); color:var(--muted)}
    .success{ color:var(--ok) } .warning{ color:var(--warn)} .error{ color:var(--err)}
    .sectionTitle{ font-weight:700; margin:0 0 .4rem 0 }
    .note{ color:var(--muted); font-size:.86rem }
    .list{
      display:flex; flex-direction:column; gap:.5rem; max-height:360px; overflow:auto;
      background:#0f1832; border:1px solid rgba(255,255,255,.08); border-radius:.6rem; padding:.5rem;
    }
    .item{
      border:1px solid rgba(255,255,255,.1); border-radius:.6rem; padding:.6rem; background:#111a36;
    }
    .muted{ color:var(--muted) }
  </style>
</head>
<body>
  <div class="topbar">
    <button id="btnApi" class="btn ghost" title="API Base & Key">API</button>
    <button id="btnLogs" class="btn ghost">Logs</button>
    <button id="btnSelfTest" class="btn ghost">Self-Test</button>

    <span class="pill" id="statusPill">Not connected</span>
    <input id="apiBase" type="text" placeholder="API Base e.g. https://…/api" />
    <input id="apiKey" type="password" placeholder="API Key" />
    <button id="btnSaveCfg" class="btn">Save</button>
  </div>

  <div class="wrap">
    <!-- Recording / Capture -->
    <div class="card">
      <h3 class="sectionTitle">Session Recording</h3>
      <div class="grid">
        <div>
          <div class="row">
            <div style="flex:1">
              <label for="selConf">Conference</label>
              <select id="selConf"></select>
            </div>
            <button id="btnAddConf" class="btn secondary">+ Conference</button>
          </div>
          <div class="row" style="margin-top:.5rem">
            <div style="flex:1">
              <label for="selVendor">Vendor</label>
              <select id="selVendor"></select>
            </div>
            <button id="btnAddVendor" class="btn secondary">+ Vendor</button>
          </div>
          <p class="note" id="unknownNote" style="display:none">No selection — will use <b>Unknown Conference/Vendor</b>.</p>

          <div class="row" style="margin-top:.5rem">
            <button id="btnStart" class="btn">Start Session</button>
            <button id="btnStop" class="btn" disabled>Stop & Upload</button>
          </div>
          <p class="note" id="recStatus">Idle.</p>

          <div style="margin-top:.6rem">
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="Type session notes… (saved as user_notes)"></textarea>
          </div>
        </div>

        <div>
          <label>Photos</label>
          <input id="photos" type="file" accept="image/*" multiple />
          <div class="previewImgs" id="photoPreview"></div>

          <div style="margin-top:.6rem">
            <label>Audio file (optional override)</label>
            <input id="audioFile" type="file" accept="audio/*" />
            <p class="note">If present, this file is used instead of the live recording.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Previous Sessions -->
    <div class="card">
      <h3 class="sectionTitle">Previous Sessions (by Vendor)</h3>
      <div class="row">
        <button id="btnRefreshVendor" class="btn ghost">Refresh Vendor Sessions</button>
      </div>
      <div id="prevSessions" class="list" aria-live="polite"></div>
    </div>

    <!-- Logs -->
    <div class="card">
      <div class="row logbar">
        <h3 class="sectionTitle" style="margin-right:auto">Diagnostics & Logs</h3>
        <button id="btnVerbose" class="btn ghost">Verbose</button>
        <button id="btnCopy" class="btn ghost">Copy</button>
        <button id="btnExportTxt" class="btn ghost">.txt</button>
        <button id="btnExportJson" class="btn ghost">.json</button>
        <button id="btnClear" class="btn ghost">Clear</button>
      </div>
      <div class="logs" id="logs" role="log"></div>
    </div>
  </div>

  <script>
    // ---------------------------
    // Tiny structured logger
    // ---------------------------
    const Log = (() => {
      const el = () => document.getElementById('logs');
      let store = [];
      let verbose = true;
      function now(){ return new Date().toISOString() }
      function push(level,msg,extra="",obj=null){
        const entry = { t: now(), level, msg, extra };
        if (obj) Object.assign(entry, obj);
        store.push(entry);
        if(el()){
          const line = JSON.stringify(entry,null,2);
          el().textContent += (el().textContent ? "\n" : "") + line;
          el().scrollTop = el().scrollHeight;
        }
        if (verbose) console[level==="error"?"error":(level==="warn"?"warn":"log")](entry);
      }
      return {
        info:(m,e="",o)=>push("info",m,e,o),
        warn:(m,e="",o)=>push("warn",m,e,o),
        error:(m,e="",o)=>push("error",m,e,o),
        setVerbose:(v)=>{ verbose=v; },
        clear:()=>{ store=[]; if(el()) el().textContent=""; },
        exportTxt:()=> new Blob([store.map(s=>JSON.stringify(s)).join("\n")],{type:"text/plain"}),
        exportJson:()=> new Blob([JSON.stringify(store,null,2)],{type:"application/json"}),
        get:()=>store.slice()
      }
    })();

    // ---------------------------
    // Config persistence
    // ---------------------------
    const cfg = {
      apiBase: localStorage.getItem("cb_api_base") || "",
      apiKey: localStorage.getItem("cb_api_key") || "",
    };
    function saveCfg(){
      const apiBase = document.getElementById('apiBase').value.trim();
      const apiKey  = document.getElementById('apiKey').value.trim();
      cfg.apiBase = apiBase; cfg.apiKey = apiKey;
      localStorage.setItem("cb_api_base", apiBase);
      localStorage.setItem("cb_api_key", apiKey);
      Log.info("Config updated.");
      setStatus("Config saved", "success");
      initData();
    }
    function setStatus(text, kind=""){
      const pill = document.getElementById('statusPill');
      pill.textContent = text;
      pill.className = "pill " + (kind||"");
    }

    // ---------------------------
    // Minimal API helpers
    // ---------------------------
    function assertCfg(){
      if(!cfg.apiBase){ throw new Error("API base URL not configured.") }
      if(!cfg.apiKey){ throw new Error("API key not configured.") }
    }
    async function apiGET(path){
      assertCfg();
      const url = cfg.apiBase.replace(/\/+$/,"") + path;
      const id = Math.random().toString(36).slice(2);
      Log.info(`HTTP GET ${url}`,"→ request");
      Log.info(JSON.stringify({id,method:"GET",url,reqHeaders:{Accept:"application/json","X-API-Key":"***"}}));
      const t0 = performance.now();
      const res = await fetch(url,{headers:{"X-API-Key":cfg.apiKey,"Accept":"application/json"}});
      const dur = Math.round(performance.now()-t0);
      Log.info(`HTTP GET ${url}`,`← ${res.status}  (${dur}ms)`);
      const body = await res.text();
      Log.info(JSON.stringify({id,dur:String(dur),status:res.status,resHeaders:objFromHeaders(res.headers),body:body+"\n"}));
      if(!res.ok) throw new Error(`HTTP ${res.status} — ${body}`);
      try { return JSON.parse(body) } catch { return body }
    }
    async function apiPOSTJson(path, payload){
      assertCfg();
      const url = cfg.apiBase.replace(/\/+$/,"") + path;
      const id = Math.random().toString(36).slice(2);
      Log.info(`HTTP POST ${url}`,"→ request");
      Log.info(JSON.stringify({id,method:"POST",url,reqHeaders:{Accept:"application/json","X-API-Key":"***","Content-Type":"application/json"}}));
      const t0 = performance.now();
      const res = await fetch(url,{
        method:"POST",
        headers:{"X-API-Key":cfg.apiKey,"Content-Type":"application/json","Accept":"application/json"},
        body: JSON.stringify(payload)
      });
      const dur = Math.round(performance.now()-t0);
      Log.info(`HTTP POST ${url}`,`← ${res.status}  (${dur}ms)`);
      const text = await res.text();
      Log.info(JSON.stringify({id,dur:String(dur),status:res.status,resHeaders:objFromHeaders(res.headers),body:text+"\n"}));
      if(!res.ok) throw new Error(`HTTP ${res.status} — ${text}`);
      try { return JSON.parse(text) } catch { return text }
    }
    async function apiPOSTForm(path, formData){
      assertCfg();
      const url = cfg.apiBase.replace(/\/+$/,"") + path;
      const id = Math.random().toString(36).slice(2);
      Log.info(`HTTP POST ${url}`,"→ request");
      Log.info(JSON.stringify({id,method:"POST",url,reqHeaders:{Accept:"application/json","X-API-Key":"***"}}));
      const t0 = performance.now();
      // IMPORTANT: DO NOT set Content-Type for multipart
      const res = await fetch(url,{ method:"POST", headers:{ "X-API-Key":cfg.apiKey }, body:formData });
      const dur = Math.round(performance.now()-t0);
      Log.info(`HTTP POST ${url}`,`← ${res.status}  (${dur}ms)`);
      const text = await res.text();
      Log.info(JSON.stringify({id,dur:String(dur),status:res.status,resHeaders:objFromHeaders(res.headers),body:text+"\n"}));
      if(!res.ok) throw new Error(`HTTP ${res.status} — ${text}`);
      try { return JSON.parse(text) } catch { return text }
    }
    function objFromHeaders(h){
      const o={}; h.forEach((v,k)=>o[k]=v); return o;
    }

    // ---------------------------
    // App state & media
    // ---------------------------
    let mediaRecorder=null, recordedChunks=[], sessionStartISO=null;
    function onPhotosChanged(){
      const pre = document.getElementById('photoPreview');
      pre.innerHTML="";
      const files = document.getElementById('photos').files || [];
      [...files].forEach(f=>{
        const url = URL.createObjectURL(f);
        const img = new Image(); img.src=url; pre.appendChild(img);
      });
    }

    async function initData(){
      // set inputs
      document.getElementById('apiBase').value = cfg.apiBase;
      document.getElementById('apiKey').value = cfg.apiKey;
      if(!cfg.apiBase || !cfg.apiKey){
        Log.error("Could not load initial data: API base URL not configured.");
        setStatus("Missing config","warning"); return;
      }
      try{
        setStatus("Connecting…","warning");
        // health (optional)
        await apiGET("/health").catch(()=>{});
        // conferences
        const confs = await apiGET("/conferences");
        fillConferences((confs && confs.data) || []);
        // vendors (fallback list)
        const vends = await apiGET("/vendors");
        fillVendors((vends && vends.data) || []);
        setStatus("Connected","success");
        Log.info("Dropdowns populated from API.");
      }catch(e){
        Log.error(`Could not load initial data: ${e.message||e}`);
        setStatus("API error","error");
      }
    }
    function fillConferences(list){
      const sel = document.getElementById('selConf');
      sel.innerHTML = `<option value="">— Select conference (or leave blank) —</option>` +
        list.map(c=>`<option value="${c.id}">${escapeHtml(c.name||"Untitled")}</option>`).join("");
    }
    function fillVendors(list){
      const sel = document.getElementById('selVendor');
      sel.innerHTML = `<option value="">— Select vendor (or leave blank) —</option>` +
        list.map(v=>`<option value="${v.id}" data-conf="${v.conference_id||""}">${escapeHtml(v.name||"Untitled")}</option>`).join("");
    }

    async function ensureUnknownsIfNeeded(){
      let confId = document.getElementById('selConf').value;
      let vendId = document.getElementById('selVendor').value;

      const unknownNote = document.getElementById('unknownNote');
      unknownNote.style.display = (!confId || !vendId) ? "block" : "none";

      // If missing, ensure "Unknown Conference" exists (start/end today)
      if(!confId){
        const today = new Date().toISOString().slice(0,10);
        const { data } = await apiGET("/conferences");
        const found = (data||[]).find(c => (c.name||"").toLowerCase()==="unknown conference");
        if(found){ confId = found.id; }
        else {
          const created = await apiPOSTJson("/conferences", {
            name: "Unknown Conference",
            start_date: today,
            end_date: today
          });
          confId = created?.data?.id || created?.id;
        }
      }
      // If missing, ensure "Unknown Vendor" exists under that conference
      if(!vendId){
        const { data } = await apiGET(`/conferences/${confId}/vendors`);
        const found = (data||[]).find(v => (v.name||"").toLowerCase()==="unknown vendor");
        if(found){ vendId = found.id; }
        else {
          const created = await apiPOSTJson("/vendors", {
            name: "Unknown Vendor",
            conference_id: confId
          });
          vendId = created?.data?.id || created?.id;
        }
      }
      // Sync select boxes for UX
      if(confId) document.getElementById('selConf').value = confId;
      if(vendId) document.getElementById('selVendor').value = vendId;

      return { conference_id: confId, vendor_id: vendId };
    }

    // ---------------------------
    // Recording controls
    // ---------------------------
    async function startSession(){
      try{
        await ensureUnknownsIfNeeded(); // create/use unknowns early
        recordedChunks=[]; sessionStartISO = new Date().toISOString();
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: pickAudioMime() });
        mediaRecorder.ondataavailable = e => { if(e.data && e.data.size>0) recordedChunks.push(e.data); };
        mediaRecorder.start();
        Log.info("Audio recording started.");
        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnStop').disabled = false;
        document.getElementById('recStatus').textContent = "Recording…";
        Log.info("Session started. Recording in progress.");
      }catch(e){
        Log.error("Could not start recording: " + (e.message||e));
        setStatus("Mic error","error");
      }
    }
    function pickAudioMime(){
      if(MediaRecorder.isTypeSupported("audio/webm;codecs=opus")) return "audio/webm;codecs=opus";
      if(MediaRecorder.isTypeSupported("audio/webm")) return "audio/webm";
      return ""; // let browser decide
    }
    async function stopAndUpload(){
      document.getElementById('btnStop').disabled = true;
      try{
        if(mediaRecorder && mediaRecorder.state!=="inactive"){
          Log.info("Stopping recorder…");
          await new Promise(res=>{
            mediaRecorder.onstop = res;
            mediaRecorder.stop();
          });
        }
        const blob = await buildAudioBlob();
        Log.info(`Audio captured: ${(blob ? (blob.size/1024/1024).toFixed(2) : "0.00")} MB`);
        const { conference_id, vendor_id } = await ensureUnknownsIfNeeded();
        await uploadSession({ conference_id, vendor_id, audioBlob: blob });
      }catch(e){
        Log.error("Upload flow failed: " + (e.message||e));
      }finally{
        document.getElementById('btnStart').disabled = false;
        document.getElementById('recStatus').textContent = "Idle.";
      }
    }
    async function buildAudioBlob(){
      const fileInput = document.getElementById('audioFile');
      if(fileInput.files && fileInput.files.length>0) return fileInput.files[0];
      if(!recordedChunks || recordedChunks.length===0) return null;
      // choose container based on first chunk type
      const type = recordedChunks[0].type || "audio/webm";
      return new Blob(recordedChunks,{ type });
    }

    // ---------------------------
    // Upload (single-step multipart)
    // ---------------------------
    async function uploadSession({ conference_id, vendor_id, audioBlob }){
      // Build multipart body exactly per API guidance.
      const fd = new FormData();
      fd.append("vendor_id", vendor_id);
      fd.append("conference_id", conference_id);
      const startISO = sessionStartISO || new Date().toISOString();
      fd.append("start_time", startISO);
      fd.append("end_time", new Date().toISOString());

      const notes = document.getElementById('notes').value || "";
      // API expects user_notes (NOT "notes")
      if(notes.trim().length>0) fd.append("user_notes", notes);

      // Audio (optional)
      if(audioBlob && audioBlob.size>0){
        // Name file with stable name + extension from mimetype if possible
        const ext = mimeToExt(audioBlob.type) || "webm";
        fd.append("audio_file", audioBlob, `session_audio.${ext}`);
      }

      // Photos (0..N)
      const pics = document.getElementById('photos').files || [];
      for(const f of pics){ fd.append("photos", f, f.name); }

      try{
        const res = await apiPOSTForm("/sessions/upload", fd);
        setStatus("Uploaded (201/200)","success");
        Log.info("Session created with media (multipart).");
        // Refresh sessions list for selected vendor
        await refreshVendorSessions();
      }catch(err){
        Log.error("Upload failed: " + (err.message||err));
        setStatus("Upload error","error");
      }
    }
    function mimeToExt(m){
      if(!m) return "";
      if(m.includes("webm")) return "webm";
      if(m.includes("ogg")) return "ogg";
      if(m.includes("wav")) return "wav";
      if(m.includes("mp3")) return "mp3";
      if(m.includes("m4a")) return "m4a";
      return "";
    }

    // ---------------------------
    // Previous Sessions viewer
    // ---------------------------
    async function refreshVendorSessions(){
      try{
        const vendId = document.getElementById('selVendor').value;
        if(!vendId){ document.getElementById('prevSessions').innerHTML = `<div class="item muted">Select a vendor to view sessions.</div>`; return; }
        const data = await apiGET(`/vendors/${vendId}`);
        const v = data?.data;
        const sessions = Array.isArray(v?.sessions)? v.sessions : [];
        const el = document.getElementById('prevSessions');
        if(sessions.length===0){
          el.innerHTML = `<div class="item muted">No sessions for this vendor yet.</div>`;
          return;
        }
        el.innerHTML = sessions.map(s => {
          return `<div class="item">
            <div><b>${escapeHtml(s.session_type||"session")}</b> — <span class="muted">${escapeHtml(s.status||"")}</span></div>
            <div class="muted">${escapeHtml(s.start_time||"")} → ${escapeHtml(s.end_time||"")}</div>
            ${s.user_notes ? `<div style="margin-top:.35rem">${escapeHtml(String(s.user_notes))}</div>`:""}
            ${Array.isArray(s.files_uploaded)&&s.files_uploaded.length? `
              <div class="muted" style="margin-top:.35rem">Files:</div>
              <ul class="muted">${s.files_uploaded.map(f=>`<li><a href="${f.url}" target="_blank" rel="noopener">${escapeHtml(f.filename||f.url)}</a></li>`).join("")}</ul>
            `:""}
            ${Array.isArray(s.photo_urls)&&s.photo_urls.length? `
              <div class="previewImgs" style="margin-top:.35rem">
                ${s.photo_urls.map(u=>`<a href="${u}" target="_blank" rel="noopener"><img src="${u}" alt="photo"/></a>`).join("")}
              </div>
            `:""}
          </div>`;
        }).join("");
      }catch(e){
        Log.error("Could not load vendor sessions: " + (e.message||e));
      }
    }

    // ---------------------------
    // Add new conference / vendor
    // ---------------------------
    async function addConferenceQuick(){
      const name = prompt("Conference name (required):","New Conference");
      if(!name) return;
      const d = new Date().toISOString().slice(0,10);
      try{
        const res = await apiPOSTJson("/conferences", { name, start_date:d, end_date:d });
        Log.info("Conference created.");
        await initData();
        document.getElementById('selConf').value = res?.data?.id || res?.id;
      }catch(e){ Log.error("Create conference failed: " + (e.message||e)) }
    }
    async function addVendorQuick(){
      const confId = document.getElementById('selConf').value;
      if(!confId){
        alert("Select a conference first (or click Start to auto-create Unknown Conference).");
        return;
      }
      const name = prompt("Vendor name (required):","New Vendor");
      if(!name) return;
      try{
        const res = await apiPOSTJson("/vendors", { name, conference_id: confId });
        Log.info("Vendor created.");
        await initData();
        document.getElementById('selVendor').value = res?.data?.id || res?.id;
      }catch(e){ Log.error("Create vendor failed: " + (e.message||e)) }
    }

    // ---------------------------
    // Self-test (CORS + basic)
    // ---------------------------
    async function selfTest(){
      try{
        await apiGET("/conferences");
        await apiGET("/vendors");
        await apiGET("/health");
        setStatus("Self-Test OK","success");
      }catch(e){
        Log.error("Self-Test failed: " + (e.message||e));
        setStatus("Self-Test failed","error");
      }
    }

    // ---------------------------
    // Utilities / UI wiring
    // ---------------------------
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])) }
    function bind(id, ev, fn){ document.getElementById(id)?.addEventListener(ev, fn) }

    // Button/controls wiring
    document.addEventListener("DOMContentLoaded", () => {
      // Fill config inputs
      document.getElementById('apiBase').value = cfg.apiBase;
      document.getElementById('apiKey').value = cfg.apiKey;

      bind("btnSaveCfg","click",saveCfg);
      bind("btnApi","click",()=>alert("Enter API Base & Key in the top bar then click Save."));
      bind("btnLogs","click",()=>document.getElementById('logs').scrollIntoView({behavior:"smooth"}));
      bind("btnSelfTest","click",selfTest);

      bind("photos","change",onPhotosChanged);

      bind("btnStart","click",startSession);
      bind("btnStop","click",stopAndUpload);

      bind("btnAddConf","click",addConferenceQuick);
      bind("btnAddVendor","click",addVendorQuick);

      bind("selConf","change", async (e)=>{
        const id = e.target.value;
        if(id){
          try{
            const data = await apiGET(`/conferences/${id}/vendors`);
            fillVendors((data && data.data)||[]);
          }catch(_){
            // fallback to list all
            const v = await apiGET("/vendors");
            fillVendors((v && v.data)||[]);
          }
        }
      });
      bind("btnRefreshVendor","click",refreshVendorSessions);

      bind("btnVerbose","click",()=>{
        Log.setVerbose(true);
        Log.info("Verbose logging ON");
      });
      bind("btnCopy","click",async ()=>{
        const txt = Log.get().map(s=>JSON.stringify(s)).join("\n");
        await navigator.clipboard.writeText(txt);
        setStatus("Logs copied","success");
      });
      bind("btnExportTxt","click",()=>{
        const url = URL.createObjectURL(Log.exportTxt());
        const a = Object.assign(document.createElement('a'),{href:url,download:"cb_logs.txt"});
        a.click(); URL.revokeObjectURL(url);
      });
      bind("btnExportJson","click",()=>{
        const url = URL.createObjectURL(Log.exportJson());
        const a = Object.assign(document.createElement('a'),{href:url,download:"cb_logs.json"});
        a.click(); URL.revokeObjectURL(url);
      });
      bind("btnClear","click",()=>Log.clear());

      // Initial data load if config present
      if(cfg.apiBase && cfg.apiKey){ initData() }
      else setStatus("Configure API","warning");
    });
  </script>
</body>
</html>
