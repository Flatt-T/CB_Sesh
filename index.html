<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1"
  />
  <title>Conference Buddy – Sessions</title>
  <style>
    :root{--bg:#0e1117;--card:#151a23;--muted:#8b98a5;--text:#e6edf3;--acc:#3aa675;--acc2:#2b90d9;--danger:#e5534b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header,section{max-width:860px;margin:0 auto;padding:16px}
    h1{font-size:1.25rem;margin:0 0 8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .card{background:var(--card);border:1px solid #222a35;border-radius:14px;padding:12px}
    label{display:block;font-size:.85rem;color:var(--muted);margin:8px 0 6px}
    select,textarea,input[type="text"],input[type="url"]{
      width:100%;border:1px solid #273143;background:#0c111a;color:var(--text);border-radius:10px;padding:10px 12px;outline:none
    }
    textarea{min-height:88px;resize:vertical}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
      background:#1b2430;color:var(--text);border:1px solid #2a3341;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn.primary{background:var(--acc);border-color:#2f8f63;color:#06130d}
    .btn.alt{background:var(--acc2);border-color:#1d6fa8}
    .btn.danger{background:var(--danger);border-color:#c63f39}
    .stack{display:flex;flex-wrap:wrap;gap:8px}
    .pill{border:1px dashed #2b3646;border-radius:999px;padding:8px 12px;font-size:.85rem;color:var(--muted)}
    .small{font-size:.8rem;color:var(--muted)}
    pre{white-space:pre-wrap;word-break:break-word;background:#0c111a;border:1px solid #273143;border-radius:10px;padding:10px;max-height:280px;overflow:auto}
    .ok{color:#6ee7a5}.warn{color:#facc15}.err{color:#fca5a5}
    .grid{display:grid;gap:12px}
    .stretch{width:100%}
    input[type="file"]{width:100%}
    .divider{height:1px;background:#223045;margin:10px 0}
    .kpi{display:flex;gap:12px;flex-wrap:wrap}
    .kpi span{background:#0c111a;border:1px solid #273143;border-radius:10px;padding:6px 10px}
    @media (max-width:720px){.row,.row-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>Conference Buddy — Session Uploader</h1>
    <div class="kpi">
      <span>Two-step flow</span>
      <span>Multi-image</span>
      <span>Mobile audio (file)</span>
      <span>Enrichment trigger</span>
    </div>
  </header>

  <section class="card grid">

    <div class="row">
      <div>
        <label>API Base URL</label>
        <input id="apiBase" type="url" placeholder="https://conference-buddy-geoutils.replit.app/api" />
      </div>
      <div>
        <label>API Key</label>
        <input id="apiKey" type="text" placeholder="•••" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Conference</label>
        <select id="conferenceSelect"></select>
        <div class="stack" style="margin-top:6px">
          <button class="btn alt" id="btnRefreshConfs">Refresh</button>
          <button class="btn" id="btnConfsForVendor">Load Conf’s Vendors</button>
        </div>
      </div>
      <div>
        <label>Vendor</label>
        <select id="vendorSelect"></select>
        <div class="stack" style="margin-top:6px">
          <button class="btn alt" id="btnRefreshVendors">Refresh</button>
          <button class="btn" id="btnVendorDetails">View</button>
        </div>
      </div>
    </div>

    <div>
      <label>Notes</label>
      <textarea id="notes" placeholder="Quick notes…"></textarea>
    </div>

    <div class="row">
      <div class="card">
        <label>Photos (multiple)</label>
        <input id="photos" type="file" accept="image/*" multiple capture="environment" />
        <div class="small">You can add more photos before uploading.</div>
      </div>
      <div class="card">
        <label>Audio (m4a, aac, wav, mp3, ogg)</label>
        <input id="audio" type="file" accept="audio/*,.m4a,.aac,.wav,.mp3,.ogg" capture />
        <div class="small">Use your phone’s recorder, then attach here for best compatibility.</div>
      </div>
    </div>

    <div class="stack">
      <button class="btn primary" id="btnStart">Start Session</button>
      <button class="btn" id="btnStop" disabled>Stop Session</button>
      <button class="btn alt" id="btnUpload" disabled>Upload Files</button>
      <button class="btn" id="btnCheck" disabled>Check Progress</button>
    </div>

    <div>
      <div class="divider"></div>
      <div class="small">Status</div>
      <div id="status" class="pill">idle</div>
    </div>

    <div>
      <div class="divider"></div>
      <div class="small">Logs</div>
      <pre id="logs"></pre>
      <div class="stack">
        <button class="btn" id="btnCopy">Copy</button>
        <button class="btn danger" id="btnClearLog">Clear</button>
      </div>
    </div>

    <div>
      <div class="divider"></div>
      <div class="small">Previous Sessions</div>
      <div class="stack">
        <button class="btn" id="btnRefreshSessions">Refresh</button>
      </div>
      <div id="sessionsList" class="grid"></div>
    </div>

  </section>

  <script>
    // -------- Small utility logger ----------
    const $ = (id) => document.getElementById(id);
    const logsEl = $("logs");
    function log(level, msg, obj) {
      const t = new Date().toISOString();
      const line = { t, level, msg, extra: obj ?? "" };
      const color = level === "error" ? "err" : level === "warn" ? "warn" : "ok";
      logsEl.textContent += JSON.stringify(line) + "\n";
      logsEl.scrollTop = logsEl.scrollHeight;
      console[level === "error" ? "error" : level === "warn" ? "warn" : "log"](line);
      $("status").textContent = msg;
      $("status").className = "pill " + (color);
    }
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // -------- Config (persist in localStorage) ----------
    const cfg = {
      get base(){ return localStorage.getItem("cb_api_base") || ""; },
      set base(v){ localStorage.setItem("cb_api_base", v || ""); },
      get key(){ return localStorage.getItem("cb_api_key") || ""; },
      set key(v){ localStorage.setItem("cb_api_key", v || ""); },
    };
    $("apiBase").value = cfg.base || "https://conference-buddy-geoutils.replit.app/api";
    $("apiKey").value = cfg.key || "";
    function updateConfig(){
      cfg.base = $("apiBase").value.trim().replace(/\/+$/,"");
      cfg.key = $("apiKey").value.trim();
      log("info","Config updated.");
    }
    $("apiBase").addEventListener("change", updateConfig);
    $("apiKey").addEventListener("change", updateConfig);

    // -------- API core ----------
    async function apiFetch(path, { method="GET", headers={}, json, formData, expect="json" } = {}){
      const url = (cfg.base || "").replace(/\/+$/,"") + path;
      const h = { "X-API-Key": cfg.key, ...headers };
      let body = undefined;

      // NEVER set Content-Type for FormData; browser will set the multipart boundary.
      if (json !== undefined) {
        h["Content-Type"] = "application/json";
        body = JSON.stringify(json);
      } else if (formData instanceof FormData) {
        body = formData;
      }

      log("info", `HTTP ${method} ${url}`, "→ request");
      log("info", JSON.stringify({ id: Math.random().toString(36).slice(2), method, url, reqHeaders: h }), "");

      const res = await fetch(url, { method, headers: h, body });
      let payload;
      try { payload = await res.json(); }
      catch { payload = await res.text(); }

      log("info", `HTTP ${method} ${url}`, `← ${res.status} ${res.statusText || ""}`);
      log("info", JSON.stringify({
        status: res.status, resHeaders: Object.fromEntries(res.headers.entries()),
        body: typeof payload === "string" ? payload : JSON.stringify(payload)
      }), "");

      if (!res.ok) {
        const err = new Error(payload && payload.error ? payload.error : `${res.status}`);
        err.response = payload;
        throw err;
      }
      return payload;
    }

    // -------- UI state ----------
    let currentSession = null; // {id, start}
    let lastCreatedAt = null;

    // -------- Populate dropdowns ----------
    async function loadConferences(){
      const data = await apiFetch("/conferences");
      const sel = $("conferenceSelect");
      sel.innerHTML = "";
      for (const c of (data.data || [])) {
        const o = document.createElement("option");
        o.value = c.id; o.textContent = c.name || "(Unnamed)";
        sel.appendChild(o);
      }
      log("info","Conferences loaded.");
    }
    async function loadVendors(){
      const data = await apiFetch("/vendors");
      const sel = $("vendorSelect");
      sel.innerHTML = "";
      for (const v of (data.data || [])) {
        const o = document.createElement("option");
        o.value = v.id; o.textContent = v.name || "(Unnamed)";
        sel.appendChild(o);
      }
      log("info","Vendors loaded.");
    }
    async function loadVendorsForSelectedConference() {
      const confId = $("conferenceSelect").value;
      if (!confId) return;
      const data = await apiFetch(`/conferences/${confId}/vendors`);
      const sel = $("vendorSelect");
      sel.innerHTML = "";
      for (const v of (data.data || [])) {
        const o = document.createElement("option");
        o.value = v.id; o.textContent = v.name || "(Unnamed)";
        sel.appendChild(o);
      }
      log("info","Vendors for conference loaded.");
    }
    async function vendorDetails(){
      const id = $("vendorSelect").value;
      if (!id) return;
      await apiFetch(`/vendors/${id}`);
    }

    // -------- Sessions list ----------
    async function listSessions(){
      const vendorId = $("vendorSelect").value;
      if (!vendorId) { $("sessionsList").innerHTML = "<div class='small'>Select a vendor.</div>"; return; }
      const vendor = await apiFetch(`/vendors/${vendorId}`);
      const sessions = (vendor.data && vendor.data.sessions) || [];
      const wrap = document.createElement("div");
      for (const s of sessions) {
        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div><b>${(vendor.data && vendor.data.name) || "Vendor"}</b> — <span class="small">${s.processing_status || "n/a"}</span></div>
          <div class="small">Start: ${s.start_time || "?"}</div>
          <div class="small">Id: ${s.id}</div>
          <div class="stack" style="margin-top:8px">
            <button class="btn" data-view="${s.id}">View</button>
            <button class="btn alt" data-check="${s.id}">Check</button>
          </div>`;
        wrap.appendChild(el);
      }
      $("sessionsList").innerHTML = "";
      $("sessionsList").appendChild(wrap);
      $("sessionsList").querySelectorAll("[data-view]").forEach(b=>{
        b.onclick = ()=> apiFetch(`/sessions/${b.dataset.view}`).catch(e=>log("error","View failed",e.message));
      });
      $("sessionsList").querySelectorAll("[data-check]").forEach(b=>{
        b.onclick = ()=> checkProgress(b.dataset.check);
      });
    }

    // -------- Two-step flow ----------
    // 1) Create
    async function startSession(){
      updateConfig();
      const conference_id = $("conferenceSelect").value;
      const vendor_id = $("vendorSelect").value;
      if (!cfg.base || !cfg.key) return log("error","API base/key required.");
      if (!conference_id || !vendor_id) return log("warn","Pick a conference and vendor first.");
      const start_time = new Date().toISOString();

      const body = { vendor_id, conference_id, start_time };
      // Prefer the documented mobile create endpoint for two-step flows
      const created = await apiFetch("/mobile/sessions/create", { method:"POST", json: body });
      const sid = created.session_id || created.id || (created.data && created.data.id);
      if (!sid) throw new Error("Create did not return session_id");
      currentSession = { id: sid, start: start_time };
      lastCreatedAt = Date.now();

      $("btnStart").disabled = true;
      $("btnStop").disabled = false;
      $("btnUpload").disabled = false;
      $("btnCheck").disabled = false;

      log("info", `Session created: ${sid}`);
    }

    // 2) Stop (sets end time only client-side; server gets it during upload)
    function stopSession(){
      if (!currentSession) return log("warn","No active session.");
      $("btnStop").disabled = true;
      log("info","Session stopped. Ready to upload files.");
    }

    // 3) Upload files to existing session
    async function uploadFiles(){
      if (!currentSession) return log("warn","Start a session first.");
      const sid = currentSession.id;
      const end_time = new Date().toISOString();

      const fd = new FormData();
      // Add images — use the "image_files" array name required by /add-files
      const photos = $("photos").files;
      for (let i=0;i<photos.length;i++) fd.append("image_files", photos[i], photos[i].name);

      // Add audio — use "audio_files" array name
      const audio = $("audio").files[0];
      if (audio) {
        // Server accepts: mp3, wav, m4a, aac, ogg
        const okTypes = ["audio/mpeg","audio/wav","audio/x-wav","audio/aac","audio/x-aac","audio/mp4","audio/x-m4a","audio/ogg"];
        if (!okTypes.includes(audio.type)) {
          log("warn", `Audio type ${audio.type || "(unknown)"} may be rejected. Proceeding anyway…`);
        }
        fd.append("audio_files", audio, audio.name);
      }

      // Notes – /add-files expects `notes`; we also include `user_notes` for safety
      const userNotes = $("notes").value || "";
      if (userNotes) {
        fd.append("notes", userNotes);
        fd.append("user_notes", userNotes);
      }
      // Timing
      fd.append("end_time", end_time);

      // IMPORTANT: Do not manually set Content-Type for FormData
      const res = await apiFetch(`/sessions/${encodeURIComponent(sid)}/add-files`, {
        method: "POST",
        formData: fd
      });

      log("info", `Files uploaded to ${sid}.`);

      // Fire enrichment if available
      try {
        await triggerEnrichment(sid);
      } catch(e) {
        log("warn", "Enrichment trigger not available on this server.");
      }

      // Clear notes & inputs after upload completes
      $("notes").value = "";
      $("photos").value = "";
      $("audio").value = "";
      log("info","Inputs cleared (notes, photos, audio).");

      // Refresh vendor sessions & poll progress briefly
      await listSessions();
      await pollProgress(sid, 5);
    }

    async function triggerEnrichment(sessionId){
      // Try the documented/typical route first
      try {
        await apiFetch(`/sessions/${encodeURIComponent(sessionId)}/trigger-enrichment`, {
          method:"POST", json: {}
        });
        log("info","Enrichment triggered.");
        return;
      } catch (e) {
        // Some backends may expose a mobile namespaced endpoint
        log("warn","Primary enrichment route failed, trying mobile variant…");
      }
      await apiFetch(`/mobile/sessions/${encodeURIComponent(sessionId)}/trigger-enrichment`, {
        method:"POST", json: {}
      });
      log("info","Enrichment triggered (mobile route).");
    }

    // 4) Progress check/poll
    async function checkProgress(sessionId){
      const sid = sessionId || (currentSession && currentSession.id);
      if (!sid) return log("warn","No session id.");
      await apiFetch(`/sessions/${encodeURIComponent(sid)}`);
    }
    async function pollProgress(sessionId, attempts=5){
      for (let i=0;i<attempts;i++){
        await sleep(1200);
        try {
          const s = await apiFetch(`/sessions/${encodeURIComponent(sessionId)}`);
          const p = s && (s.data || s);
          const stage = (p.processing_status || p.status || "n/a");
          log("info", `Progress: ${stage}`);
          if (stage === "transcribed" || stage === "completed" || stage === "enriched") break;
        } catch(e) {
          log("warn","Progress check error.");
          break;
        }
      }
    }

    // -------- Buttons ----------
    $("btnStart").onclick = () => startSession().catch(e=>log("error","Create failed", e.response?.error || e.message));
    $("btnStop").onclick = () => stopSession();
    $("btnUpload").onclick = () => uploadFiles().catch(e=>{
      const details = typeof e.response === "string" ? e.response : (e.response?.details || "");
      log("error","Upload failed", (e.response?.error || e.message) + (details ? ` — ${details}` : ""));
    });
    $("btnCheck").onclick = () => checkProgress().catch(e=>log("error","Check failed", e.response?.error || e.message));

    $("btnRefreshConfs").onclick = () => loadConferences().catch(e=>log("error","Load conferences failed", e.message));
    $("btnRefreshVendors").onclick = () => loadVendors().catch(e=>log("error","Load vendors failed", e.message));
    $("btnConfsForVendor").onclick = () => loadVendorsForSelectedConference().catch(e=>log("error","Load conf vendors failed", e.message));
    $("btnVendorDetails").onclick = () => vendorDetails().catch(e=>log("error","Vendor details failed", e.message));

    $("btnRefreshSessions").onclick = () => listSessions().catch(e=>log("error","List sessions failed", e.message));

    $("btnCopy").onclick = async () => {
      try { await navigator.clipboard.writeText(logsEl.textContent); log("info","Logs copied."); }
      catch { log("error","Copy failed."); }
    };
    $("btnClearLog").onclick = () => { logsEl.textContent = ""; log("info","Logs cleared."); };

    // -------- Initial load ----------
    (async function init(){
      try{
        updateConfig();
        if (!cfg.base) log("error","API base URL not configured.");
        await loadConferences();
        await loadVendors();
        log("info","Dropdowns populated from API.");
      }catch(e){
        log("error","Initial load failed", e.message);
      }
    })();
  </script>
</body>
</html>
